/**
 * ETF Simulator - Optimizer Web Worker
 * Bundled: 2025-12-08T16:40:30.108Z
 * Source: src/optimizer-worker-entry.js
 */
(()=>{var Ht={aktien:.7,misch:.85,renten:1},ge=1e3;var jt=.08,Qt=.09,D=12,ye=100,_e={2025:2.53,2024:2.29,2023:2.55,2022:-.05,2021:-.45,2020:.07,2019:.52,2018:.87};function Re(t,a=2.53){return _e[t]!==void 0?_e[t]:a}var Ee={none:{name:"Standard (Zuf\xE4llig)",description:"Normale Monte-Carlo-Simulation mit zuf\xE4lligen Renditen",returns:null},early_crash:{name:"Fr\xFCher Crash",description:"-30% im 1. Rentenjahr, langsame Erholung \xFCber 5 Jahre",returns:[-.3,-.1,.05,.08,.1,.12,.08,.07,.06,.06]},sideways:{name:"Seitw\xE4rtsmarkt",description:"0% Realrendite \xFCber 10 Jahre",returns:[.02,.01,-.01,.02,0,-.02,.03,-.01,.01,0]},bear_market:{name:"B\xE4renmarkt-Phase",description:"3-5 Jahre leicht negative Renditen, danach normal",returns:[-.05,-.08,-.03,-.02,.02,.08,.1,.07,.06,.06]},late_crash:{name:"Sp\xE4ter Crash",description:"Normaler Start, Crash nach 5 Jahren",returns:[.08,.1,.07,.09,.06,-.35,-.15,.1,.12,.08]}};var ne=Math.random;function xe(t){ne=t}function te(t){return Math.pow(1+t/100,1/D)-1}function Ve(t){return t/Math.sqrt(12)}function ze(t=0){let a=.25*(1+.055);return t===0?a:t===jt?.27818:t===Qt?.27995:a+.25*t}function Ue(t=0,a=1){let e,s;do e=ne(),s=ne();while(e===0);return Math.sqrt(-2*Math.log(e))*Math.cos(2*Math.PI*s)*a+t}function be(t){let a=t;return function(){a|=0,a=a+1831565813|0;let e=Math.imul(a^a>>>15,1|a);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}function _(t,a){if(t.length===0)return 0;let e=a/100*(t.length-1),s=Math.floor(e),o=Math.ceil(e);return s===o?t[s]:t[s]*(o-e)+t[o]*(e-s)}function qe(t,a=.01){if(t.length<=1)return t;let e=new Map;for(let s of t){if(s.amount<=0)continue;let c=(Math.round(s.price/a)*a).toFixed(4);if(e.has(c)){let p=e.get(c),r=p.amount+s.amount,m=(p.price*p.amount+s.price*s.amount)/r;p.amount=r,p.price=m,p.monthIdx=Math.min(p.monthIdx,s.monthIdx)}else e.set(c,{...s})}return Array.from(e.values()).sort((s,o)=>s.monthIdx-o.monthIdx)}function ae(t,a,e,s,o,c,p=0,r=!0,m=.7){let y=0,u=s,i=p,f=0,S=0;for(;t>.01&&a.length;){let M=r?0:a.length-1,g=a[M],P=e-g.price,W=Math.max(0,o-u),A;if(P>0){let C=P*m,V=Math.min(C>0?i/C:Number.POSITIVE_INFINITY,g.amount),$=Math.min(C>0?W/C:Number.POSITIVE_INFINITY,g.amount-V),h=V+$,R=t/e;if(R<=h)A=R;else{let lt=h*e,Z=t-lt,Q=C*c,it=e-Q;if(it<=0)break;let et=Z/it;A=h+et}}else A=t/e;let O=Math.min(A,g.amount);f+=O*e;let U=O*P*m;S+=U;let B=0;if(U>0){let C=Math.min(U,i);i-=C;let V=U-C,$=Math.max(0,o-u),h=Math.min(V,$);u+=h,B=(V-h)*c}else U<0&&(i+=Math.abs(U));let X=O*e-B;t-=X,y+=B,A>=g.amount?r?a.shift():a.pop():g.amount-=O}return{remaining:t,taxPaid:y,yearlyUsedFreibetrag:u,lossPot:i,grossProceeds:f,taxableGainTotal:S}}function $e(t,a,e,s,o,c,p=0,r=!0,m=.7){let y=0,u=s,i=p,f=t,S=0;for(;f>.01&&a.length;){let g=r?0:a.length-1,P=a[g],W=e-P.price,A=f/e,O=Math.min(A,P.amount),K=O*e,B=O*W*m,X=0;if(B>0){let V=Math.min(B,i);i-=V;let $=B-V,h=Math.max(0,o-u),R=Math.min($,h);u+=R,X=($-R)*c}else B<0&&(i+=Math.abs(B));let C=K-X;S+=C,y+=X,f-=K,A>=P.amount?r?a.shift():a.pop():P.amount-=O}let M=f>.01?f:0;return{netProceeds:S,taxPaid:y,yearlyUsedFreibetrag:u,lossPot:i,shortfall:M}}function ee(t,a,e,s,o,c,p,r=0,m=!0,y=.7){if(t<=0)return{savings:a,yearlyUsedFreibetrag:o,lossPot:r,taxPaidOriginal:0,saleTax:0,totalTaxRecorded:0,shortfall:0};let u=t,i=r,f=Math.min(a,u);a-=f,u-=f;let S=0;if(u>.01&&e.length){let W=ae(u,e,s,o,c,p,i,m,y);u=W.remaining,S=W.taxPaid,o=W.yearlyUsedFreibetrag,i=W.lossPot}u=Math.max(0,u);let M=t-u,g=u>.01?u:0,P=M+S;return{savings:a,yearlyUsedFreibetrag:o,lossPot:i,taxPaidOriginal:M,saleTax:S,totalTaxRecorded:P,shortfall:g}}function De(t,a,e,s){let o=Ee[t];if(!o||!o.returns)return null;let c=a-e;if(c<=0)return null;let p=Math.floor((c-1)/12);if(p<o.returns.length){let r=o.returns[p];return Math.pow(1+r,1/12)}return null}function Me(t,a=0,e={}){let{start_savings:s,start_etf:o,start_etf_cost_basis:c=0,monthly_savings:p,monthly_etf:r,savings_rate_pa:m,etf_rate_pa:y,etf_ter_pa:u=0,savings_target:i,annual_raise_percent:f,savings_years:S,withdrawal_years:M,monthly_payout_net:g,monthly_payout_percent:P,withdrawal_min:W=0,withdrawal_max:A=0,inflation_adjust_withdrawal:O=!0,special_payout_net_savings:K,special_interval_years_savings:U,inflation_adjust_special_savings:B=!0,special_payout_net_withdrawal:X,special_interval_years_withdrawal:C,inflation_adjust_special_withdrawal:V=!0,inflation_rate_pa:$=0,sparerpauschbetrag:h=ge,kirchensteuer:R="keine",basiszins:lt=2.53,use_lifo:Z=!1,rent_is_gross:Q=!1,capital_preservation_enabled:it=!1,capital_preservation_threshold:et=80,capital_preservation_reduction:ut=25,capital_preservation_recovery:ft=10,loss_pot:At=0,fondstyp:ct="aktien"}=t,{stressScenario:nt="none",startYear:Vt=new Date().getFullYear()}=e,Mt=a>0,zt=nt&&nt!=="none",n=Mt?Ve(a/100):0,l=Ht[ct]||Ht.aktien,b=0;R==="8"?b=jt:R==="9"&&(b=Qt);let v=ze(b),J=[],x=s,F=ye,N=[];if(o>0){let L=o/F,ht=(c>0?c:o)/L;N.push({amount:L,price:ht,monthIdx:0})}let Ut=y-u,Nt=te(m),mt=te(Ut),Wt=te($),wt=f/100,Rt=(S+M)*D,Ct=S*D,w=x>=i,G=0,yt=0,Et=!1,st=g,St=P,_t=null,Yt=null,vt=1,qt=!1,ie=0,Ae=o,$t=F,ce=0,Y=At,Tt=0,Ne=0,gt=0;for(let L=1;L<=Rt;L+=1){let dt=L<=Ct,ht=Math.floor((L-1)/D),Pt=(L-1)%D+1,Dt=0,kt=0,ot=0;vt*=1+Wt;let xt=N.reduce((I,k)=>I+k.amount,0)*F,z=x+xt;if(ht!==yt){if(G=0,ce=0,gt>0){let I=Math.min(gt,Y);Y-=I;let k=gt-I,tt=Math.min(k,h);G=tt;let T=Math.max(0,k-tt)*v,E=ee(T,x,N,F,G,h,v,Y,!Z,l);x=E.savings,G=E.yearlyUsedFreibetrag,Y=E.lossPot,Dt=E.taxPaidOriginal,ce=E.taxPaidOriginal,kt+=E.totalTaxRecorded,ot+=E.shortfall}yt=ht,Ae=xt,$t=F,Tt=0,Ne=0,gt=0}let at,Ot=zt?De(nt,L,Ct,mt):null;if(Ot!==null)at=Ot,F*=at;else if(Mt){let k=Math.log(1+mt)-.5*n*n,j=Ue(0,1);at=Math.exp(k+n*j),F*=at}else at=1+mt,F*=at;let Ce=xt*(at-1),Gt=x*Nt,Kt=0;Tt+=Gt,x+=Gt;let he=0,bt=0,ue=0,H=0,It=kt,pt=0,Ft=0,Lt=0,de=!1,Bt=0;if(dt){let I=Math.pow(1+wt,ht),k=p*I,j=r*I;if(w?bt=j+k:(x+=k,he=k,bt=j),x>i&&(ue=x-i,x=i,bt+=ue,w=!0),bt>0){let d=bt/F;N.push({amount:d,price:F,monthIdx:L})}if(U>0&&L%(U*D)===0&&L>0){let d=K;if(B){let rt=L/D;d=K*Math.pow(1+$/100,rt)}let T=d;H=T;let E=Math.max(0,x-i);if(E>0){let rt=Math.min(E,T);x-=rt,T-=rt}let q=ae(T,N,F,G,h,v,Y,!Z,l);if(T=q.remaining,It+=q.taxPaid,G=q.yearlyUsedFreibetrag,Y=q.lossPot,T>.01){let rt=Math.min(x,T);x-=rt,T-=rt,x<i&&(w=!1)}T<0&&(x+=Math.abs(T),T=0),pt=H-Math.max(0,T)}}else{if(_t===null){let d=N.reduce((T,E)=>T+E.amount,0);_t=x+d*F,P!=null&&!Et?(st=_t*(P/100)/12,Yt=st,Et=!0,St=P):st!=null&&(Yt=st,St=_t>0?st*12/_t*100:0)}let I=st||0;if(O&&Yt!=null){let d=ht-S;I=Yt*Math.pow(1+$/100,d)}if(W>0&&I<W&&(I=W),A>0&&I>A&&(I=A),it&&_t>0){let d=N.reduce((rt,Zt)=>rt+Zt.amount,0),T=x+d*F,E=_t*(et/100),q=_t*((et+ft)/100);T<E?qt=!0:T>=q&&(qt=!1),qt&&(I=I*(1-ut/100),de=!0,ie++)}let k=I,j=0,tt=I;if(C>0&&L%(C*D)===0){if(j=X,V){let d=L/D;j=X*Math.pow(1+$/100,d)}tt+=j}if(tt>0){let d=tt;H=tt;let T=Math.max(0,x-i);if(T>0){let E=Math.min(T,d);x-=E,d-=E,Q&&(Bt+=E)}if(Q&&d>0){let E=$e(d,N,F,G,h,v,Y,!Z,l),q=E.netProceeds;It+=E.taxPaid,G=E.yearlyUsedFreibetrag,Y=E.lossPot,d=E.shortfall,pt=H-d,Bt+=q}else if(d>0){let E=ae(d,N,F,G,h,v,Y,!Z,l);d=E.remaining,It+=E.taxPaid,G=E.yearlyUsedFreibetrag,Y=E.lossPot}if(d>.01){let E=Math.min(x,d);x-=E,d-=E,Q&&(Bt+=E)}d<0&&(x+=Math.abs(d),d=0),Q||(pt=H-Math.max(0,d))}if(H>0&&pt<H){let d=pt/H;Lt=k*d}else Lt=k}let Xt=0;if(Pt===12){if(Tt>0){let j=Math.min(Tt,Y);Y-=j;let tt=Tt-j,d=Math.max(0,h-G),T=Math.min(tt,d);if(G+=T,Kt=Math.max(0,tt-T)*v,Kt>.01){let q=ee(Kt,x,N,F,G,h,v,Y,!Z,l);x=q.savings,G=q.yearlyUsedFreibetrag,Y=q.lossPot,It+=q.totalTaxRecorded,ot+=q.shortfall}}let I=Vt+ht,k=Re(I,lt);if(k>0){let j=ht*D,tt=.7;for(let d of N){if(d.amount<=0)continue;let T=d.monthIdx>j,E=T?d.amount*d.price:d.amount*$t,q=1;T&&(q=(12-((d.monthIdx-1)%D+1)+1)/12);let rt=E*(k/100)*tt*q,Zt=d.amount*F,Ge=T?d.amount*d.price:d.amount*$t,Le=Math.max(0,Zt-Ge),Jt=Math.min(rt,Le);Jt>0&&(Xt+=Jt,d.price+=Jt/d.amount)}Xt>0&&(gt=Xt*l)}}if(Pt===12&&N.length>50){let I=qe(N);N.length=0,N.push(...I)}let pe=N.reduce((I,k)=>I+k.amount,0)*F,fe=x+pe,Ye=dt?null:H>0?H:null,ke=H>0?Math.max(0,H-pt):0;!dt&&H>0?Q?Ft=Bt:Ft=pt:Ft=0;let Oe=1+Nt,me=at;if(z>0){let I=xt/z,k=1-I;me=I*at+k*Oe}J.push({month:L,year:ht+1,phase:dt?"Anspar":"Entnahme",savings:x,etf:pe,total:fe,total_real:fe/vt,savings_contrib:he,etf_contrib:bt,savings_interest:Gt,withdrawal:pt,withdrawal_real:pt/vt,withdrawal_net:Ft,withdrawal_net_real:Ft/vt,withdrawal_requested:H,shortfall:ke,tax_shortfall:ot,monthly_payout:Lt,monthly_payout_real:Lt/vt,tax_paid:It,vorabpauschale_tax:Dt,payout_value:Ye,payout_percent_pa:dt?null:St,return_gain:Ce+Gt,etfReturn:at,portfolioReturn:me,cumulative_inflation:vt,capital_preservation_active:de||!1,yearly_used_freibetrag:G,loss_pot:Y})}if(gt>0&&J.length>0){let L=Math.min(gt,Y);Y-=L;let dt=gt-L,Pt=Math.min(dt,h),kt=Math.max(0,dt-Pt)*v,ot=ee(kt,x,N,F,Pt,h,v,Y,!Z,l);x=ot.savings,Y=ot.lossPot;let xt=N.reduce((at,Ot)=>at+Ot.amount,0)*F,z=J[J.length-1];z.savings=x,z.etf=xt,z.total=z.savings+z.etf,z.total_real=z.total/z.cumulative_inflation,z.tax_paid+=ot.totalTaxRecorded,z.vorabpauschale_tax=(z.vorabpauschale_tax||0)+ot.taxPaidOriginal,z.pending_vorabpauschale_tax=ot.taxPaidOriginal,z.loss_pot=Y,ot.shortfall>.01&&(z.tax_shortfall=(z.tax_shortfall||0)+ot.shortfall),x<0&&(x=0)}return J.length>0&&(J.capitalPreservationMonths=ie,J.capitalPreservationEnabled=it),J}function we(t,a,e={}){let s=t[0]?.length||0,o=t.length,c=a.savings_years*D,p=a.savings_target??0,r=a.monthly_payout_net||0,m=r>0?r*12:100,y=e.successThreshold??m,u=(e.ruinThresholdPercent??10)/100,i=t.map(n=>n[n.length-1]?.total||0).sort((n,l)=>n-l),f=t.map(n=>n[n.length-1]?.total_real||0).sort((n,l)=>n-l),S=t.map(n=>n[n.length-1]?.loss_pot||0).sort((n,l)=>n-l),M=t.map(n=>n[n.length-1]?.yearly_used_freibetrag||0).sort((n,l)=>n-l),g=Math.min(c-1,s-1),P=t.map(n=>n[g]?.total||0).sort((n,l)=>n-l),W=t.map(n=>n[g]?.total_real||0).sort((n,l)=>n-l),A=[],O=[],K=[],U=[],B=[],X=[],C=[],V=[];for(let n of t){let l=n.filter(b=>b.phase==="Entnahme"&&((b.withdrawal||0)>0||(b.withdrawal_net||0)>0));l.length>0&&(K.push(l.reduce((b,v)=>b+(v.withdrawal||0),0)/l.length),U.push(l.reduce((b,v)=>b+(v.withdrawal_real||0),0)/l.length),A.push(l.reduce((b,v)=>b+(v.withdrawal_net||0),0)/l.length),O.push(l.reduce((b,v)=>b+(v.withdrawal_net_real||0),0)/l.length),C.push(n.reduce((b,v)=>b+(v.withdrawal||0),0)),V.push(n.reduce((b,v)=>b+(v.withdrawal_real||0),0)),B.push(n.reduce((b,v)=>b+(v.withdrawal_net||0),0)),X.push(n.reduce((b,v)=>b+(v.withdrawal_net_real||0),0)))}A.sort((n,l)=>n-l),O.sort((n,l)=>n-l),K.sort((n,l)=>n-l),U.sort((n,l)=>n-l),B.sort((n,l)=>n-l),X.sort((n,l)=>n-l),C.sort((n,l)=>n-l),V.sort((n,l)=>n-l);let $=0,h=0,R=0,lt=0,Z=0,Q=0,it=0,et=[],ut=.01,ft=50;for(let n of t){let l=n[n.length-1],b=l?.total||0,v=l?.cumulative_inflation||1,J=y*v,x=b>J,F=n[g],N=F?.total||0,Ut=F?.total_real||0,Nt=l?.total_real||0,mt=null;if(p<=0)mt=0;else for(let w=0;w<s&&w<n.length;w++)if((n[w]?.savings||0)>=p){mt=n[w]?.month??w+1;break}mt!==null&&et.push(mt/12);let Wt=!1,wt=!1;for(let w=0;w<c&&w<s&&w<n.length;w++)if((n[w]?.shortfall||0)>ft||(n[w]?.tax_shortfall||0)>ft){Wt=!0;break}for(let w=c;w<s&&w<n.length;w++){let G=n[w]?.withdrawal_requested||0,yt=n[w]?.shortfall||0,Et=n[w]?.tax_shortfall||0,st=Math.max(ft,G*ut);if(yt>st||Et>st){wt=!0;break}}Wt&&Q++,wt&&it++;let Rt=!1,Ct=N*u;for(let w=c;w<s&&w<n.length;w++){let G=n[w]?.withdrawal_requested||0,yt=Math.max(ft,G*ut),Et=n[w]?.shortfall||0,st=n[w]?.tax_shortfall||0,St=Et>yt||st>yt;if((n[w]?.total||0)<Ct||St){Rt=!0;break}}Rt&&R++,x&&!wt&&!Rt&&$++,x&&!Rt&&h++,b>=N&&lt++,Nt>=Ut&&Z++}let At=[],ct={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]},nt={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]};for(let n=0;n<s;n++){At.push(n+1);let l=t.map(v=>v[n]?.total||0).sort((v,J)=>v-J),b=t.map(v=>v[n]?.total_real||0).sort((v,J)=>v-J);ct.p5.push(_(l,5)),ct.p10.push(_(l,10)),ct.p25.push(_(l,25)),ct.p50.push(_(l,50)),ct.p75.push(_(l,75)),ct.p90.push(_(l,90)),ct.p95.push(_(l,95)),nt.p5.push(_(b,5)),nt.p10.push(_(b,10)),nt.p25.push(_(b,25)),nt.p50.push(_(b,50)),nt.p75.push(_(b,75)),nt.p90.push(_(b,90)),nt.p95.push(_(b,95))}let Vt=Ke(t,a);et.sort((n,l)=>n-l);let Mt=et.length/o*100,zt=et.length>0?_(et,50):null;return{iterations:o,months:At,percentiles:ct,percentilesReal:nt,savingsYears:a.savings_years,medianEnd:_(i,50),meanEnd:i.reduce((n,l)=>n+l,0)/o,p5End:_(i,5),p10End:_(i,10),p25End:_(i,25),p75End:_(i,75),p90End:_(i,90),p95End:_(i,95),medianEndReal:_(f,50),meanEndReal:f.reduce((n,l)=>n+l,0)/o,p5EndReal:_(f,5),p10EndReal:_(f,10),p25EndReal:_(f,25),p75EndReal:_(f,75),p90EndReal:_(f,90),p95EndReal:_(f,95),retirementMedian:_(P,50),retirementMedianReal:_(W,50),medianAvgWithdrawalNet:A.length>0?_(A,50):0,medianAvgWithdrawalNetReal:O.length>0?_(O,50):0,medianAvgWithdrawalGross:K.length>0?_(K,50):0,medianAvgWithdrawalGrossReal:U.length>0?_(U,50):0,medianTotalWithdrawalNet:B.length>0?_(B,50):0,medianTotalWithdrawalNetReal:X.length>0?_(X,50):0,medianTotalWithdrawalGross:C.length>0?_(C,50):0,medianTotalWithdrawalGrossReal:V.length>0?_(V,50):0,successRate:$/o*100,softSuccessRate:h/o*100,ruinProbability:R/o*100,capitalPreservationRate:lt/o*100,capitalPreservationRateReal:Z/o*100,ansparShortfallRate:Q/o*100,entnahmeShortfallRate:it/o*100,emergencyFillProbability:Mt,emergencyNeverFillProbability:100-Mt,emergencyMedianFillYears:zt,medianFinalLossPot:_(S,50),medianFinalYearlyFreibetrag:_(M,50),sorr:Vt,mcOptions:e}}function Ke(t,a){let e=t.length,s=a.savings_years*D,o=(a.savings_years+a.withdrawal_years)*D,c=Math.min(5,a.withdrawal_years),p=c*12,r=[];for(let h of t){if(h.length<s)continue;let R=h[s-1]?.total||h[s]?.total||0;if(R<=0)continue;let lt=1,Z=Math.min(s+p-1,o-1,h.length-1);for(let ut=s;ut<=Z;ut++){let ft=h[ut]?.portfolioReturn||h[ut]?.etfReturn||1;lt*=ft}let Q=Z-s+1,it=Q>0?Math.pow(lt,12/Q)-1:0,et=h[h.length-1]?.total||0;r.push({startWealth:R,earlyReturn:it,endWealth:et})}if(r.length<10)return{sorRiskScore:0,earlyBadImpact:0,earlyGoodImpact:0,correlationEarlyReturns:0,worstSequenceEnd:0,bestSequenceEnd:0,vulnerabilityWindow:c};r.sort((h,R)=>h.earlyReturn-R.earlyReturn);let m=Math.floor(r.length/5),y=r.slice(0,m),u=r.slice(-m),i=r.reduce((h,R)=>h+R.endWealth,0)/r.length,f=y.reduce((h,R)=>h+R.endWealth,0)/y.length,S=u.reduce((h,R)=>h+R.endWealth,0)/u.length,M=r.reduce((h,R)=>h+R.startWealth,0)/r.length,g=M>0?(i-f)/M*100:0,P=M>0?(S-i)/M*100:0,W=g+P,A=r.length,O=r.reduce((h,R)=>h+R.earlyReturn,0),K=r.reduce((h,R)=>h+R.endWealth,0),U=r.reduce((h,R)=>h+R.earlyReturn*R.endWealth,0),B=r.reduce((h,R)=>h+R.earlyReturn*R.earlyReturn,0),X=r.reduce((h,R)=>h+R.endWealth*R.endWealth,0),C=A*U-O*K,V=Math.sqrt((A*B-O*O)*(A*X-K*K)),$=V>0?C/V:0;return{sorRiskScore:Math.abs(W),earlyBadImpact:g,earlyGoodImpact:P,correlationEarlyReturns:$,worstSequenceEnd:f,bestSequenceEnd:S,vulnerabilityWindow:c}}var rn=new Intl.NumberFormat("de-DE",{maximumFractionDigits:0}),ln=new Intl.NumberFormat("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1});function Se(t,a,e){return Math.min(Math.max(t,a),e)}function Te(t,a){let e=[],{maxBudget:s=(t.monthly_savings||0)+(t.monthly_etf||0),tgStep:o=50,rentStep:c=50,rentStepPercent:p=.25,rentRange:r=.5,maxCombinations:m=60}=a,y=t.rent_mode==="percent"||t.monthly_payout_percent!=null&&t.monthly_payout_percent>0,u=[];for(let i=0;i<=s;i+=o)u.push(i);if(y){let i=t.monthly_payout_percent||3.5,f=Math.max(1,i*(1-r)),S=Math.min(8,i*(1+r)),M=[];for(let g=f;g<=S;g+=p)M.push(Math.round(g*100)/100);for(let g of u){let P=s-g;if(!(P<0)){for(let W of M)if(e.push({...t,monthly_savings:g,monthly_etf:P,monthly_payout_percent:W,monthly_payout_net:null,rent_mode:"percent"}),e.length>=m)return e}}}else{let i=t.monthly_payout_net||1e3,f=Math.max(100,i*(1-r)),S=i*(1+r),M=[];for(let g=f;g<=S;g+=c)M.push(Math.round(g));for(let g of u){let P=s-g;if(!(P<0)){for(let W of M)if(e.push({...t,monthly_savings:g,monthly_etf:P,monthly_payout_net:W,monthly_payout_percent:null,rent_mode:"eur"}),e.length>=m)return e}}}return e}function Xe(t,a){let e=[],{maxBudget:s=(t.monthly_savings||0)+(t.monthly_etf||0),budgetStep:o=25,budgetRange:c=.5,maxCombinations:p=60}=a,r=Math.max(50,s*(1-c)),m=s*(1+c);for(let y=r;y<=m;y+=o)for(let u=0;u<=1;u+=.25){let i=Math.round(y*u),f=Math.round(y-i);if(e.push({...t,monthly_savings:i,monthly_etf:f}),e.length>=p)return e}return e}function Pe(t,a,e){switch(a){case"A":case"budget_fix":return Te(t,e);case"B":case"rent_fix":return Xe(t,e);default:return Te(t,e)}}function se(t={}){return{weight:t.emergencyWeight??4e3,maxFillYears:t.emergencyMaxYears??10,minFillProbability:t.minFillProbability??0,hardMinFill:t.hardMinFill??!1,minFillPenalty:t.minFillPenalty??1e6}}function Ie(t,a,e){let o=(t.savings_target??0)>0,c=a.emergencyFillProbability??0,p=a.emergencyMedianFillYears,r=e?.weight??4e3,m=e?.maxFillYears??10,y=e?.minFillProbability??0,u=e?.minFillPenalty??1e6,i=e?.hardMinFill??!1;if(o&&c===0)return{disqualify:!0,contribution:-1/0,fillProb:c,medianFillYears:p};let f=0;if(o&&y>0&&c<y){if(i)return{disqualify:!0,contribution:-1/0,fillProb:c,medianFillYears:p};f=u}let S=o?Se(c/100,0,1):1,M=1;o&&(p==null?M=0:M=Se((m-p)/m,0,1));let g=.6*S+.4*M;return{disqualify:!1,contribution:g*r-f,fillProb:c,medianFillYears:p,quality:g}}function oe(t,a,e=90,s){if(a.successRate<e)return-1/0;let o=Ie(t,a,s);if(o.disqualify)return-1/0;let c=a.medianEndReal||0,p=a.ruinProbability||0,r=0;if(t.rent_mode==="percent"||t.monthly_payout_percent!=null&&t.monthly_payout_percent>0){let y=t.monthly_payout_percent||0;r+=y*1e3}else{let y=t.monthly_payout_net||0;r+=y*10}return r+=c/1e4,r-=p*2,r+=o.contribution,r}function re(t,a,e=90,s){if(a.successRate<e)return-1/0;let o=Ie(t,a,s);if(o.disqualify)return-1/0;let c=(t.monthly_savings||0)+(t.monthly_etf||0),p=a.medianEndReal||0,r=a.ruinProbability||0,m=0;return m-=c*10,m+=p/1e4,m-=r*2,m+=o.contribution,m}function le(t){return{successRate:t.successRate,ruinProbability:t.ruinProbability,medianEnd:t.medianEnd,medianEndReal:t.medianEndReal,capitalPreservationRate:t.capitalPreservationRate,capitalPreservationRateReal:t.capitalPreservationRateReal,retirementMedian:t.retirementMedian,retirementMedianReal:t.retirementMedianReal,p10EndReal:t.p10EndReal,p90EndReal:t.p90EndReal,emergencyFillProbability:t.emergencyFillProbability,emergencyNeverFillProbability:t.emergencyNeverFillProbability,emergencyMedianFillYears:t.emergencyMedianFillYears}}function Fe(t,a,e,s){let o=Math.min(a.iterations||1e3,2e3),c=a.volatility||15,p=e+s;xe(be(p));let r=[];for(let m=0;m<o;m++){let y=Me(t,c);r.push(y)}return we(r,t,a)}function He(t,a,e,s,o){let c=Pe(t,e,s),p=s&&typeof s.targetSuccess=="number"?s.targetSuccess:90,r=se(s||{}),m=e==="B"||e==="rent_fix"?re:oe,y=null,u=c.length;for(let i=0;i<c.length;i++){let f=c[i];self.postMessage({type:"progress",current:i+1,total:u,percent:Math.round((i+1)/u*100),currentCandidate:{monthly_savings:f.monthly_savings,monthly_etf:f.monthly_etf,monthly_payout_net:f.monthly_payout_net,monthly_payout_percent:f.monthly_payout_percent,rent_mode:f.rent_mode}});let S=Fe(f,a,o,i),M=m(f,S,p,r);M!==-1/0&&(!y||M>y.score)&&(y={params:f,results:le(S),score:M})}return y}function je(t,a,e,s,o,c,p){let r=s&&typeof s.targetSuccess=="number"?s.targetSuccess:90,m=se(s||{}),y=e==="B"||e==="rent_fix"?re:oe,u=null,i=0;for(let{candidate:f,globalIdx:S}of t){let M=Fe(f,a,o,S),g=y(f,M,r,m);i++,(i%5===0||i===t.length)&&self.postMessage({type:"chunk-progress",workerId:c,processed:i,chunkSize:t.length,totalCandidates:p}),g!==-1/0&&(!u||g>u.score||g===u.score&&S<u.globalIdx)&&(u={params:f,results:le(M),score:g,globalIdx:S})}return{best:u,processed:i}}self.onmessage=function(t){let{type:a}=t.data;try{switch(a){case"start":{let{params:e,mcOptions:s,mode:o,gridConfig:c,seedBase:p}=t.data;if(!e)throw new Error("Keine Parameter \xFCbergeben");let r=p||(s?.seed??Date.now()),m=He(e,s||{},o||"A",c||{},r);m?self.postMessage({type:"complete",best:m}):self.postMessage({type:"complete",best:null,message:"Keine g\xFCltige Konfiguration gefunden (alle unter Ziel-Erfolgswahrscheinlichkeit)"});break}case"run-chunk":{let{candidates:e,mcOptions:s,mode:o,gridConfig:c,seedBase:p,workerId:r,totalCandidates:m}=t.data;if(!e||!e.length)throw new Error("Keine Kandidaten \xFCbergeben");let{best:y,processed:u}=je(e,s||{},o||"A",c||{},p,r,m);self.postMessage({type:"chunk-complete",workerId:r,best:y,processed:u});break}default:self.postMessage({type:"error",message:`Unbekannter Nachrichtentyp: ${a}`})}}catch(e){self.postMessage({type:"error",message:e.message||"Unbekannter Fehler bei der Optimierung"})}};})();
