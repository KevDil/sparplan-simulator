/**
 * ETF Sparplan & Entnahme Simulator v2.0
 * Bundled: 2025-12-08T16:40:30.107Z
 * https://github.com/KevDil/sparplan-simulator
 */
var ETFSimulator=(()=>{var Fe={aktien:.7,misch:.85,renten:1},Ut=1e3,Le=2e3,Oe=.08,Ne=.09,X=12,Tn=100,Mn={2025:2.53,2024:2.29,2023:2.55,2022:-.05,2021:-.45,2020:.07,2019:.52,2018:.87};function In(t,n=2.53){return Mn[t]!==void 0?Mn[t]:n}var de=5,We="etf_simulator_params",ze="etf_simulator_v2",Ye="etf_simulator_theme",De=2e3,Pn=1e4;var kn=200,me="2.0.0",Ge={id:null,name:"Szenario A",createdAt:null,updatedAt:null,start_savings:4e3,start_etf:100,start_etf_cost_basis:0,savings_rate_pa:3,etf_rate_pa:6,etf_ter_pa:.2,savings_target:5e3,savings_years:36,monthly_savings:100,monthly_etf:150,annual_raise_percent:3,special_payout_net_savings:15e3,special_interval_years_savings:10,inflation_adjust_special_savings:!0,withdrawal_years:30,rent_mode:"eur",monthly_payout_net:1e3,monthly_payout_percent:4,withdrawal_min:0,withdrawal_max:0,rent_is_gross:!1,inflation_adjust_withdrawal:!0,special_payout_net_withdrawal:15e3,special_interval_years_withdrawal:10,inflation_adjust_special_withdrawal:!0,capital_preservation_enabled:!1,capital_preservation_threshold:80,capital_preservation_reduction:25,capital_preservation_recovery:10,inflation_rate_pa:2,is_married:!1,sparerpauschbetrag:Ut,kirchensteuer:"keine",fondstyp:"aktien",basiszins:2.53,use_lifo:!1,loss_pot:0,mc_iterations:De,mc_volatility:15,mc_show_individual:!1,mc_success_threshold:100,mc_ruin_threshold:10,mc_seed:0,stress_scenario:"none"},ee={fire:{name:"FIRE / Fr\xFChrente",description:"Lange Ansparphase, hohe ETF-Quote, 3.5% Entnahme",values:{savings_years:25,withdrawal_years:40,monthly_savings:200,monthly_etf:800,savings_target:1e4,monthly_payout_percent:3.5,rent_mode:"percent",etf_rate_pa:7,inflation_adjust_withdrawal:!0}},classic:{name:"Klassische Rente",description:"67 \u2192 95, moderate ETF-Quote, konservativere Entnahme",values:{savings_years:35,withdrawal_years:28,monthly_savings:150,monthly_etf:350,savings_target:8e3,monthly_payout_percent:4,rent_mode:"percent",etf_rate_pa:6,capital_preservation_enabled:!0}},education:{name:"Bildungskonto / Studium",description:"K\xFCrzere Laufzeit, Entnahmen \xFCber 3-6 Jahre",values:{savings_years:18,withdrawal_years:5,monthly_savings:50,monthly_etf:150,savings_target:3e3,monthly_payout_net:800,rent_mode:"eur",inflation_adjust_withdrawal:!0}},emergency:{name:"Notgroschen-Fokus",description:"Aggressiver Aufbau des Tagesgeldziels, konservativ in ETF",values:{savings_years:10,withdrawal_years:25,monthly_savings:300,monthly_etf:100,savings_target:15e3,monthly_payout_percent:3,rent_mode:"percent",etf_rate_pa:5}}},ue={none:{name:"Standard (Zuf\xE4llig)",description:"Normale Monte-Carlo-Simulation mit zuf\xE4lligen Renditen",returns:null},early_crash:{name:"Fr\xFCher Crash",description:"-30% im 1. Rentenjahr, langsame Erholung \xFCber 5 Jahre",returns:[-.3,-.1,.05,.08,.1,.12,.08,.07,.06,.06]},sideways:{name:"Seitw\xE4rtsmarkt",description:"0% Realrendite \xFCber 10 Jahre",returns:[.02,.01,-.01,.02,0,-.02,.03,-.01,.01,0]},bear_market:{name:"B\xE4renmarkt-Phase",description:"3-5 Jahre leicht negative Renditen, danach normal",returns:[-.05,-.08,-.03,-.02,.02,.08,.1,.07,.06,.06]},late_crash:{name:"Sp\xE4ter Crash",description:"Normaler Start, Crash nach 5 Jahren",returns:[.08,.1,.07,.09,.06,-.35,-.15,.1,.12,.08]}},Vt="simple",ne="expert",An=["kirchensteuer","basiszins","use_lifo","fondstyp","capital_preservation_threshold","capital_preservation_reduction","capital_preservation_recovery","loss_pot","start_etf_cost_basis","mc_seed","mc_ruin_threshold","rent_is_gross"];var I={activeScenarioId:"A",scenarios:{A:null,B:null,C:null},uiMode:ne,theme:"dark",results:{A:null,B:null,C:null},mcResults:{A:null,B:null,C:null},listeners:[]};function Ba(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}function Ue(t){return JSON.parse(JSON.stringify(t))}function jt(t="Neues Szenario",n=null){let a=new Date().toISOString();return{...Ue(n||Ge),id:Ba(),name:t,createdAt:a,updatedAt:a}}function mt(){return I.activeScenarioId}function z(){return I.scenarios[I.activeScenarioId]}function Ve(){return{...I.scenarios}}function je(t){I.scenarios[t]&&(I.activeScenarioId=t,bt("activeScenarioChanged",{id:t}),It())}function qt(t,n){I.scenarios[t]&&(I.scenarios[t]={...I.scenarios[t],...n,updatedAt:new Date().toISOString()},bt("scenarioUpdated",{id:t,scenario:I.scenarios[t]}),It())}function Cn(t,n){let a=I.scenarios[t];if(!a)return null;let e=`Kopie von ${a.name}`,o=jt(e,a);return I.scenarios[n]=o,bt("scenarioDuplicated",{sourceId:t,targetId:n,scenario:o}),It(),o}function Bn(t){let n=ee[t];if(!n)return!1;let a=I.activeScenarioId,e=I.scenarios[a];return I.scenarios[a]={...e,...n.values,name:n.name,updatedAt:new Date().toISOString()},bt("presetApplied",{presetKey:t,scenario:I.scenarios[a]}),It(),!0}function $n(t){let n=`Szenario ${t}`;I.scenarios[t]=jt(n),bt("scenarioReset",{id:t}),It()}function Fn(t,n){I.results[t]=n,bt("resultsUpdated",{id:t})}function Ln(t,n){I.mcResults[t]=n,bt("mcResultsUpdated",{id:t})}function On(t){return I.mcResults[t]}function Nn(){return I.uiMode}function $a(t){(t===Vt||t===ne)&&(I.uiMode=t,bt("uiModeChanged",{mode:t}),It())}function Wn(){let t=I.uiMode===Vt?ne:Vt;return $a(t),t}function qe(){return I.theme}function zn(t){I.theme=t,bt("themeChanged",{theme:t});try{localStorage.setItem(Ye,t)}catch{}}function Yn(t){return I.listeners.push(t),()=>{let n=I.listeners.indexOf(t);n>-1&&I.listeners.splice(n,1)}}function bt(t,n){I.listeners.forEach(a=>{try{a(t,n)}catch(e){console.error("State listener error:",e)}})}function It(){try{let t={version:me,activeScenarioId:I.activeScenarioId,scenarios:I.scenarios,uiMode:I.uiMode,savedAt:new Date().toISOString()};localStorage.setItem(ze,JSON.stringify(t))}catch(t){console.error("Failed to save state:",t)}}function Fa(){try{let t=localStorage.getItem(ze);if(t){let a=JSON.parse(t);return La(a)}let n=localStorage.getItem(We);if(n){let a=JSON.parse(n);return Oa(a)}return null}catch(t){return console.error("Failed to load state:",t),null}}function La(t){return t.scenarios?(I.activeScenarioId=t.activeScenarioId||"A",I.uiMode=t.uiMode||ne,["A","B","C"].forEach(n=>{t.scenarios[n]?I.scenarios[n]={...Ue(Ge),...t.scenarios[n]}:n==="A"&&(I.scenarios[n]=jt("Szenario A"))}),I):null}function Oa(t){console.log("Migrating from v1 to v2...");let n={start_savings:"start_savings",start_etf:"start_etf",start_etf_cost_basis:"start_etf_cost_basis",savings_rate:"savings_rate_pa",etf_rate:"etf_rate_pa",etf_ter:"etf_ter_pa",savings_target:"savings_target",years_save:"savings_years",monthly_savings:"monthly_savings",monthly_etf:"monthly_etf",annual_raise:"annual_raise_percent",special_savings:"special_payout_net_savings",special_savings_interval:"special_interval_years_savings",inflation_adjust_special_savings:"inflation_adjust_special_savings",years_withdraw:"withdrawal_years",rent_eur:"monthly_payout_net",rent_percent:"monthly_payout_percent",withdrawal_min:"withdrawal_min",withdrawal_max:"withdrawal_max",inflation_adjust_withdrawal:"inflation_adjust_withdrawal",special_withdraw:"special_payout_net_withdrawal",special_withdraw_interval:"special_interval_years_withdrawal",inflation_adjust_special_withdrawal:"inflation_adjust_special_withdrawal",inflation_rate:"inflation_rate_pa",sparerpauschbetrag:"sparerpauschbetrag",kirchensteuer:"kirchensteuer",fondstyp:"fondstyp",basiszins:"basiszins",use_lifo:"use_lifo",capital_preservation_enabled:"capital_preservation_enabled",capital_preservation_threshold:"capital_preservation_threshold",capital_preservation_reduction:"capital_preservation_reduction",capital_preservation_recovery:"capital_preservation_recovery",loss_pot:"loss_pot",rent_mode:"rent_mode"},a=jt("Szenario A");for(let[e,o]of Object.entries(n))t[e]!==void 0&&t[e]!==null&&(a[o]=t[e]);t.savings_rate_pa!==void 0&&(a.savings_rate_pa=t.savings_rate_pa),t.etf_rate_pa!==void 0&&(a.etf_rate_pa=t.etf_rate_pa),I.scenarios.A=a,I.activeScenarioId="A",It();try{localStorage.removeItem(We)}catch{}return console.log("Migration complete"),I}function Dn(){try{let n=localStorage.getItem(Ye);n?I.theme=n:window.matchMedia&&window.matchMedia("(prefers-color-scheme: light)").matches&&(I.theme="light")}catch{}return Fa()||(I.scenarios.A=jt("Szenario A")),I}function Gn(){try{let n=new URLSearchParams(window.location.search).get("s");if(!n)return null;let a=JSON.parse(atob(n)),e={ss:"start_savings",se:"start_etf",sr:"savings_rate_pa",er:"etf_rate_pa",st:"savings_target",ys:"savings_years",yw:"withdrawal_years",ms:"monthly_savings",me:"monthly_etf",ar:"annual_raise_percent",rm:"rent_mode",rn:"monthly_payout_net",rp:"monthly_payout_percent",ir:"inflation_rate_pa",sp:"sparerpauschbetrag"},o=jt("Geteiltes Szenario");for(let[s,r]of Object.entries(a)){let i=e[s];i&&r!==void 0&&(o[i]=r)}return I.scenarios.A=o,I.activeScenarioId="A",It(),window.history.replaceState({},"",window.location.pathname),o}catch(t){return console.error("Failed to load from share URL:",t),null}}function Pt(t){return t?{start_savings:t.start_savings,start_etf:t.start_etf,start_etf_cost_basis:t.start_etf_cost_basis,monthly_savings:t.monthly_savings,monthly_etf:t.monthly_etf,savings_rate_pa:t.savings_rate_pa,etf_rate_pa:t.etf_rate_pa,etf_ter_pa:t.etf_ter_pa,savings_target:t.savings_target,annual_raise_percent:t.annual_raise_percent,savings_years:t.savings_years,withdrawal_years:t.withdrawal_years,monthly_payout_net:t.rent_mode==="eur"?t.monthly_payout_net:null,monthly_payout_percent:t.rent_mode==="percent"?t.monthly_payout_percent:null,withdrawal_min:t.withdrawal_min,withdrawal_max:t.withdrawal_max,rent_is_gross:t.rent_is_gross,inflation_adjust_withdrawal:t.inflation_adjust_withdrawal,special_payout_net_savings:t.special_payout_net_savings,special_interval_years_savings:t.special_interval_years_savings,inflation_adjust_special_savings:t.inflation_adjust_special_savings,special_payout_net_withdrawal:t.special_payout_net_withdrawal,special_interval_years_withdrawal:t.special_interval_years_withdrawal,inflation_adjust_special_withdrawal:t.inflation_adjust_special_withdrawal,inflation_rate_pa:t.inflation_rate_pa,sparerpauschbetrag:t.sparerpauschbetrag,kirchensteuer:t.kirchensteuer,basiszins:t.basiszins,use_lifo:t.use_lifo,capital_preservation_enabled:t.capital_preservation_enabled,capital_preservation_threshold:t.capital_preservation_threshold,capital_preservation_reduction:t.capital_preservation_reduction,capital_preservation_recovery:t.capital_preservation_recovery,loss_pot:t.loss_pot,fondstyp:t.fondstyp}:null}function he(t){return t?{iterations:t.mc_iterations,volatility:t.mc_volatility,showIndividual:t.mc_show_individual,successThreshold:t.mc_success_threshold,ruinThresholdPercent:t.mc_ruin_threshold,seed:t.mc_seed||0,stressScenario:t.stress_scenario||"none"}:{}}var Vn={start_savings:"start_savings",start_etf:"start_etf",start_etf_cost_basis:"start_etf_cost_basis",savings_rate:"savings_rate_pa",etf_rate:"etf_rate_pa",etf_ter:"etf_ter_pa",savings_target:"savings_target",years_save:"savings_years",monthly_savings:"monthly_savings",monthly_etf:"monthly_etf",annual_raise:"annual_raise_percent",special_savings:"special_payout_net_savings",special_savings_interval:"special_interval_years_savings",years_withdraw:"withdrawal_years",rent_eur:"monthly_payout_net",rent_percent:"monthly_payout_percent",withdrawal_min:"withdrawal_min",withdrawal_max:"withdrawal_max",special_withdraw:"special_payout_net_withdrawal",special_withdraw_interval:"special_interval_years_withdrawal",inflation_rate:"inflation_rate_pa",sparerpauschbetrag:"sparerpauschbetrag",basiszins:"basiszins",capital_preservation_threshold:"capital_preservation_threshold",capital_preservation_reduction:"capital_preservation_reduction",capital_preservation_recovery:"capital_preservation_recovery",loss_pot:"loss_pot",mc_iterations:"mc_iterations",mc_volatility:"mc_volatility",mc_success_threshold:"mc_success_threshold",mc_ruin_threshold:"mc_ruin_threshold",mc_seed:"mc_seed"},jn={inflation_adjust_withdrawal:"inflation_adjust_withdrawal",inflation_adjust_special_savings:"inflation_adjust_special_savings",inflation_adjust_special_withdrawal:"inflation_adjust_special_withdrawal",capital_preservation_enabled:"capital_preservation_enabled",use_lifo:"use_lifo",rent_is_gross:"rent_is_gross",mc_show_individual:"mc_show_individual",is_married:"is_married"},qn={kirchensteuer:"kirchensteuer",fondstyp:"fondstyp"};function Ot(){let t={};for(let[e,o]of Object.entries(Vn)){let s=document.getElementById(e);if(s){let r=parseFloat(String(s.value).replace(",","."));Number.isNaN(r)||(t[o]=r)}}for(let[e,o]of Object.entries(jn)){let s=document.getElementById(e);s&&(t[o]=s.checked)}for(let[e,o]of Object.entries(qn)){let s=document.getElementById(e);s&&(t[o]=s.value)}let n=document.querySelector('input[name="rent_mode"][value="eur"]');n&&(t.rent_mode=n.checked?"eur":"percent");let a=document.getElementById("stress_scenario");return a&&(t.stress_scenario=a.value),qt(mt(),t),z()}function gt(t){if(!t)return;for(let[e,o]of Object.entries(Vn)){let s=document.getElementById(e);s&&t[o]!==void 0&&(s.value=t[o])}for(let[e,o]of Object.entries(jn)){let s=document.getElementById(e);s&&t[o]!==void 0&&(s.checked=t[o])}for(let[e,o]of Object.entries(qn)){let s=document.getElementById(e);s&&t[o]!==void 0&&(s.value=t[o])}let n=document.querySelector(`input[name="rent_mode"][value="${t.rent_mode}"]`);n&&(n.checked=!0);let a=document.getElementById("stress_scenario");a&&t.stress_scenario&&(a.value=t.stress_scenario),Ke(),He()}function Ke(){let n=document.querySelector('input[name="rent_mode"][value="eur"]')?.checked??!0,a=document.getElementById("rent_eur")?.closest(".field"),e=document.getElementById("rent_percent")?.closest(".field"),o=document.getElementById("withdrawal_min")?.closest(".field"),s=document.getElementById("withdrawal_max")?.closest(".field");if(a){a.classList.toggle("field--disabled",!n);let r=a.querySelector("input");r&&(r.disabled=!n)}if(e){e.classList.toggle("field--disabled",n);let r=e.querySelector("input");r&&(r.disabled=n)}if(o){o.classList.toggle("field--disabled",n);let r=o.querySelector("input");r&&(r.disabled=n)}if(s){s.classList.toggle("field--disabled",n);let r=s.querySelector("input");r&&(r.disabled=n)}}function Na(){let t=document.getElementById("is_married")?.checked??!1,n=document.getElementById("sparerpauschbetrag");n&&(n.value=t?Le:Ut,qt(mt(),{sparerpauschbetrag:t?Le:Ut}))}function He(){let t=document.getElementById("capital_preservation_enabled")?.checked??!1,n=["capital_preservation_threshold","capital_preservation_reduction","capital_preservation_recovery"];for(let a of n){let e=document.getElementById(a)?.closest(".field");if(e){e.classList.toggle("field--disabled",!t);let o=e.querySelector("input");o&&(o.disabled=!t)}}}function Un(){let n=Nn()===Vt;for(let e of An){let o=document.getElementById(e)?.closest(".field");o&&(o.style.display=n?"none":"")}let a=document.getElementById("btn-mode-toggle");a&&(a.textContent=n?"Expertenmodus":"Einfacher Modus")}function Wa(){let t=document.getElementById("scenario-tabs");t&&(Je(),t.addEventListener("click",n=>{let a=n.target.closest(".scenario-tab");if(!a)return;let e=a.dataset.action,o=a.dataset.scenario;if(e==="select"&&o)je(o),Je(),gt(z());else if(e==="add"){let s=Ve(),r=s.B?s.C?null:"C":"B";r&&(Cn(mt(),r),je(r),Je(),gt(z()))}}))}function Je(){let t=document.getElementById("scenario-tabs");if(!t)return;let n=Ve(),a=mt(),e="";for(let s of["A","B","C"]){let r=n[s];if(!r)continue;e+=`
      <button class="scenario-tab ${s===a?"scenario-tab--active":""}" 
              data-action="select" data-scenario="${s}">
        ${r.name}
      </button>
    `}Object.values(n).filter(Boolean).length<3&&(e+=`
      <button class="scenario-tab scenario-tab--add" data-action="add">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
      </button>
    `),t.innerHTML=e}function za(){let t=document.getElementById("preset-buttons");if(!t)return;let n="";for(let[a,e]of Object.entries(ee))n+=`
      <button class="preset-btn" data-preset="${a}" title="${e.description}">
        ${e.name}
      </button>
    `;t.innerHTML=n,t.addEventListener("click",a=>{let e=a.target.closest(".preset-btn");if(!e)return;let o=e.dataset.preset;Bn(o)&&(gt(z()),Y(`Vorlage "${ee[o].name}" angewendet.`))})}function Ya(){let t=document.getElementById("stress_scenario");if(!t)return;let n="";for(let[a,e]of Object.entries(ue))n+=`<option value="${a}">${e.name}</option>`;t.innerHTML=n}var pe=[{id:"age",title:"Wie alt bist du?",description:"Dein aktuelles Alter hilft uns, die passende Anlagedauer zu bestimmen.",field:{type:"number",min:18,max:80,default:30}},{id:"retirement_age",title:"Wann m\xF6chtest du in Rente gehen?",description:"Das Alter, ab dem du von deinem Verm\xF6gen leben m\xF6chtest.",field:{type:"number",min:40,max:90,default:65}},{id:"monthly_budget",title:"Wie viel kannst du monatlich sparen?",description:"Dein verf\xFCgbares Budget f\xFCr Tagesgeld und ETF-Sparplan.",field:{type:"number",min:50,max:1e4,default:500}},{id:"risk_level",title:"Wie risikobereit bist du?",description:"Beeinflusst die Aufteilung zwischen Tagesgeld und ETF.",field:{type:"select",options:[{value:"conservative",label:"Konservativ (mehr Sicherheit)"},{value:"balanced",label:"Ausgewogen"},{value:"aggressive",label:"Offensiv (mehr Rendite)"}],default:"balanced"}},{id:"existing_wealth",title:"Hast du bereits Verm\xF6gen?",description:"Vorhandenes Tagesgeld und ETF-Depot.",field:{type:"number",min:0,max:1e7,default:0}}],Lt={step:0,answers:{}};function Da(){Lt={step:0,answers:{}},Xe(0)}function Xe(t){let n=document.getElementById("wizard-modal");if(!n)return;let a=pe[t];if(!a){Ga();return}let e="";if(a.field.type==="number")e=`
      <input type="number" id="wizard-input" 
             min="${a.field.min}" max="${a.field.max}" 
             value="${Lt.answers[a.id]||a.field.default}">
    `;else if(a.field.type==="select"){e='<select id="wizard-input">';for(let o of a.field.options){let s=(Lt.answers[a.id]||a.field.default)===o.value?"selected":"";e+=`<option value="${o.value}" ${s}>${o.label}</option>`}e+="</select>"}n.innerHTML=`
    <div class="wizard-content">
      <div class="wizard-progress">
        <span>Schritt ${t+1} von ${pe.length}</span>
        <div class="wizard-progress-bar">
          <div class="wizard-progress-fill" style="width: ${(t+1)/pe.length*100}%"></div>
        </div>
      </div>
      <h3>${a.title}</h3>
      <p>${a.description}</p>
      <div class="wizard-field">${e}</div>
      <div class="wizard-actions">
        ${t>0?'<button class="btn btn--secondary" id="wizard-back">Zur\xFCck</button>':""}
        <button class="btn btn--primary" id="wizard-next">
          ${t===pe.length-1?"Fertig":"Weiter"}
        </button>
      </div>
      <button class="wizard-close" id="wizard-close">&times;</button>
    </div>
  `,n.classList.add("active"),document.getElementById("wizard-next")?.addEventListener("click",()=>{let o=document.getElementById("wizard-input");Lt.answers[a.id]=o?.value,Lt.step=t+1,Xe(t+1)}),document.getElementById("wizard-back")?.addEventListener("click",()=>{Lt.step=t-1,Xe(t-1)}),document.getElementById("wizard-close")?.addEventListener("click",()=>{n.classList.remove("active")})}function Ga(){let t=document.getElementById("wizard-modal");t&&t.classList.remove("active");let n=Lt.answers,a=parseInt(n.age)||30,e=parseInt(n.retirement_age)||65,o=parseInt(n.monthly_budget)||500,s=n.risk_level||"balanced",r=parseInt(n.existing_wealth)||0,i=Math.max(1,e-a),p=Math.max(10,95-e),m=.3;s==="conservative"?m=.5:s==="aggressive"&&(m=.15);let l=Math.round(o*m),f=o-l,v={savings_years:i,withdrawal_years:p,monthly_savings:l,monthly_etf:f,start_savings:Math.round(r*m),start_etf:Math.round(r*(1-m)),savings_target:Math.max(5e3,l*12*3)};qt(mt(),v),gt(z()),Y("Wizard abgeschlossen! Einstellungen wurden \xFCbernommen.")}function Y(t,n="info"){let a=document.getElementById("message");a&&(a.textContent=t,a.className=`message message--${n}`,a.onclick=()=>{a.textContent="",a.className="message",a.onclick=null})}function Jn(t,n){let a=document.getElementById("sim-form");if(!a)return;a.addEventListener("submit",r=>{r.preventDefault();try{Ot(),t?.()}catch(i){Y(i.message,"error")}});let e=a.querySelectorAll('input[name="rent_mode"]');for(let r of e)r.addEventListener("change",Ke);document.getElementById("capital_preservation_enabled")?.addEventListener("change",He),document.getElementById("is_married")?.addEventListener("change",Na),document.getElementById("btn-reset")?.addEventListener("click",()=>{$n(mt()),gt(z()),Y("Standardwerte wiederhergestellt.")}),document.getElementById("btn-monte-carlo")?.addEventListener("click",()=>{try{Ot(),n?.()}catch(r){Y(r.message,"error")}}),document.getElementById("btn-mode-toggle")?.addEventListener("click",()=>{Wn(),Un()}),document.getElementById("btn-wizard")?.addEventListener("click",Da),Ke(),He(),Un()}function Kn(){let t=z();t&&gt(t),za(),Ya(),Wa()}var Jt=new Intl.NumberFormat("de-DE",{maximumFractionDigits:0}),kt=new Intl.NumberFormat("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1}),$o=new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2});function b(t){return Jt.format(t)+" \u20AC"}function et(t,n=1){return kt.format(t)+"%"}var Et={total:"#f59e0b",real:"#22c55e",savings:"#3b82f6",etf:"#8b5cf6",median:"#f59e0b",band50:"rgba(99, 102, 241, 0.35)",band80:"rgba(99, 102, 241, 0.15)",p5:"#ef4444",p95:"#22c55e",grid:"rgba(255, 255, 255, 0.1)",text:"rgba(255, 255, 255, 0.7)",anspar:"rgba(56, 189, 248, 0.1)",entnahme:"rgba(139, 92, 246, 0.05)"},Ze=null,Qe=null;function fe(t,n={}){let a=document.getElementById("graph");if(!a||!t?.length)return;let e=a.getContext("2d"),o=window.devicePixelRatio||1,s=a.getBoundingClientRect(),r=s.width,i=s.height;if(!r||!i)return;a.width=r*o,a.height=i*o,e.setTransform(o,0,0,o,0,0);let p={top:20,right:20,bottom:40,left:70},m=r-p.left-p.right,l=i-p.top-p.bottom,f=t.map((h,P)=>({x:P,month:h.month,year:h.year,total:h.total,real:h.total_real,phase:h.phase})),v=n.logScale??!1,g=Math.max(...f.map(h=>Math.max(h.total,h.real))),_=v?Math.max(1,Math.min(...f.map(h=>Math.min(h.total,h.real)))):0,d;if(v){let h=Math.log10(_),P=Math.log10(g);d=k=>p.top+(1-(Math.log10(Math.max(k,1))-h)/(P-h))*l}else d=h=>p.top+(1-h/g)*l;let w=h=>p.left+h/(f.length-1)*m;e.clearRect(0,0,r,i),e.strokeStyle=Et.grid,e.lineWidth=1;let x=Ua(_,g,de,v);for(let h of x){let P=d(h);e.beginPath(),e.moveTo(p.left,P),e.lineTo(r-p.right,P),e.stroke(),e.fillStyle=Et.text,e.font="11px sans-serif",e.textAlign="right",e.textBaseline="middle",e.fillText(Va(h),p.left-8,P+1)}let y=f.findIndex(h=>h.phase==="Entnahme");if(y!==-1){let h=w(y);e.strokeStyle="#6b7280",e.setLineDash([5,5]),e.beginPath(),e.moveTo(h,p.top),e.lineTo(h,i-p.bottom),e.stroke(),e.setLineDash([]),e.fillStyle="#94a3b8",e.font="12px 'Segoe UI', sans-serif",e.textAlign="right",e.textBaseline="middle",e.fillText("Entnahme ->",h-6,p.top+40)}let R=[],T=0;for(let h=0;h<f.length;h+=12){let P=f[h].year;P!==T&&(R.push({x:w(h),label:String(P)}),T=P)}e.textAlign="center",e.textBaseline="top";for(let h of R)e.fillText(h.label,h.x,i-p.bottom+8);e.strokeStyle=Et.real,e.lineWidth=2,e.beginPath(),f.forEach((h,P)=>{let k=w(P),D=d(h.real);P===0?e.moveTo(k,D):e.lineTo(k,D)}),e.stroke(),e.strokeStyle=Et.total,e.lineWidth=2,e.beginPath(),f.forEach((h,P)=>{let k=w(P),D=d(h.total);P===0?e.moveTo(k,D):e.lineTo(k,D)}),e.stroke(),Ze={data:f,xScale:w,yScale:d,margin:p,width:r,height:i}}function At(t,n={}){let a=document.getElementById("mc-graph");if(!a||!t)return;let e=a.getContext("2d"),o=window.devicePixelRatio||1,s=a.getBoundingClientRect(),r=s.width,i=s.height;if(!r||!i)return;a.width=r*o,a.height=i*o,e.setTransform(o,0,0,o,0,0),e.clearRect(0,0,r,i);let{percentiles:p,percentilesReal:m,months:l,savingsYears:f}=t;if(!l||!l.length)return;let v=n.showReal??!1,g=v&&m?m:p,_=60,d=50,w=Math.max(l.length-1,1),x=g.p5.some(E=>E<=0)||g.p10.some(E=>E<=0),y=n.logScale??!0,R=1,T=g.p5.filter(E=>E>0),h=y?Math.max(R,T.length>0?Math.min(...T):R):0,P=Math.max(h*10,...g.p95),k;if(y){let E=Math.log10(h),S=Math.log10(P);k=(c,u)=>{let L=_+c/w*(r-2*_),G=Math.max(h,u),Wt=(Math.log10(G)-E)/(S-E),Ht=i-d-Wt*(i-2*d);return[L,Ht]}}else k=(E,S)=>{let c=_+E/w*(r-2*_),u=i-d-S/P*(i-2*d);return[c,u]};if(e.strokeStyle="#8b96a9",e.lineWidth=1,e.beginPath(),e.moveTo(_,i-d),e.lineTo(r-_,i-d),e.moveTo(_,i-d),e.lineTo(_,d),e.stroke(),e.font="12px 'Segoe UI', sans-serif",e.fillStyle="#94a3b8",e.textAlign="right",e.textBaseline="middle",y){let E=Math.log10(h),S=[],c=Math.pow(10,Math.floor(E));for(;c<=P;)c>=h&&S.push(c),c*2>=h&&c*2<=P&&S.push(c*2),c*5>=h&&c*5<=P&&S.push(c*5),c*=10;for(let u of S){let[,L]=k(0,u);e.strokeStyle="rgba(255,255,255,0.05)",e.beginPath(),e.moveTo(_,L),e.lineTo(r-_,L),e.stroke(),e.fillStyle="#94a3b8";let G=u>=1e6?`${(u/1e6).toFixed(u%1e6===0?0:1)}M`:`${Math.round(u/1e3)}k`;e.fillText(G,_-8,L)}}else for(let E=0;E<=de;E++){let S=P*(E/de),[,c]=k(0,S);e.strokeStyle="rgba(255,255,255,0.05)",e.beginPath(),e.moveTo(_,c),e.lineTo(r-_,c),e.stroke(),e.fillStyle="#94a3b8";let u=S>=1e6?`${(S/1e6).toFixed(1)}M`:`${Math.round(S/1e3)}k`;e.fillText(u,_-8,c)}e.textAlign="center",e.textBaseline="top";let D=Math.ceil(l.length/X);for(let E=1;E<=D;E+=1){let S=Math.min(E*X-1,l.length-1),[c]=k(S,0);e.strokeStyle="rgba(255,255,255,0.15)",e.beginPath(),e.moveTo(c,i-d),e.lineTo(c,i-d+6),e.stroke(),e.fillStyle="#94a3b8",e.fillText(String(E),c,i-d+8)}let j=(E,S,c)=>{e.fillStyle=c,e.beginPath();for(let u=0;u<l.length;u++){let[L,G]=k(u,S[u]);u===0?e.moveTo(L,G):e.lineTo(L,G)}for(let u=l.length-1;u>=0;u--){let[L,G]=k(u,E[u]);e.lineTo(L,G)}e.closePath(),e.fill()};if(j(g.p10,g.p90,Et.band80),j(g.p25,g.p75,Et.band50),n.showIndividualPaths&&t.allHistories?.length){e.strokeStyle="rgba(255, 255, 255, 0.08)",e.lineWidth=.5;let E=Math.min(50,t.allHistories.length);for(let S=0;S<E;S++){let c=t.allHistories[S];e.beginPath(),c.forEach((u,L)=>{let G=v&&u.total_real||u.total,[_t,Wt]=k(L,G);L===0?e.moveTo(_t,Wt):e.lineTo(_t,Wt)}),e.stroke()}}if(e.strokeStyle=Et.median,e.lineWidth=2.5,e.beginPath(),g.p50.forEach((E,S)=>{let[c,u]=k(S,E);S===0?e.moveTo(c,u):e.lineTo(c,u)}),e.stroke(),e.setLineDash([4,4]),e.lineWidth=1,e.strokeStyle=Et.p5,e.globalAlpha=.6,e.beginPath(),g.p5.forEach((E,S)=>{let[c,u]=k(S,E);S===0?e.moveTo(c,u):e.lineTo(c,u)}),e.stroke(),e.strokeStyle=Et.p95,e.beginPath(),g.p95.forEach((E,S)=>{let[c,u]=k(S,E);S===0?e.moveTo(c,u):e.lineTo(c,u)}),e.stroke(),e.globalAlpha=1,e.setLineDash([]),y&&x){e.fillStyle="rgba(239, 68, 68, 0.7)",e.strokeStyle="rgba(239, 68, 68, 0.9)",e.lineWidth=2,g.p5.forEach((S,c)=>{if(S<=R){let[u,L]=k(c,R);e.beginPath(),e.moveTo(u,L+6),e.lineTo(u-5,L-4),e.lineTo(u+5,L-4),e.closePath(),e.fill()}});let E=g.p5.findIndex(S=>S<=R);if(E>=0){let[S,c]=k(E,R);e.font="11px 'Segoe UI', sans-serif",e.fillStyle="rgba(239, 68, 68, 0.9)",e.textAlign="left",e.textBaseline="bottom",e.fillText("\u26A0 Pleite-Szenarien",S+8,c-2)}}let U=typeof n.savingsYears=="number"?n.savingsYears:null,V=U??(typeof t.savingsYears=="number"?t.savingsYears:typeof f=="number"?f:0);if(V>0){let E=V*X;if(E>=0&&E<=l.length-1){let[S]=k(E,0);e.strokeStyle="#6b7280",e.setLineDash([5,5]),e.lineWidth=1,e.beginPath(),e.moveTo(S,d),e.lineTo(S,i-d),e.stroke(),e.setLineDash([]),e.fillStyle="#94a3b8",e.textAlign="right",e.textBaseline="middle",e.fillText("Entnahme \u2192",S-6,d+20)}}Qe={percentiles:g,xScale:E=>_+E/w*(r-2*_),yScale:null,margin:{top:d,right:_,bottom:d,left:_},width:r,height:i,numMonths:l.length}}function Ua(t,n,a,e){if(e){let i=Math.floor(Math.log10(Math.max(t,1))),p=Math.ceil(Math.log10(n)),m=[];for(let l=i;l<=p;l++)m.push(Math.pow(10,l));return m}let s=(n-t)/a,r=[];for(let i=0;i<=a;i++)r.push(t+s*i);return r}function Va(t){return t>=1e6?kt.format(t/1e6)+" M\u20AC":t>=1e3?Jt.format(t/1e3)+" k\u20AC":Jt.format(t)+" \u20AC"}function Hn(){let t=document.getElementById("tooltip"),n=document.getElementById("graph"),a=document.getElementById("mc-graph");if(!t)return;function e(s,r,i){t.innerHTML=i,t.style.left=`${s+15}px`,t.style.top=`${r-10}px`,t.setAttribute("data-visible","true")}function o(){t.setAttribute("data-visible","false")}n?.addEventListener("mousemove",s=>{if(!Ze)return;let r=n.getBoundingClientRect(),i=s.clientX-r.left,p=s.clientY-r.top,{data:m,xScale:l,margin:f,width:v}=Ze;if(i<f.left||i>v-f.right){o();return}let g=(i-f.left)/(v-f.left-f.right),_=Math.round(g*(m.length-1)),d=m[_];if(d){let w=`
        <strong>Jahr ${d.year}, Monat ${(d.month-1)%12+1}</strong><br>
        Nominal: ${b(d.total)}<br>
        Real: ${b(d.real)}<br>
        Phase: ${d.phase}
      `;e(s.clientX,s.clientY,w)}}),n?.addEventListener("mouseleave",o),a?.addEventListener("mousemove",s=>{if(!Qe)return;let r=a.getBoundingClientRect(),i=s.clientX-r.left,{percentiles:p,xScale:m,margin:l,width:f,numMonths:v}=Qe;if(i<l.left||i>f-l.right){o();return}let g=(i-l.left)/(f-l.left-l.right),_=Math.min(Math.round(g*(v-1)),v-1),d=Math.floor(_/12)+1,w=_%12+1,x=`
      <strong>Jahr ${d}, Monat ${w}</strong><br>
      Median: ${b(p.p50[_])}<br>
      25-75%: ${b(p.p25[_])} - ${b(p.p75[_])}<br>
      10-90%: ${b(p.p10[_])} - ${b(p.p90[_])}
    `;e(s.clientX,s.clientY,x)}),a?.addEventListener("mouseleave",o)}function Xn(t,n){let a=document.getElementById("risk-widget");if(!a)return;let e="unknown",o="-";if(n){let m=n.emergencyFillProbability||0;m>80?(e="good",o=`${Jt.format(m)}% erreichen Ziel`):m>50?(e="warning",o=`${Jt.format(m)}% erreichen Ziel`):(e="bad",o=`Nur ${Jt.format(m)}% erreichen Ziel`)}let s="unknown",r="-";if(n){let m=n.ruinProbability||0;m<5?(s="good",r=`${kt.format(m)}% Pleite-Risiko`):m<15?(s="warning",r=`${kt.format(m)}% Pleite-Risiko`):(s="bad",r=`${kt.format(m)}% Pleite-Risiko`)}let i="unknown",p="-";if(n){let m=n.successRate||0;m>=95?(i="good",p=`${kt.format(m)}% Erfolg`):m>=80?(i="warning",p=`${kt.format(m)}% Erfolg`):(i="bad",p=`${kt.format(m)}% Erfolg`)}a.innerHTML=`
    <div class="risk-widget-header">
      <h4>Risiko-\xDCbersicht</h4>
    </div>
    <div class="risk-widget-grid">
      <div class="risk-item risk-item--${i}">
        <span class="risk-indicator"></span>
        <span class="risk-label">Erfolg</span>
        <span class="risk-value">${p}</span>
      </div>
      <div class="risk-item risk-item--${s}">
        <span class="risk-indicator"></span>
        <span class="risk-label">Ruin</span>
        <span class="risk-value">${r}</span>
      </div>
      <div class="risk-item risk-item--${e}">
        <span class="risk-indicator"></span>
        <span class="risk-label">Notgroschen</span>
        <span class="risk-value">${o}</span>
      </div>
    </div>
  `}var Qn=Math.random;function tn(t){return Math.pow(1+t/100,1/X)-1}function qa(t){return t/Math.sqrt(12)}function Ja(t=0){let n=.25*(1+.055);return t===0?n:t===Oe?.27818:t===Ne?.27995:n+.25*t}function Ka(t=0,n=1){let a,e;do a=Qn(),e=Qn();while(a===0);return Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*e)*n+t}function C(t,n){if(t.length===0)return 0;let a=n/100*(t.length-1),e=Math.floor(a),o=Math.ceil(a);return e===o?t[e]:t[e]*(o-a)+t[o]*(a-e)}function Ha(t,n=.01){if(t.length<=1)return t;let a=new Map;for(let e of t){if(e.amount<=0)continue;let s=(Math.round(e.price/n)*n).toFixed(4);if(a.has(s)){let r=a.get(s),i=r.amount+e.amount,p=(r.price*r.amount+e.price*e.amount)/i;r.amount=i,r.price=p,r.monthIdx=Math.min(r.monthIdx,e.monthIdx)}else a.set(s,{...e})}return Array.from(a.values()).sort((e,o)=>e.monthIdx-o.monthIdx)}function nn(t,n,a,e,o,s,r=0,i=!0,p=.7){let m=0,l=e,f=r,v=0,g=0;for(;t>.01&&n.length;){let _=i?0:n.length-1,d=n[_],w=a-d.price,x=Math.max(0,o-l),y;if(w>0){let D=w*p,j=Math.min(D>0?f/D:Number.POSITIVE_INFINITY,d.amount),U=Math.min(D>0?x/D:Number.POSITIVE_INFINITY,d.amount-j),V=j+U,it=t/a;if(it<=V)y=it;else{let xt=V*a,E=t-xt,S=D*s,c=a-S;if(c<=0)break;let u=E/c;y=V+u}}else y=t/a;let R=Math.min(y,d.amount);v+=R*a;let h=R*w*p;g+=h;let P=0;if(h>0){let D=Math.min(h,f);f-=D;let j=h-D,U=Math.max(0,o-l),V=Math.min(j,U);l+=V,P=(j-V)*s}else h<0&&(f+=Math.abs(h));let k=R*a-P;t-=k,m+=P,y>=d.amount?i?n.shift():n.pop():d.amount-=R}return{remaining:t,taxPaid:m,yearlyUsedFreibetrag:l,lossPot:f,grossProceeds:v,taxableGainTotal:g}}function Xa(t,n,a,e,o,s,r=0,i=!0,p=.7){let m=0,l=e,f=r,v=t,g=0;for(;v>.01&&n.length;){let d=i?0:n.length-1,w=n[d],x=a-w.price,y=v/a,R=Math.min(y,w.amount),T=R*a,P=R*x*p,k=0;if(P>0){let j=Math.min(P,f);f-=j;let U=P-j,V=Math.max(0,o-l),it=Math.min(U,V);l+=it,k=(U-it)*s}else P<0&&(f+=Math.abs(P));let D=T-k;g+=D,m+=k,v-=T,y>=w.amount?i?n.shift():n.pop():w.amount-=R}let _=v>.01?v:0;return{netProceeds:g,taxPaid:m,yearlyUsedFreibetrag:l,lossPot:f,shortfall:_}}function en(t,n,a,e,o,s,r,i=0,p=!0,m=.7){if(t<=0)return{savings:n,yearlyUsedFreibetrag:o,lossPot:i,taxPaidOriginal:0,saleTax:0,totalTaxRecorded:0,shortfall:0};let l=t,f=i,v=Math.min(n,l);n-=v,l-=v;let g=0;if(l>.01&&a.length){let x=nn(l,a,e,o,s,r,f,p,m);l=x.remaining,g=x.taxPaid,o=x.yearlyUsedFreibetrag,f=x.lossPot}l=Math.max(0,l);let _=t-l,d=l>.01?l:0,w=_+g;return{savings:n,yearlyUsedFreibetrag:o,lossPot:f,taxPaidOriginal:_,saleTax:g,totalTaxRecorded:w,shortfall:d}}function Za(t,n,a,e){let o=ue[t];if(!o||!o.returns)return null;let s=n-a;if(s<=0)return null;let r=Math.floor((s-1)/12);if(r<o.returns.length){let i=o.returns[r];return Math.pow(1+i,1/12)}return null}function an(t,n=0,a={}){let{start_savings:e,start_etf:o,start_etf_cost_basis:s=0,monthly_savings:r,monthly_etf:i,savings_rate_pa:p,etf_rate_pa:m,etf_ter_pa:l=0,savings_target:f,annual_raise_percent:v,savings_years:g,withdrawal_years:_,monthly_payout_net:d,monthly_payout_percent:w,withdrawal_min:x=0,withdrawal_max:y=0,inflation_adjust_withdrawal:R=!0,special_payout_net_savings:T,special_interval_years_savings:h,inflation_adjust_special_savings:P=!0,special_payout_net_withdrawal:k,special_interval_years_withdrawal:D,inflation_adjust_special_withdrawal:j=!0,inflation_rate_pa:U=0,sparerpauschbetrag:V=Ut,kirchensteuer:it="keine",basiszins:xt=2.53,use_lifo:E=!1,rent_is_gross:S=!1,capital_preservation_enabled:c=!1,capital_preservation_threshold:u=80,capital_preservation_reduction:L=25,capital_preservation_recovery:G=10,loss_pot:_t=0,fondstyp:Wt="aktien"}=t,{stressScenario:Ht="none",startYear:ya=new Date().getFullYear()}=a,hn=n>0,va=Ht&&Ht!=="none",Se=hn?qa(n/100):0,Ft=Fe[Wt]||Fe.aktien,xe=0;it==="8"?xe=Oe:it==="9"&&(xe=Ne);let yt=Ja(xe),Rt=[],F=e,q=Tn,Z=[];if(o>0){let H=o/q,ft=(s>0?s:o)/H;Z.push({amount:H,price:ft,monthIdx:0})}let wa=m-l,pn=tn(p),Re=tn(wa),ba=tn(U),Ea=v/100,Sa=(g+_)*X,fn=g*X,Me=F>=f,nt=0,gn=0,_n=!1,zt=d,Te=w,Mt=null,oe=null,Yt=1,Ie=!1,yn=0,xa=o,Pe=q,vn=0,J=_t,Xt=0,Ra=0,Tt=0;for(let H=1;H<=Sa;H+=1){let vt=H<=fn,ft=Math.floor((H-1)/X),Zt=(H-1)%X+1,ke=0,se=0,ht=0;Yt*=1+ba;let Dt=Z.reduce((W,K)=>W+K.amount,0)*q,Q=F+Dt;if(ft!==gn){if(nt=0,vn=0,Tt>0){let W=Math.min(Tt,J);J-=W;let K=Tt-W,lt=Math.min(K,V);nt=lt;let O=Math.max(0,K-lt)*yt,$=en(O,F,Z,q,nt,V,yt,J,!E,Ft);F=$.savings,nt=$.yearlyUsedFreibetrag,J=$.lossPot,ke=$.taxPaidOriginal,vn=$.taxPaidOriginal,se+=$.totalTaxRecorded,ht+=$.shortfall}gn=ft,xa=Dt,Pe=q,Xt=0,Ra=0,Tt=0}let dt,re=va?Za(Ht,H,fn,Re):null;if(re!==null)dt=re,q*=dt;else if(hn){let K=Math.log(1+Re)-.5*Se*Se,st=Ka(0,1);dt=Math.exp(K+Se*st),q*=dt}else dt=1+Re,q*=dt;let Ta=Dt*(dt-1),ie=F*pn,Ae=0;Xt+=ie,F+=ie;let wn=0,Gt=0,bn=0,ot=0,Qt=se,wt=0,te=0,le=0,En=!1,ce=0;if(vt){let W=Math.pow(1+Ea,ft),K=r*W,st=i*W;if(Me?Gt=st+K:(F+=K,wn=K,Gt=st),F>f&&(bn=F-f,F=f,Gt+=bn,Me=!0),Gt>0){let M=Gt/q;Z.push({amount:M,price:q,monthIdx:H})}if(h>0&&H%(h*X)===0&&H>0){let M=T;if(P){let pt=H/X;M=T*Math.pow(1+U/100,pt)}let O=M;ot=O;let $=Math.max(0,F-f);if($>0){let pt=Math.min($,O);F-=pt,O-=pt}let tt=nn(O,Z,q,nt,V,yt,J,!E,Ft);if(O=tt.remaining,Qt+=tt.taxPaid,nt=tt.yearlyUsedFreibetrag,J=tt.lossPot,O>.01){let pt=Math.min(F,O);F-=pt,O-=pt,F<f&&(Me=!1)}O<0&&(F+=Math.abs(O),O=0),wt=ot-Math.max(0,O)}}else{if(Mt===null){let M=Z.reduce((O,$)=>O+$.amount,0);Mt=F+M*q,w!=null&&!_n?(zt=Mt*(w/100)/12,oe=zt,_n=!0,Te=w):zt!=null&&(oe=zt,Te=Mt>0?zt*12/Mt*100:0)}let W=zt||0;if(R&&oe!=null){let M=ft-g;W=oe*Math.pow(1+U/100,M)}if(x>0&&W<x&&(W=x),y>0&&W>y&&(W=y),c&&Mt>0){let M=Z.reduce((pt,Be)=>pt+Be.amount,0),O=F+M*q,$=Mt*(u/100),tt=Mt*((u+G)/100);O<$?Ie=!0:O>=tt&&(Ie=!1),Ie&&(W=W*(1-L/100),En=!0,yn++)}let K=W,st=0,lt=W;if(D>0&&H%(D*X)===0){if(st=k,j){let M=H/X;st=k*Math.pow(1+U/100,M)}lt+=st}if(lt>0){let M=lt;ot=lt;let O=Math.max(0,F-f);if(O>0){let $=Math.min(O,M);F-=$,M-=$,S&&(ce+=$)}if(S&&M>0){let $=Xa(M,Z,q,nt,V,yt,J,!E,Ft),tt=$.netProceeds;Qt+=$.taxPaid,nt=$.yearlyUsedFreibetrag,J=$.lossPot,M=$.shortfall,wt=ot-M,ce+=tt}else if(M>0){let $=nn(M,Z,q,nt,V,yt,J,!E,Ft);M=$.remaining,Qt+=$.taxPaid,nt=$.yearlyUsedFreibetrag,J=$.lossPot}if(M>.01){let $=Math.min(F,M);F-=$,M-=$,S&&(ce+=$)}M<0&&(F+=Math.abs(M),M=0),S||(wt=ot-Math.max(0,M))}if(ot>0&&wt<ot){let M=wt/ot;le=K*M}else le=K}let Ce=0;if(Zt===12){if(Xt>0){let st=Math.min(Xt,J);J-=st;let lt=Xt-st,M=Math.max(0,V-nt),O=Math.min(lt,M);if(nt+=O,Ae=Math.max(0,lt-O)*yt,Ae>.01){let tt=en(Ae,F,Z,q,nt,V,yt,J,!E,Ft);F=tt.savings,nt=tt.yearlyUsedFreibetrag,J=tt.lossPot,Qt+=tt.totalTaxRecorded,ht+=tt.shortfall}}let W=ya+ft,K=In(W,xt);if(K>0){let st=ft*X,lt=.7;for(let M of Z){if(M.amount<=0)continue;let O=M.monthIdx>st,$=O?M.amount*M.price:M.amount*Pe,tt=1;O&&(tt=(12-((M.monthIdx-1)%X+1)+1)/12);let pt=$*(K/100)*lt*tt,Be=M.amount*q,Aa=O?M.amount*M.price:M.amount*Pe,Ca=Math.max(0,Be-Aa),$e=Math.min(pt,Ca);$e>0&&(Ce+=$e,M.price+=$e/M.amount)}Ce>0&&(Tt=Ce*Ft)}}if(Zt===12&&Z.length>50){let W=Ha(Z);Z.length=0,Z.push(...W)}let Sn=Z.reduce((W,K)=>W+K.amount,0)*q,xn=F+Sn,Ia=vt?null:ot>0?ot:null,Pa=ot>0?Math.max(0,ot-wt):0;!vt&&ot>0?S?te=ce:te=wt:te=0;let ka=1+pn,Rn=dt;if(Q>0){let W=Dt/Q,K=1-W;Rn=W*dt+K*ka}Rt.push({month:H,year:ft+1,phase:vt?"Anspar":"Entnahme",savings:F,etf:Sn,total:xn,total_real:xn/Yt,savings_contrib:wn,etf_contrib:Gt,savings_interest:ie,withdrawal:wt,withdrawal_real:wt/Yt,withdrawal_net:te,withdrawal_net_real:te/Yt,withdrawal_requested:ot,shortfall:Pa,tax_shortfall:ht,monthly_payout:le,monthly_payout_real:le/Yt,tax_paid:Qt,vorabpauschale_tax:ke,payout_value:Ia,payout_percent_pa:vt?null:Te,return_gain:Ta+ie,etfReturn:dt,portfolioReturn:Rn,cumulative_inflation:Yt,capital_preservation_active:En||!1,yearly_used_freibetrag:nt,loss_pot:J})}if(Tt>0&&Rt.length>0){let H=Math.min(Tt,J);J-=H;let vt=Tt-H,Zt=Math.min(vt,V),se=Math.max(0,vt-Zt)*yt,ht=en(se,F,Z,q,Zt,V,yt,J,!E,Ft);F=ht.savings,J=ht.lossPot;let Dt=Z.reduce((dt,re)=>dt+re.amount,0)*q,Q=Rt[Rt.length-1];Q.savings=F,Q.etf=Dt,Q.total=Q.savings+Q.etf,Q.total_real=Q.total/Q.cumulative_inflation,Q.tax_paid+=ht.totalTaxRecorded,Q.vorabpauschale_tax=(Q.vorabpauschale_tax||0)+ht.taxPaidOriginal,Q.pending_vorabpauschale_tax=ht.taxPaidOriginal,Q.loss_pot=J,ht.shortfall>.01&&(Q.tax_shortfall=(Q.tax_shortfall||0)+ht.shortfall),F<0&&(F=0)}return Rt.length>0&&(Rt.capitalPreservationMonths=yn,Rt.capitalPreservationEnabled=c),Rt}function ta(t,n){if(!t||t.length===0)return null;let a=t[t.length-1],e=n.savings_years*X,o=Math.min(e-1,t.length-1),s=t[o],r=t.filter(y=>y.phase==="Anspar"),i=t.filter(y=>y.phase==="Entnahme"),p=(n.start_savings||0)+(n.start_etf||0)+r.reduce((y,R)=>y+(R.savings_contrib||0)+(R.etf_contrib||0),0),m=t.reduce((y,R)=>y+(R.return_gain||0),0),l=t.reduce((y,R)=>y+(R.tax_paid||0),0),f=t.reduce((y,R)=>y+(R.vorabpauschale_tax||0),0),v=0,g=0,_=0,d=0;if(i.length>0){let y=i.filter(R=>R.monthly_payout>0).map(R=>R.monthly_payout);y.length>0&&(v=y.reduce((R,T)=>R+T,0)/y.length,g=Math.min(...y),_=Math.max(...y)),d=i.reduce((R,T)=>R+(T.withdrawal||0),0)}let w=t.filter(y=>y.shortfall>0),x=w.length>0;return{endTotal:a.total,endTotalReal:a.total_real,retirementTotal:s?.total||0,retirementTotalReal:s?.total_real||0,totalInvested:p,totalReturn:m,totalTax:l,totalVorabpauschale:f,avgWithdrawal:v,minWithdrawal:g,maxWithdrawal:_,totalWithdrawals:d,hasShortfall:x,shortfallMonths:w.length,capitalPreservationMonths:t.capitalPreservationMonths||0,finalLossPot:a.loss_pot||0,cumulativeInflation:a.cumulative_inflation||1}}function ea(t,n,a){let e=(n.savings_years+n.withdrawal_years)*X,o=[],s=[],r=[],i=[],p=[],m=[],l=[],f=[],v=[],g=Array(e).fill(null).map(()=>[]),_=Array(e).fill(null).map(()=>[]);for(let c of t){let{rawData:u,samplePaths:L}=c;o.push(...u.finalTotals),s.push(...u.finalTotalsReal),r.push(...u.finalLossPot),i.push(...u.finalYearlyFreibetrag),p.push(...u.retirementTotals),m.push(...u.retirementTotalsReal),l.push(...u.simResults),f.push(...u.sorrData),v.length<50&&v.push(...L.slice(0,50-v.length));for(let G=0;G<e&&G<u.monthlyTotals.length;G++)g[G].push(...u.monthlyTotals[G]),_[G].push(...u.monthlyTotalsReal[G])}let d=o.length;o.sort((c,u)=>c-u),s.sort((c,u)=>c-u),r.sort((c,u)=>c-u),i.sort((c,u)=>c-u),p.sort((c,u)=>c-u),m.sort((c,u)=>c-u);let w=0,x=0,y=0,R=0,T=0,h=0,P=0,k=[];for(let c of l)c.hasPositiveEnd&&!c.hasEntnahmeShortfall&&!c.isRuin&&w++,c.hasPositiveEnd&&!c.isRuin&&x++,c.isRuin&&y++,c.capitalPreserved&&R++,c.capitalPreservedReal&&T++,c.hasAnsparShortfall&&h++,c.hasEntnahmeShortfall&&P++,c.firstFillMonth!==null&&k.push(c.firstFillMonth/12);k.sort((c,u)=>c-u);let D=[],j={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]},U={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]};for(let c=0;c<e;c++){D.push(c+1);let u=g[c].sort((G,_t)=>G-_t),L=_[c].sort((G,_t)=>G-_t);j.p5.push(C(u,5)),j.p10.push(C(u,10)),j.p25.push(C(u,25)),j.p50.push(C(u,50)),j.p75.push(C(u,75)),j.p90.push(C(u,90)),j.p95.push(C(u,95)),U.p5.push(C(L,5)),U.p10.push(C(L,10)),U.p25.push(C(L,25)),U.p50.push(C(L,50)),U.p75.push(C(L,75)),U.p90.push(C(L,90)),U.p95.push(C(L,95))}let V=Qa(f),it=l.map(c=>c.avgWithdrawalNet).filter(c=>c>0).sort((c,u)=>c-u),xt=l.map(c=>c.avgWithdrawalNetReal).filter(c=>c>0).sort((c,u)=>c-u),E=l.map(c=>c.totalWithdrawalGross).filter(c=>c>0).sort((c,u)=>c-u),S=l.map(c=>c.totalWithdrawalGrossReal).filter(c=>c>0).sort((c,u)=>c-u);return{iterations:d,months:D,percentiles:j,percentilesReal:U,savingsYears:n.savings_years,medianEnd:C(o,50),meanEnd:o.reduce((c,u)=>c+u,0)/d,p5End:C(o,5),p10End:C(o,10),p25End:C(o,25),p75End:C(o,75),p90End:C(o,90),p95End:C(o,95),medianEndReal:C(s,50),meanEndReal:s.reduce((c,u)=>c+u,0)/d,p5EndReal:C(s,5),p10EndReal:C(s,10),p25EndReal:C(s,25),p75EndReal:C(s,75),p90EndReal:C(s,90),p95EndReal:C(s,95),retirementMedian:C(p,50),retirementMedianReal:C(m,50),medianAvgWithdrawalNet:it.length>0?C(it,50):0,medianAvgWithdrawalNetReal:xt.length>0?C(xt,50):0,medianTotalWithdrawalGross:E.length>0?C(E,50):0,medianTotalWithdrawalGrossReal:S.length>0?C(S,50):0,successRate:w/d*100,softSuccessRate:x/d*100,ruinProbability:y/d*100,capitalPreservationRate:R/d*100,capitalPreservationRateReal:T/d*100,ansparShortfallRate:h/d*100,entnahmeShortfallRate:P/d*100,emergencyFillProbability:k.length/d*100,emergencyNeverFillProbability:(d-k.length)/d*100,emergencyMedianFillYears:k.length>0?C(k,50):null,medianFinalLossPot:C(r,50),medianFinalYearlyFreibetrag:C(i,50),sorr:V,allHistories:v,mcOptions:a}}function Qa(t){if(t.length<10)return{sorRiskScore:0,earlyBadImpact:0,earlyGoodImpact:0,correlationEarlyReturns:0,worstSequenceEnd:0,bestSequenceEnd:0,vulnerabilityWindow:5};t.sort((T,h)=>T.earlyReturn-h.earlyReturn);let n=Math.floor(t.length/5),a=t.slice(0,n),e=t.slice(-n),o=t.reduce((T,h)=>T+h.endWealth,0)/t.length,s=a.reduce((T,h)=>T+h.endWealth,0)/a.length,r=e.reduce((T,h)=>T+h.endWealth,0)/e.length,i=t.reduce((T,h)=>T+h.startWealth,0)/t.length,p=i>0?(o-s)/i*100:0,m=i>0?(r-o)/i*100:0,l=p+m,f=t.length,v=t.reduce((T,h)=>T+h.earlyReturn,0),g=t.reduce((T,h)=>T+h.endWealth,0),_=t.reduce((T,h)=>T+h.earlyReturn*h.endWealth,0),d=t.reduce((T,h)=>T+h.earlyReturn*h.earlyReturn,0),w=t.reduce((T,h)=>T+h.endWealth*h.endWealth,0),x=f*_-v*g,y=Math.sqrt((f*d-v*v)*(f*w-g*g)),R=y>0?x/y:0;return{sorRiskScore:Math.abs(l),earlyBadImpact:p,earlyGoodImpact:m,correlationEarlyReturns:R,worstSequenceEnd:s,bestSequenceEnd:r,vulnerabilityWindow:5}}var ge=new Intl.NumberFormat("de-DE",{maximumFractionDigits:0}),ct=new Intl.NumberFormat("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1});function na(t,n){if(!t)return"";let a=n.savings_years+n.withdrawal_years,e=t.successRate||0,o=t.ruinProbability||0,s=t.medianEndReal||0,r=t.retirementMedian||0,i=t.emergencyFillProbability||0,p=t.emergencyMedianFillYears,m=[];return e>=95?m.push(`<strong>Sehr gute Aussichten:</strong> In ${ct.format(e)}% der ${ge.format(t.iterations)} Simulationen war dein Geld nach ${a} Jahren noch nicht aufgebraucht.`):e>=80?m.push(`<strong>Gute Aussichten:</strong> In ${ct.format(e)}% der Simulationen reichte dein Verm\xF6gen \xFCber die gesamte Laufzeit von ${a} Jahren.`):e>=50?m.push(`<strong>Erh\xF6htes Risiko:</strong> Nur in ${ct.format(e)}% der Simulationen war dein Geld nach ${a} Jahren noch vorhanden. Erw\xE4ge eine niedrigere Entnahmerate oder l\xE4ngere Ansparphase.`):m.push(`<strong>Hohes Risiko:</strong> In nur ${ct.format(e)}% der Simulationen blieb Verm\xF6gen \xFCbrig. Diese Strategie ist sehr riskant.`),o>0&&(o<5?m.push(`Das Risiko, w\xE4hrend der Entnahmephase in finanzielle Schwierigkeiten zu geraten, liegt bei nur ${ct.format(o)}%.`):o<15?m.push(`Das Pleite-Risiko betr\xE4gt ${ct.format(o)}% \u2013 moderate Vorsicht ist geboten.`):m.push(`<strong>Achtung:</strong> Das Risiko eines Verm\xF6gensausfalls liegt bei ${ct.format(o)}%.`)),r>0&&m.push(`Bei Rentenbeginn (nach ${n.savings_years} Jahren) hast du im Median ca. ${ge.format(r)} \u20AC angespart.`),s>0&&m.push(`Das inflationsbereinigte Median-Endverm\xF6gen betr\xE4gt ${ge.format(s)} \u20AC.`),n.savings_target>0&&(i>=95?m.push(`Dein Notgroschen-Ziel von ${ge.format(n.savings_target)} \u20AC wird in ${ct.format(i)}% der F\xE4lle erreicht${p?` (im Median nach ${ct.format(p)} Jahren)`:""}.`):i>=80?m.push(`Der Notgroschen wird in ${ct.format(i)}% der Simulationen gef\xFCllt${p?` \u2013 typischerweise nach ${ct.format(p)} Jahren`:""}.`):i>0&&m.push(`Nur in ${ct.format(i)}% der F\xE4lle erreichst du dein Notgroschen-Ziel. Erw\xE4ge eine h\xF6here TG-Sparrate.`)),t.sorr&&t.sorr.sorRiskScore>30&&m.push(`<strong>Sequence-of-Returns-Risiko:</strong> Fr\xFChe Crashs in der Entnahmephase haben einen starken Einfluss auf dein Endverm\xF6gen (Korrelation: ${ct.format(Math.abs(t.sorr.correlationEarlyReturns*100))}%).`),m.join(" ")}var ae=[],Ct=!1;var on=null,Kt=[],to=0,aa=0;function eo(){let t=navigator.hardwareConcurrency||4;return Math.min(Math.max(2,t-1),8)}function no(t){let n=[];for(let a=0;a<t;a++){let e=new Worker("mc-worker.js");n.push({worker:e,id:a,busy:!1})}return n}function _e(){for(let{worker:t}of ae)t.terminate();ae=[]}function oa(t,n={},a=null){return new Promise((e,o)=>{if(Ct){o(new Error("Simulation l\xE4uft bereits"));return}Ct=!0,on=a,Kt=[],aa=0;let s=Math.min(n.iterations||De,Pn),r=n.volatility||15,i=n.seed||Date.now();to=s;let p={successThreshold:n.successThreshold||100,ruinThresholdPercent:n.ruinThresholdPercent||10,seed:i,stressScenario:n.stressScenario||"none"},m=eo();ae=no(m);let l=[],f=s,v=0;for(;f>0;){let x=Math.min(kn,f);l.push({startIdx:v,count:x}),v+=x,f-=x}let g=0,_=!1;function d(x){if(_||g>=l.length)return;let y=l[g++];x.busy=!0,x.worker.postMessage({type:"run-chunk",params:t,volatility:r,mcOptions:p,startIdx:y.startIdx,count:y.count,totalIterations:s,workerId:x.id,baseSeed:i})}for(let x of ae)x.worker.onmessage=y=>{let{type:R}=y.data;if(R==="chunk-progress"){let{completedInChunk:T}=y.data;if(on){let h=Kt.reduce((P,k)=>P+k.rawData.finalTotals.length,0);on({current:h+T,total:s,percent:Math.round((h+T)/s*100)})}}else if(R==="chunk-complete"){let{rawData:T,samplePaths:h}=y.data;Kt.push({rawData:T,samplePaths:h}),x.busy=!1,aa+=T.finalTotals.length,g<l.length?d(x):Kt.length===l.length&&w()}else R==="error"&&(_=!0,Ct=!1,_e(),o(new Error(y.data.message)))},x.worker.onerror=y=>{_=!0,Ct=!1,_e(),o(new Error(y.message||"Worker-Fehler"))};function w(){Ct=!1,_e();let x=ea(Kt,t,p);x.volatility=r,x.iterations=s,e(x)}for(let x of ae)g<l.length&&d(x)})}function sa(){Ct&&(Ct=!1,_e(),Kt=[])}function ra(){return Ct}var Nt=null,Bt=!1,ca=!1;function ao(){return Nt&&Nt.terminate(),Nt=new Worker("optimizer-worker.js"),Nt}function ye(){Nt&&(Nt.terminate(),Nt=null)}function oo(t="A",n={}){return new Promise((a,e)=>{if(Bt){e(new Error("Optimierung l\xE4uft bereits"));return}Bt=!0,ca=!1;let o=Ot(),s=Pt(o),r=he(o),i={maxBudget:(o.monthly_savings||0)+(o.monthly_etf||0),tgStep:n.tgStep||50,rentStep:n.rentStep||50,rentStepPercent:n.rentStepPercent||.25,rentRange:n.rentRange||.5,maxCombinations:n.maxCombinations||60,targetSuccess:n.targetSuccess||90,emergencyWeight:n.emergencyWeight||4e3,emergencyMaxYears:n.emergencyMaxYears||10},p=r.seed||Date.now(),m=ao();m.onmessage=l=>{let{type:f}=l.data;f==="progress"?so(l.data.current,l.data.total,l.data.percent,l.data.currentCandidate):f==="complete"?(Bt=!1,ye(),l.data.best?a(l.data.best):e(new Error(l.data.message||"Keine g\xFCltige Konfiguration gefunden"))):f==="error"&&(Bt=!1,ye(),e(new Error(l.data.message)))},m.onerror=l=>{Bt=!1,ye(),e(new Error(l.message||"Worker-Fehler"))},m.postMessage({type:"start",params:s,mcOptions:{iterations:Math.min(r.iterations,1e3),volatility:r.volatility,seed:p,successThreshold:r.successThreshold,ruinThresholdPercent:r.ruinThresholdPercent},mode:t,gridConfig:i,seedBase:p})})}function ia(){if(!Bt)return;ca=!0,Bt=!1,ye();let t=document.getElementById("optimization-progress"),n=document.getElementById("optimize-progress-bar"),a=document.getElementById("optimize-progress-text");t&&(t.style.display="none"),n&&(n.value=0),a&&(a.textContent="")}function so(t,n,a,e){let o=document.getElementById("optimization-progress"),s=document.getElementById("optimize-progress-bar"),r=document.getElementById("optimize-progress-text");if(o&&(o.style.display="block"),s&&(s.value=a),r){let i=`${t}/${n} (${a}%)`;e&&(e.rent_mode==="percent"&&e.monthly_payout_percent?i+=` - TG: ${e.monthly_savings}\u20AC, ETF: ${e.monthly_etf}\u20AC, Entnahme: ${e.monthly_payout_percent}%`:i+=` - TG: ${e.monthly_savings}\u20AC, ETF: ${e.monthly_etf}\u20AC, Rente: ${e.monthly_payout_net}\u20AC`),r.textContent=i}}function ro(t){let n=document.getElementById("optimization-result-panel"),a=document.getElementById("optimization-progress"),e=document.getElementById("optimization-error");a&&(a.style.display="none"),e&&(e.style.display="none"),n&&(n.style.display="block"),rt("opt-monthly-savings",b(t.params.monthly_savings||0)),rt("opt-monthly-etf",b(t.params.monthly_etf||0)),t.params.rent_mode==="percent"&&t.params.monthly_payout_percent?rt("opt-rent-eur",`${t.params.monthly_payout_percent}% p.a.`):rt("opt-rent-eur",b(t.params.monthly_payout_net||0));let o=(t.params.monthly_savings||0)+(t.params.monthly_etf||0);rt("opt-total-budget",b(o)),rt("opt-success-rate",et(t.results.successRate)),rt("opt-ruin-probability",et(t.results.ruinProbability)),rt("opt-median-end-real",b(t.results.medianEndReal||0)),rt("opt-retirement-median",b(t.results.retirementMedian||0)),rt("opt-capital-preservation",et(t.results.capitalPreservationRateReal||t.results.capitalPreservationRate)),t.results.p10EndReal!=null&&t.results.p90EndReal!=null&&rt("opt-range-end",`${b(t.results.p10EndReal)} \u2013 ${b(t.results.p90EndReal)}`),rt("opt-emergency-fill-prob",et(t.results.emergencyFillProbability||0)),t.results.emergencyMedianFillYears!=null?rt("opt-emergency-fill-years",`${t.results.emergencyMedianFillYears.toFixed(1)} Jahre`):rt("opt-emergency-fill-years","\u2013")}function io(t){let n=document.getElementById("optimization-result-panel"),a=document.getElementById("optimization-progress"),e=document.getElementById("optimization-error"),o=document.getElementById("optimization-error-text");a&&(a.style.display="none"),n&&(n.style.display="none"),e&&(e.style.display="block"),o&&(o.textContent=t)}function rt(t,n){let a=document.getElementById(t);a&&(a.textContent=n)}function la(t){if(!t?.params)return;let n={monthly_savings:t.params.monthly_savings,monthly_etf:t.params.monthly_etf};t.params.rent_mode==="percent"&&t.params.monthly_payout_percent?(n.monthly_payout_percent=t.params.monthly_payout_percent,n.rent_mode="percent"):t.params.monthly_payout_net&&(n.monthly_payout_net=t.params.monthly_payout_net,n.rent_mode="eur"),qt(mt(),n),gt(z()),Y("Optimierte Werte \xFCbernommen.")}function da(t){let n=document.getElementById("btn-optimize"),a=document.getElementById("btn-cancel-optimize"),e=document.getElementById("btn-apply-optimization"),o=document.getElementById("btn-apply-and-run"),s=document.getElementById("optimization-results"),r=null;n&&(n.disabled=!1,n.title="Parameter optimieren",n.addEventListener("click",async()=>{if(Bt){ia(),n.textContent="Parameter optimieren";return}n.textContent="Abbrechen",s&&(s.style.display="block");let i=document.getElementById("optimization-progress"),p=document.getElementById("optimization-result-panel"),m=document.getElementById("optimization-error");i&&(i.style.display="block"),p&&(p.style.display="none"),m&&(m.style.display="none");try{let l=await oo("A");r=l,ro(l),Y("Optimierung abgeschlossen.","success")}catch(l){io(l.message),Y(`Optimierung fehlgeschlagen: ${l.message}`,"error")}finally{n.textContent="Parameter optimieren"}})),a&&a.addEventListener("click",()=>{ia(),n&&(n.textContent="Parameter optimieren"),Y("Optimierung abgebrochen.")}),e&&e.addEventListener("click",()=>{r&&la(r)}),o&&o.addEventListener("click",()=>{r&&(la(r),t?.())})}var N=new Intl.NumberFormat("de-DE",{maximumFractionDigits:0}),B=new Intl.NumberFormat("de-DE",{minimumFractionDigits:2,maximumFractionDigits:2});function sn(t,n=!1){let a=Pt(t),e=new Date().toISOString(),o=`# ETF Sparplan Simulator v${me}
`;return o+=`# Exportiert: ${e}
`,o+=`# Szenario: ${t.name}
`,o+=`#
`,o+=`# Parameter:
`,o+=`# - Ansparphase: ${a.savings_years} Jahre
`,o+=`# - Entnahmephase: ${a.withdrawal_years} Jahre
`,o+=`# - Startkapital TG: ${N.format(a.start_savings)} \u20AC
`,o+=`# - Startkapital ETF: ${N.format(a.start_etf)} \u20AC
`,o+=`# - Monatl. Sparen TG: ${N.format(a.monthly_savings)} \u20AC
`,o+=`# - Monatl. Sparen ETF: ${N.format(a.monthly_etf)} \u20AC
`,o+=`# - TG-Zins p.a.: ${B.format(a.savings_rate_pa)}%
`,o+=`# - ETF-Rendite p.a.: ${B.format(a.etf_rate_pa)}%
`,o+=`# - Inflation p.a.: ${B.format(a.inflation_rate_pa)}%
`,n&&(o+=`# - MC-Iterationen: ${t.mc_iterations}
`,o+=`# - Volatilit\xE4t: ${B.format(t.mc_volatility)}%
`),o+=`#
`,o}function rn(t,n){if(!t?.length)throw new Error("Keine Simulationsdaten vorhanden");let a=sn(n||z()),e=["Monat","Jahr","Phase","Tagesgeld","ETF","Gesamt","Gesamt (real)","Einzahlung TG","Einzahlung ETF","TG-Zinsen","Entnahme (brutto)","Entnahme (netto)","Steuern","Vorabpauschale","Fehlbetrag","Inflation (kumuliert)"],o=a;o+=e.join(";")+`
`;for(let s of t){let r=[s.month,s.year,s.phase,B.format(s.savings),B.format(s.etf),B.format(s.total),B.format(s.total_real),B.format(s.savings_contrib||0),B.format(s.etf_contrib||0),B.format(s.savings_interest||0),B.format(s.withdrawal||0),B.format(s.withdrawal_net||0),B.format(s.tax_paid||0),B.format(s.vorabpauschale_tax||0),B.format(s.shortfall||0),B.format(s.cumulative_inflation||1)];o+=r.join(";")+`
`}dn(o,`etf_simulation_${cn()}.csv`)}function ma(t,n){if(!t?.length)throw new Error("Keine Simulationsdaten vorhanden");let a=sn(n||z()),e=ha(t),o=["Jahr","Phase","Tagesgeld (Jahresende)","ETF (Jahresende)","Gesamt","Gesamt (real)","Einzahlungen","Rendite","Entnahmen (gesamt)","Steuern (gesamt)"],s=a;s+=o.join(";")+`
`;for(let r of e){let i=[r.year,r.phase,B.format(r.savings),B.format(r.etf),B.format(r.total),B.format(r.total_real),B.format(r.deposits),B.format(r.returns),B.format(r.withdrawals),B.format(r.taxes)];s+=i.join(";")+`
`}dn(s,`etf_simulation_jahresuebersicht_${cn()}.csv`)}function ua(t,n){if(!t)throw new Error("Keine Monte-Carlo-Ergebnisse vorhanden");let e=sn(n||z(),!0);e+=`# ZUSAMMENFASSUNG
`,e+=`Iterationen;${t.iterations}
`,e+=`Volatilit\xE4t;${B.format(t.volatility)}%
`,e+=`Erfolgsrate;${B.format(t.successRate)}%
`,e+=`Ruinwahrscheinlichkeit;${B.format(t.ruinProbability)}%
`,e+=`Kapitalerhalt-Rate;${B.format(t.capitalPreservationRate)}%
`,e+=`
`,e+=`Median Endverm\xF6gen;${N.format(t.medianEnd)} \u20AC
`,e+=`Median Endverm\xF6gen (real);${N.format(t.medianEndReal)} \u20AC
`,e+=`5. Perzentil;${N.format(t.p5End)} \u20AC
`,e+=`95. Perzentil;${N.format(t.p95End)} \u20AC
`,e+=`
`,t.sorr&&(e+=`# SEQUENCE-OF-RETURNS-RISIKO
`,e+=`SoRR-Score;${B.format(t.sorr.sorRiskScore)}
`,e+=`Korrelation fr\xFChe Renditen;${B.format(t.sorr.correlationEarlyReturns)}
`,e+=`Worst Sequence Endverm\xF6gen;${N.format(t.sorr.worstSequenceEnd)} \u20AC
`,e+=`Best Sequence Endverm\xF6gen;${N.format(t.sorr.bestSequenceEnd)} \u20AC
`,e+=`
`),e+=`# PERZENTILE PRO MONAT
`,e+=`Monat;P5;P10;P25;Median;P75;P90;P95
`;for(let o=0;o<t.months.length;o++){let s=t.percentiles;e+=[t.months[o],N.format(s.p5[o]),N.format(s.p10[o]),N.format(s.p25[o]),N.format(s.p50[o]),N.format(s.p75[o]),N.format(s.p90[o]),N.format(s.p95[o])].join(";")+`
`}dn(e,`etf_monte_carlo_${cn()}.csv`)}function lo(t,n,a){let e=a||z(),o=Pt(e),s=new Date().toLocaleString("de-DE"),r=t?ha(t):[],i="";for(let l of r)i+=`
      <tr>
        <td>${l.year}</td>
        <td>${l.phase}</td>
        <td>${N.format(l.total)} \u20AC</td>
        <td>${N.format(l.total_real)} \u20AC</td>
        <td>${N.format(l.deposits)} \u20AC</td>
        <td>${N.format(l.withdrawals)} \u20AC</td>
      </tr>
    `;let p="";return n&&(p=`
      <div class="report-section">
        <h2>Monte-Carlo-Analyse</h2>
        <table class="report-table">
          <tr><td>Iterationen</td><td>${n.iterations}</td></tr>
          <tr><td>Volatilit\xE4t</td><td>${B.format(n.volatility)}%</td></tr>
          <tr><td>Erfolgsrate</td><td>${B.format(n.successRate)}%</td></tr>
          <tr><td>Ruinwahrscheinlichkeit</td><td>${B.format(n.ruinProbability)}%</td></tr>
          <tr><td>Median Endverm\xF6gen</td><td>${N.format(n.medianEnd)} \u20AC</td></tr>
          <tr><td>5. Perzentil</td><td>${N.format(n.p5End)} \u20AC</td></tr>
          <tr><td>95. Perzentil</td><td>${N.format(n.p95End)} \u20AC</td></tr>
        </table>
      </div>
    `),`
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>ETF Simulator Report - ${e.name}</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      color: #1a1a2e;
    }
    h1 { color: #f59e0b; border-bottom: 2px solid #f59e0b; padding-bottom: 10px; }
    h2 { color: #3b82f6; margin-top: 30px; }
    .report-header { display: flex; justify-content: space-between; align-items: center; }
    .report-date { color: #666; font-size: 14px; }
    .report-section { margin: 20px 0; }
    .report-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .report-card {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #3b82f6;
    }
    .report-card h3 { margin: 0 0 10px 0; color: #333; font-size: 14px; }
    .report-card .value { font-size: 24px; font-weight: bold; color: #1a1a2e; }
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    .report-table th, .report-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    .report-table th { background: #f0f0f0; }
    .report-table tr:hover { background: #f8f9fa; }
    @media print {
      body { padding: 0; }
      .report-section { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="report-header">
    <h1>ETF Sparplan Simulator Report</h1>
    <span class="report-date">Erstellt: ${s}</span>
  </div>
  
  <div class="report-section">
    <h2>Szenario: ${e.name}</h2>
    <div class="report-grid">
      <div class="report-card">
        <h3>Ansparphase</h3>
        <div class="value">${o.savings_years} Jahre</div>
      </div>
      <div class="report-card">
        <h3>Entnahmephase</h3>
        <div class="value">${o.withdrawal_years} Jahre</div>
      </div>
      <div class="report-card">
        <h3>Monatliche Sparrate</h3>
        <div class="value">${N.format(o.monthly_savings+o.monthly_etf)} \u20AC</div>
      </div>
      <div class="report-card">
        <h3>ETF-Rendite p.a.</h3>
        <div class="value">${B.format(o.etf_rate_pa)}%</div>
      </div>
    </div>
  </div>
  
  <div class="report-section">
    <h2>Parameter</h2>
    <table class="report-table">
      <tr><td>Startkapital Tagesgeld</td><td>${N.format(o.start_savings)} \u20AC</td></tr>
      <tr><td>Startkapital ETF</td><td>${N.format(o.start_etf)} \u20AC</td></tr>
      <tr><td>Tagesgeld-Zins p.a.</td><td>${B.format(o.savings_rate_pa)}%</td></tr>
      <tr><td>ETF TER</td><td>${B.format(o.etf_ter_pa)}%</td></tr>
      <tr><td>Inflation p.a.</td><td>${B.format(o.inflation_rate_pa)}%</td></tr>
      <tr><td>Sparerpauschbetrag</td><td>${N.format(o.sparerpauschbetrag)} \u20AC</td></tr>
    </table>
  </div>
  
  ${p}
  
  <div class="report-section">
    <h2>Jahres\xFCbersicht</h2>
    <table class="report-table">
      <thead>
        <tr>
          <th>Jahr</th>
          <th>Phase</th>
          <th>Gesamt</th>
          <th>Gesamt (real)</th>
          <th>Einzahlungen</th>
          <th>Entnahmen</th>
        </tr>
      </thead>
      <tbody>
        ${i}
      </tbody>
    </table>
  </div>
</body>
</html>
  `}function ln(t,n,a){let e=lo(t,n,a),o=new Blob([e],{type:"text/html"}),s=URL.createObjectURL(o),r=window.open(s,"_blank");r&&(r.onload=()=>{setTimeout(()=>r.print(),500)})}function ha(t){let n={};for(let a of t){n[a.year]||(n[a.year]={year:a.year,phase:a.phase,savings:0,etf:0,total:0,total_real:0,deposits:0,returns:0,withdrawals:0,taxes:0});let e=n[a.year];e.savings=a.savings,e.etf=a.etf,e.total=a.total,e.total_real=a.total_real,e.deposits+=(a.savings_contrib||0)+(a.etf_contrib||0),e.returns+=a.return_gain||0,e.withdrawals+=a.withdrawal||0,e.taxes+=a.tax_paid||0,e.phase=a.phase}return Object.values(n).sort((a,e)=>a.year-e.year)}function cn(){let t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-${String(t.getDate()).padStart(2,"0")}`}function dn(t,n){let e=new Blob(["\uFEFF"+t],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(e),s=document.createElement("a");s.href=o,s.download=n,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)}var ut=null,at=null,ve=!1,$t=!0,St=!1;function we(){let t=Ot(),n=Pt(t),a=mt(),e=t.stress_scenario||"none";try{let o=an(n,0,{stressScenario:e});ut=o,Fn(a,o),fe(o,{logScale:ve}),co(o,n),mo(o),Y("Simulation abgeschlossen.","success"),Ee("standard")}catch(o){console.error("Simulation error:",o),Y(`Fehler: ${o.message}`,"error")}}async function be(){if(ra()){sa(),mn(!1);return}let t=Ot(),n=Pt(t),a=he(t),e=typeof navigator<"u"&&navigator.hardwareConcurrency?navigator.hardwareConcurrency:4,o=Math.min(Math.max(2,e-1),8),s=ho({minSamples:3,minElapsedMs:1500,alpha:.3}),r=!1;mn(!0),pa(0),Y("Monte-Carlo-Simulation l\xE4uft...","info"),Ee("monte-carlo"),fa(),window.scrollTo({top:0,behavior:"smooth"});try{let i=await oa(n,{iterations:a.iterations,volatility:a.volatility,seed:a.seed,successThreshold:a.successThreshold,ruinThresholdPercent:a.ruinThresholdPercent},l=>{if(!l)return;!r&&typeof l.total=="number"&&l.total>0&&(s.start(l.total),r=!0),r&&typeof l.current=="number"&&s.update(l.current),pa(l.percent);let f=document.getElementById("mc-progress-text");if(f&&typeof l.current=="number"&&typeof l.total=="number"){let v=s.getEta(),g=v&&v.formatted?`, ETA ${v.formatted}`:"",_=Math.round(l.percent||0);f.textContent=`${l.current} / ${l.total} (${_}%) - ${o} Worker${g}`}});at=i,Ln(mt(),i);let p=document.getElementById("mc_show_individual")?.checked??!1,m=z();At(i,{showReal:St,logScale:$t,showIndividualPaths:p,savingsYears:m?.savings_years}),_a(i,n),Xn(ut,i),Y(`Monte-Carlo abgeschlossen: ${i.iterations} Simulationen`,"success"),Ee("monte-carlo"),fa()}catch(i){console.error("MC error:",i),Y(`Monte-Carlo Fehler: ${i.message}`,"error")}finally{s.stop(),mn(!1),uo()}}function co(t,n){if(!t?.length)return;let a=ta(t,n),e=t[t.length-1],o=n.savings_years*12,s=t[Math.min(o-1,t.length-1)];A("stat-end-nominal",b(e.total)),A("stat-end-real",b(e.total_real)),A("stat-retirement-wealth-nominal",b(s?.total||0)),A("stat-total-invested",b(a.totalInvested)),A("stat-total-return",b(a.totalReturn)),A("stat-total-tax",b(a.totalTax)),a.avgWithdrawal>0&&(A("stat-avg-withdrawal",b(a.avgWithdrawal)),A("stat-total-withdrawals",b(a.totalWithdrawals))),a.hasShortfall&&Y(`Warnung: In ${a.shortfallMonths} Monaten konnte die gew\xFCnschte Entnahme nicht vollst\xE4ndig bedient werden.`,"warning")}function _a(t,n=null){if(!t)return;if(n){let d=na(t,n),w=document.getElementById("mc-summary-text");w&&(w.innerHTML=d)}let a=t.successRate||0,e=t.softSuccessRate??a;A("mc-success-rate",et(a)),A("mc-success-rate-soft",et(e));let o=document.getElementById("mc-success-rate"),s=document.getElementById("mc-success-rate-soft"),r=(d,w)=>{d&&(d.classList.remove("success-high","success-medium","success-low"),w>=95?d.classList.add("success-high"):w>=80?d.classList.add("success-medium"):d.classList.add("success-low"))};r(o,a),r(s,e);let i=document.getElementById("mc-iterations-done");i&&(i.textContent=t.iterations),A("mc-median-end",b(t.medianEnd)),A("mc-range-end",`${b(t.p10End)} \u2013 ${b(t.p90End)}`),A("mc-worst-case",b(t.p25End)),A("mc-best-case",b(t.p75End)),A("mc-mean-end",b(t.meanEnd||t.medianEnd)),A("mc-median-end-real",b(t.medianEndReal)),A("mc-range-end-real",`${b(t.p10EndReal||t.p10End)} \u2013 ${b(t.p90EndReal||t.p90End)}`),A("mc-worst-case-real",b(t.p25EndReal||t.p25End)),A("mc-best-case-real",b(t.p75EndReal||t.p75End));let p=t.medianAvgWithdrawalNet??t.medianAvgWithdrawalNetReal??0,m=t.medianTotalWithdrawalNet??t.medianTotalWithdrawalGross??0;A("mc-avg-monthly-withdrawal",b(p)),A("mc-total-withdrawals",b(m)),A("mc-retirement-wealth",b(t.retirementMedian||0)),A("mc-capital-preservation",et(t.capitalPreservationRate)),A("mc-ruin-probability",et(t.ruinProbability));let l=t.entnahmeShortfallRate??t.ansparShortfallRate??0;A("mc-shortfall-rate",et(l)),A("mc-ruin-probability-real",et(t.ruinProbability)),A("mc-capital-preservation-real",et(t.capitalPreservationRateReal||t.capitalPreservationRate)),A("mc-emergency-fill-prob",et(t.emergencyFillProbability||0)),A("mc-emergency-fill-years",t.emergencyMedianFillYears!==null?`${t.emergencyMedianFillYears.toFixed(1)} Jahre`:"\u2013");let f=t.medianAvgWithdrawalNetReal??t.medianAvgWithdrawalGrossReal??0,v=t.medianTotalWithdrawalNetReal??t.medianTotalWithdrawalGrossReal??0,g=t.retirementMedianReal??0,_=Math.max(0,(t.medianEnd||0)-(t.medianEndReal||0));if(A("mc-avg-monthly-withdrawal-real",b(f)),A("mc-total-withdrawals-real",b(v)),A("mc-retirement-wealth-real",b(g)),A("mc-purchasing-power-loss",b(_)),t.sorr){let d=document.getElementById("mc-sorr-explanation-text");if(d){let w=t.sorr.vulnerabilityWindow||5;d.textContent=`Die SoRR-Auswertung betrachtet die ersten ${w} Jahre der Entnahmephase und vergleicht fr\xFChe Crash- vs. Boom-Szenarien. Hohe Werte bedeuten, dass die Reihenfolge der Renditen einen starken Einfluss auf das Endverm\xF6gen hat.`}A("mc-sorr-score",et(t.sorr.sorRiskScore||0)),A("mc-sorr-correlation",et(Math.abs(t.sorr.correlationEarlyReturns||0)*100)),A("mc-sorr-early-bad",b(t.sorr.worstSequenceEnd||0)),A("mc-sorr-early-good",b(t.sorr.bestSequenceEnd||0)),A("mc-sorr-worst-seq",b(t.sorr.worstSequenceEnd||0)),A("mc-sorr-best-seq",b(t.sorr.bestSequenceEnd||0)),A("mc-sorr-vulnerability",t.sorr.vulnerabilityWindow||"Jahr 1\u20135")}}function mo(t){let n=document.querySelector("#year-table tbody");if(!n||!t?.length)return;let a={};for(let o of t){a[o.year]||(a[o.year]={year:o.year,phase:o.phase,savings:0,etf:0,total:0,total_real:0,deposits:0,withdrawals:0,taxes:0});let s=a[o.year];s.savings=o.savings,s.etf=o.etf,s.total=o.total,s.total_real=o.total_real,s.deposits+=(o.savings_contrib||0)+(o.etf_contrib||0),s.withdrawals+=o.withdrawal||0,s.taxes+=o.tax_paid||0,s.phase=o.phase}let e="";for(let o of Object.values(a))e+=`
      <tr>
        <td>${o.year}</td>
        <td><span class="phase-badge phase-badge--${o.phase.toLowerCase()}">${o.phase}</span></td>
        <td>${b(o.savings)}</td>
        <td>${b(o.etf)}</td>
        <td>${b(o.total)}</td>
        <td>${b(o.total_real)}</td>
        <td>${b(o.deposits)}</td>
        <td>${b(o.withdrawals)}</td>
        <td>${b(o.taxes)}</td>
      </tr>
    `;n.innerHTML=e}function A(t,n){let a=document.getElementById(t);if(a){let e=a.querySelector(".stat-value")||a;e.textContent=n}}function mn(t){let n=document.getElementById("btn-monte-carlo");n&&(n.textContent=t?"Abbrechen":"Monte-Carlo starten",n.classList.toggle("btn--danger",t))}function pa(t){let n=document.getElementById("mc-progress-bar"),a=document.getElementById("mc-progress"),e=document.getElementById("mc-progress-text");n&&(n.style.display="block"),a&&(a.value=t),e&&(e.textContent=`${Math.round(t)}%`)}function uo(){let t=document.getElementById("mc-progress-bar"),n=document.getElementById("mc-progress"),a=document.getElementById("mc-progress-text");t&&(t.style.display="none"),n&&(n.value=0),a&&(a.textContent="")}function fa(){let t=document.getElementById("mc-empty-state"),n=document.getElementById("mc-results");t&&(t.style.display="none"),n&&(n.style.display="block")}function ho(t){let n=t&&typeof t.minSamples=="number"?t.minSamples:3,a=t&&typeof t.minElapsedMs=="number"?t.minElapsedMs:1500,e=t&&typeof t.alpha=="number"?t.alpha:.3,o=0,s=0,r=0,i=0,p=0,m=0,l=!1;function f(){return Date.now()}function v(g){if(!isFinite(g)||g<0)return"";if(g<1)return"< 1 s";if(g<60)return String(Math.round(g))+" s";let _=Math.floor(g/60),d=Math.round(g%60);if(_<60){let R=String(_),T=String(d).padStart(2,"0");return R+":"+T+" min"}let w=Math.floor(_/60),x=_%60,y=String(x).padStart(2,"0");return String(w)+":"+y+" h"}return{start(g){o=typeof g=="number"?g:0,s=f(),r=s,i=0,p=0,m=0,l=!1},update(g){if(l)return;let _=f();s||(s=_,r=_);let d=g-i,w=_-r;if(d<=0||w<200){i=g,r=_;return}let x=d/(w/1e3);p===0?p=x:p=e*x+(1-e)*p,i=g,r=_,m+=1},getEta(){if(l||!s||o<=0||p<=0)return{seconds:null,formatted:""};let g=f()-s;if(m<n||g<a)return{seconds:null,formatted:""};let _=Math.max(0,o-i);if(_<=0)return{seconds:0,formatted:"< 1 s"};let d=_/p;return{seconds:d,formatted:v(d)}},stop(){l=!0}}}function Ee(t){let n=document.querySelectorAll(".tab"),a=document.querySelectorAll(".tab-content");n.forEach(e=>{let o=e.dataset.tab===t;e.classList.toggle("tab--active",o),o?e.setAttribute("aria-selected","true"):e.setAttribute("aria-selected","false")}),a.forEach(e=>{let o=e.id===`tab-${t}`;e.classList.toggle("tab-content--active",o)})}function po(){let t=document.querySelector(".tabs");t&&t.addEventListener("click",n=>{let a=n.target.closest(".tab");a&&Ee(a.dataset.tab)})}function un(t){document.body.classList.toggle("theme-light",t==="light");let n=document.getElementById("theme-icon");n&&(n.textContent=t==="light"?"\u{1F319}":"\u2600\uFE0F")}function fo(){let t=document.getElementById("btn-theme-toggle");t&&t.addEventListener("click",()=>{let a=qe()==="dark"?"light":"dark";zn(a),un(a)}),un(qe())}function go(){let t=document.getElementById("btn-export-toggle"),n=document.getElementById("export-menu");t&&n&&(t.addEventListener("click",a=>{a.stopPropagation(),n.classList.toggle("active")}),document.addEventListener("click",()=>{n.classList.remove("active")})),document.getElementById("btn-export-csv")?.addEventListener("click",()=>{try{rn(ut,z()),Y("CSV exportiert.","success")}catch(a){Y(a.message,"error")}}),document.getElementById("btn-export-yearly-csv")?.addEventListener("click",()=>{try{ma(ut,z()),Y("Jahres\xFCbersicht exportiert.","success")}catch(a){Y(a.message,"error")}}),document.getElementById("btn-export-mc-csv")?.addEventListener("click",()=>{try{ua(at,z()),Y("Monte-Carlo CSV exportiert.","success")}catch(a){Y(a.message,"error")}}),document.getElementById("btn-export-pdf")?.addEventListener("click",()=>{try{ln(ut,at,z())}catch(a){Y(a.message,"error")}}),document.getElementById("btn-export-mc-pdf")?.addEventListener("click",()=>{try{ln(ut,at,z())}catch(a){Y(a.message,"error")}})}function _o(){document.getElementById("btn-info")?.addEventListener("click",()=>{document.getElementById("info-modal")?.classList.add("active")}),document.getElementById("btn-formula")?.addEventListener("click",()=>{document.getElementById("formula-modal")?.classList.add("active")}),document.querySelectorAll(".modal-close, .modal-overlay").forEach(t=>{t.addEventListener("click",n=>{let a=null;t.classList.contains("modal-close")?a=t.closest(".modal-overlay"):t.classList.contains("modal-overlay")&&n.target===t&&(a=t),a&&a.classList.remove("active")})}),document.addEventListener("keydown",t=>{t.key==="Escape"&&document.querySelectorAll(".modal-overlay.active").forEach(n=>n.classList.remove("active"))})}function yo(){let t=new ResizeObserver(()=>{if(ut&&fe(ut,{logScale:ve}),at){let e=document.getElementById("mc_show_individual")?.checked??!1;At(at,{showReal:St,logScale:$t,showIndividualPaths:e})}}),n=document.getElementById("graph"),a=document.getElementById("mc-graph");n&&t.observe(n.parentElement),a&&t.observe(a.parentElement)}function vo(){document.addEventListener("keydown",t=>{t.ctrlKey&&t.key==="Enter"&&(t.preventDefault(),we()),t.ctrlKey&&t.key==="m"&&(t.preventDefault(),be()),t.ctrlKey&&t.key==="s"&&(t.preventDefault(),ut&&rn(ut,z()))})}function wo(){let t=document.getElementById("btn-std-log"),n=document.getElementById("btn-std-linear");function a(d){ve=d,t?.classList.toggle("btn-scale--active",d),n?.classList.toggle("btn-scale--active",!d),ut&&fe(ut,{logScale:ve})}t?.addEventListener("click",()=>a(!0)),n?.addEventListener("click",()=>a(!1));let e=document.getElementById("btn-stats-nominal"),o=document.getElementById("btn-stats-real"),s=document.getElementById("stats-section-nominal"),r=document.getElementById("stats-section-real");e?.addEventListener("click",()=>{e.classList.add("stats-toggle-btn--active"),o?.classList.remove("stats-toggle-btn--active"),s?.classList.remove("stats-section--hidden"),r?.classList.add("stats-section--hidden")}),o?.addEventListener("click",()=>{o.classList.add("stats-toggle-btn--active"),e?.classList.remove("stats-toggle-btn--active"),r?.classList.remove("stats-section--hidden"),s?.classList.add("stats-section--hidden")});let i=document.getElementById("btn-mc-log"),p=document.getElementById("btn-mc-linear");function m(d){if($t=d,i?.classList.toggle("btn-scale--active",d),p?.classList.toggle("btn-scale--active",!d),at){let w=document.getElementById("mc_show_individual")?.checked??!1;At(at,{showReal:St,logScale:$t,showIndividualPaths:w})}}i?.addEventListener("click",()=>m(!0)),p?.addEventListener("click",()=>m(!1));let l=document.getElementById("btn-mc-stats-nominal"),f=document.getElementById("btn-mc-stats-real"),v=document.getElementById("mc-stats-section-nominal"),g=document.getElementById("mc-stats-section-real");l?.addEventListener("click",()=>{if(St=!1,l.classList.add("stats-toggle-btn--active"),f?.classList.remove("stats-toggle-btn--active"),v?.classList.remove("stats-section--hidden"),g?.classList.add("stats-section--hidden"),at){let d=document.getElementById("mc_show_individual")?.checked??!1;At(at,{showReal:St,logScale:$t,showIndividualPaths:d})}}),f?.addEventListener("click",()=>{if(St=!0,f.classList.add("stats-toggle-btn--active"),l?.classList.remove("stats-toggle-btn--active"),g?.classList.remove("stats-section--hidden"),v?.classList.add("stats-section--hidden"),at){let d=document.getElementById("mc_show_individual")?.checked??!1;At(at,{showReal:St,logScale:$t,showIndividualPaths:d})}});let _=document.getElementById("mc_show_individual");_?.addEventListener("change",()=>{if(!at)return;let d=_.checked;At(at,{showReal:St,logScale:$t,showIndividualPaths:d})})}function ga(){console.log("ETF Simulator v2.0 initializing..."),Dn(),Gn(),Kn(),Jn(we,be),po(),fo(),go(),_o(),Hn(),yo(),vo(),wo(),da(be),Yn((t,n)=>{if(t==="themeChanged")un(n.theme);else if(t==="activeScenarioChanged"){let a=z();gt(a);let e=On(n.id);if(e){at=e;let o=document.getElementById("mc_show_individual")?.checked??!1;At(e,{showReal:St,logScale:$t,showIndividualPaths:o}),_a(e)}}}),setTimeout(()=>{try{we()}catch(t){console.error("Initial simulation failed:",t)}},100),console.log("ETF Simulator v2.0 ready.")}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ga):ga();window.ETFSimulator={runSimulation:we,runMonteCarlo:be,getActiveScenario:z,simulate:an};})();
