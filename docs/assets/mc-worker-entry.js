const je={aktien:.7,misch:.85,renten:1},na=1e3,Ze=.08,Ke=.09,Q=12,sa=100,Xe={2025:2.53,2024:2.29,2023:2.55,2022:-.05,2021:-.45,2020:.07,2019:.52,2018:.87};function oa(t,s=2.53){return Xe[t]!==void 0?Xe[t]:s}const la={none:{name:"Standard (Zufällig)",description:"Normale Monte-Carlo-Simulation mit zufälligen Renditen",returns:null},early_crash:{name:"Früher Crash",description:"-30% im 1. Rentenjahr, langsame Erholung über 5 Jahre",returns:[-.3,-.1,.05,.08,.1,.12,.08,.07,.06,.06]},sideways:{name:"Seitwärtsmarkt",description:"0% Realrendite über 10 Jahre",returns:[.02,.01,-.01,.02,0,-.02,.03,-.01,.01,0]},bear_market:{name:"Bärenmarkt-Phase",description:"3-5 Jahre leicht negative Renditen, danach normal",returns:[-.05,-.08,-.03,-.02,.02,.08,.1,.07,.06,.06]},late_crash:{name:"Später Crash",description:"Normaler Start, Crash nach 5 Jahren",returns:[.08,.1,.07,.09,.06,-.35,-.15,.1,.12,.08]}};let Ct=Math.random;function Fe(t){Ct=t}function Ae(t){return Math.pow(1+t/100,1/Q)-1}function ra(t){return t/Math.sqrt(12)}function ia(t=0){return t===0?.26375:t===Ze?.27818:t===Ke?.27995:.26375+.25*t}function Me(t=0,s=1){let a,r;do a=Ct(),r=Ct();while(a===0);return Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*r)*s+t}function ke(t){let s=t;return function(){s|=0,s=s+1831565813|0;let a=Math.imul(s^s>>>15,1|s);return a=a+Math.imul(a^a>>>7,61|a)^a,((a^a>>>14)>>>0)/4294967296}}function x(t,s){if(t.length===0)return 0;const a=s/100*(t.length-1),r=Math.floor(a),e=Math.ceil(a);return r===e?t[r]:t[r]*(e-a)+t[e]*(a-r)}function ca(t,s){const a=t.length,r=ha(s),e=new Array(a).fill(0);for(let h=0;h<a;h++)for(let l=0;l<=h;l++)e[h]+=r[h][l]*t[l];return e}function ha(t){const s=t.length,a=Array(s).fill(null).map(()=>Array(s).fill(0));for(let r=0;r<s;r++)for(let e=0;e<=r;e++){let h=0;for(let l=0;l<e;l++)h+=a[r][l]*a[e][l];r===e?a[r][e]=Math.sqrt(Math.max(0,t[r][r]-h)):a[r][e]=a[e][e]>0?(t[r][e]-h)/a[e][e]:0}return a}function ua(t,s,a){const{inflationMode:r="deterministic",inflationVolatility:e=1.5,inflationFloor:h=-1,inflationCap:l=10,cashRateMode:u="deterministic",cashRateVolatility:_=1,corrInflationCash:R=.7,corrReturnInflation:f=-.1,crashMode:c="off",crashProbability:S=.03,crashDropMin:i=-.25,crashDropMax:m=-.45}=s,y=a.inflation_rate_pa||0,P=a.savings_rate_pa||0,p=new Array(t),v=new Array(t),I=new Array(t).fill(null),C=new Array(t).fill(0),F=r==="random"||u==="random";for(let k=0;k<t;k++){if(F){const L=[Me(),Me(),Me()],E=[[1,R,f],[R,1,f*.5],[f,f*.5,1]],B=ca(L,E);if(r==="random"){let G=y+B[0]*e;G=Math.max(h,Math.min(l,G)),p[k]=G}else p[k]=y;if(u==="random"){let G=P+B[1]*_;G=Math.max(-.5,Math.min(15,G)),v[k]=G}else v[k]=P;C[k]=B[2]}else p[k]=y,v[k]=P;if(c==="simple"&&Ct()<S){const E=i+Ct()*(m-i);I[k]=E}}return{annualInflation:p,annualCashRates:v,annualCrashEvents:I,annualReturnShocks:C}}function fa(t,s){const{savingShockMode:a="off",savingShockPNeg:r=.03,savingShockPPos:e=.05,savingShockFactorNeg:h=0,savingShockFactorPos:l=1.15,savingShockDurationNeg:u=12}=s;if(a==="off")return{shockFactors:null,baselineMultipliers:null};const _=t,R=new Array(_).fill(1),f=new Array(_).fill(1);let c=1,S=0,i=1;for(let m=0;m<_;m++)m%12===0&&(Ct()<e&&(c*=l),S<=0&&Ct()<r&&(S=u,i=h)),f[m]=c,S>0?(R[m]=i,S--):R[m]=1;return{shockFactors:R,baselineMultipliers:f}}function da(t,s){const{extraExpenseMode:a="off",extraExpenseProbability:r=.05,extraExpensePercent:e=5,extraExpenseFixed:h=1e4}=s;if(a==="off")return null;const l=new Array(t).fill(null);for(let u=0;u<t;u++)Ct()<r&&(a==="percent_of_wealth"?l[u]={type:"percent",value:e/100}:a==="fixed_real"&&(l[u]={type:"fixed",value:h}));return l}function ma(t,s=.01){if(t.length<=1)return t;const a=new Map;for(const r of t){if(r.amount<=0)continue;const h=(Math.round(r.price/s)*s).toFixed(4);if(a.has(h)){const l=a.get(h),u=l.amount+r.amount,_=(l.price*l.amount+r.price*r.amount)/u;l.amount=u,l.price=_,l.monthIdx=Math.min(l.monthIdx,r.monthIdx)}else a.set(h,{...r})}return Array.from(a.values()).sort((r,e)=>r.monthIdx-e.monthIdx)}function Ce(t,s,a,r,e,h,l=0,u=!0,_=.7){let R=0,f=r,c=l,S=0,i=0;for(;t>.01&&s.length;){const m=u?0:s.length-1,y=s[m],P=a-y.price,p=Math.max(0,e-f);let v;if(P>0){const E=P*_,B=Math.min(E>0?c/E:Number.POSITIVE_INFINITY,y.amount),G=Math.min(E>0?p/E:Number.POSITIVE_INFINITY,y.amount-B),D=B+G,et=t/a;if(et<=D)v=et;else{const j=D*a,at=t-j,M=E*h,w=a-M;if(w<=0)break;const nt=at/w;v=D+nt}}else v=t/a;const I=Math.min(v,y.amount);S+=I*a;const F=I*P*_;i+=F;let k=0;if(F>0){const E=Math.min(F,c);c-=E;const B=F-E,G=Math.max(0,e-f),D=Math.min(B,G);f+=D,k=(B-D)*h}else F<0&&(c+=Math.abs(F));const L=I*a-k;t-=L,R+=k,v>=y.amount?u?s.shift():s.pop():y.amount-=I}return{remaining:t,taxPaid:R,yearlyUsedFreibetrag:f,lossPot:c,grossProceeds:S,taxableGainTotal:i}}function pa(t,s,a,r,e,h,l=0,u=!0,_=.7){let R=0,f=r,c=l,S=t,i=0;for(;S>.01&&s.length;){const y=u?0:s.length-1,P=s[y],p=a-P.price,v=S/a,I=Math.min(v,P.amount),C=I*a,k=I*p*_;let L=0;if(k>0){const B=Math.min(k,c);c-=B;const G=k-B,D=Math.max(0,e-f),et=Math.min(G,D);f+=et,L=(G-et)*h}else k<0&&(c+=Math.abs(k));const E=C-L;i+=E,R+=L,S-=C,v>=P.amount?u?s.shift():s.pop():P.amount-=I}const m=S>.01?S:0;return{netProceeds:i,taxPaid:R,yearlyUsedFreibetrag:f,lossPot:c,shortfall:m}}function Ie(t,s,a,r,e,h,l,u=0,_=!0,R=.7){if(t<=0)return{savings:s,yearlyUsedFreibetrag:e,lossPot:u,taxPaidOriginal:0,saleTax:0,totalTaxRecorded:0,shortfall:0};let f=t,c=u;const S=Math.min(s,f);s-=S,f-=S;let i=0;if(f>.01&&a.length){const p=Ce(f,a,r,e,h,l,c,_,R);f=p.remaining,i=p.taxPaid,e=p.yearlyUsedFreibetrag,c=p.lossPot}f=Math.max(0,f);const m=t-f,y=f>.01?f:0,P=m+i;return{savings:s,yearlyUsedFreibetrag:e,lossPot:c,taxPaidOriginal:m,saleTax:i,totalTaxRecorded:P,shortfall:y}}function ga(t,s,a,r){const e=la[t];if(!e||!e.returns)return null;const h=s-a;if(h<=0)return null;const l=Math.floor((h-1)/12);if(l<e.returns.length){const u=e.returns[l];return Math.pow(1+u,1/12)}return null}function Qe(t,s=0,a={}){var Le,Ge;const{start_savings:r,start_etf:e,start_etf_cost_basis:h=0,monthly_savings:l,monthly_etf:u,savings_rate_pa:_,etf_rate_pa:R,etf_ter_pa:f=0,savings_target:c,annual_raise_percent:S,savings_years:i,withdrawal_years:m,monthly_payout_net:y,monthly_payout_percent:P,withdrawal_min:p=0,withdrawal_max:v=0,inflation_adjust_withdrawal:I=!0,special_payout_net_savings:C,special_interval_years_savings:F,inflation_adjust_special_savings:k=!0,special_payout_net_withdrawal:L,special_interval_years_withdrawal:E,inflation_adjust_special_withdrawal:B=!0,inflation_rate_pa:G=0,sparerpauschbetrag:D=na,kirchensteuer:et="keine",basiszins:j=2.53,use_lifo:at=!1,rent_is_gross:M=!1,capital_preservation_enabled:w=!1,capital_preservation_threshold:nt=80,capital_preservation_reduction:gt=25,capital_preservation_recovery:_t=10,loss_pot:St=0,fondstyp:Rt="aktien"}=t,{stressScenario:ot="none",startYear:ft=new Date().getFullYear(),inflationMode:Nt="deterministic",inflationVolatility:ht=1.5,inflationFloor:ut=-1,inflationCap:jt=10,cashRateMode:Wt="deterministic",cashRateVolatility:Xt=1,corrInflationCash:Lt=.7,corrReturnInflation:Gt=-.1,savingShockMode:Ot="off",savingShockPNeg:Dt=.03,savingShockPPos:Yt=.05,savingShockFactorNeg:Ut=0,savingShockFactorPos:d=1.15,savingShockDurationNeg:V=12,extraExpenseMode:yt="off",extraExpenseProbability:bt=.05,extraExpensePercent:Et=5,extraExpenseFixed:Jt=1e4,crashMode:n="off",crashProbability:o=.03,crashDropMin:N=-.25,crashDropMax:O=-.45}=a,lt=s>0,le=ot&&ot!=="none",Mt=lt?ra(s/100):0,xt=je[Rt]||je.aktien;let te=0;et==="8"?te=Ze:et==="9"&&(te=Ke);const dt=ia(te),Vt=i+m,Zt=i*Q,Pt=ua(Vt,{inflationMode:Nt,inflationVolatility:ht,inflationFloor:ut,inflationCap:jt,cashRateMode:Wt,cashRateVolatility:Xt,corrInflationCash:Lt,corrReturnInflation:Gt,crashMode:n,crashProbability:o,crashDropMin:N,crashDropMax:O},t),Bt=fa(Zt,{savingShockMode:Ot,savingShockPNeg:Dt,savingShockPPos:Yt,savingShockFactorNeg:Ut,savingShockFactorPos:d,savingShockDurationNeg:V}),re=da(m,{extraExpenseMode:yt,extraExpenseProbability:bt,extraExpensePercent:Et,extraExpenseFixed:Jt}),mt=[];let A=r,Y=sa;const q=[];if(e>0){const Z=e/Y,st=(h>0?h:e)/Z;q.push({amount:Z,price:st,monthIdx:0})}const ie=R-f,T=Ae(ie),ee=S/100,Kt=Vt*Q;let qt=A>=c,X=0,ce=0,Ne=!1,Qt=y,xe=P,At=null,he=null,zt=1,Re=!1,We=0,ye=Y,J=St,ae=0,It=0;for(let Z=1;Z<=Kt;Z+=1){const vt=Z<=Zt,st=Math.floor((Z-1)/Q),Ht=(Z-1)%Q+1;let Ee=0,ue=0,pt=0,ne=0,fe=1;const $=Pt.annualInflation[st]??G,de=Pt.annualCashRates[st]??_,ve=Ae($),Oe=Ae(de),me=Pt.annualCrashEvents[st];zt*=1+ve;const we=q.reduce((W,z)=>W+z.amount,0)*Y,De=A+we;if(st!==ce){if(X=0,It>0){const W=Math.min(It,J);J-=W;const z=It-W,tt=Math.min(z,D);X=tt;const g=Math.max(0,z-tt)*dt,H=Ie(g,A,q,Y,X,D,dt,J,!at,xt);A=H.savings,X=H.yearlyUsedFreibetrag,J=H.lossPot,Ee=H.taxPaidOriginal,H.taxPaidOriginal,ue+=H.totalTaxRecorded,pt+=H.shortfall}ce=st,ye=Y,ae=0,It=0}let rt;const Ye=le?ga(ot,Z,Zt):null;if(Ye!==null)rt=Ye,Y*=rt;else if(me!==null&&Ht===1){const W=1+me;rt=Math.pow(W,1/12),Y*=rt}else if(me!==null){const W=1+me;rt=Math.pow(W,1/12),Y*=rt}else if(lt){const z=Math.log(1+T)-.5*Mt*Mt,ct=Pt.annualReturnShocks[st]??0,U=Me(0,1)*.9+ct*.1;rt=Math.exp(z+Mt*U),Y*=rt}else rt=1+T,Y*=rt;const $e=we*(rt-1),pe=A*Oe;let Te=0;ae+=pe,A+=pe;let Ue=0,$t=0,Ve=0,it=0,se=ue,wt=0,oe=0,ge=0,Be=!1,_e=0;if(vt){const W=Math.pow(1+ee,st),z=Z-1,ct=((Le=Bt.baselineMultipliers)==null?void 0:Le[z])??1,tt=((Ge=Bt.shockFactors)==null?void 0:Ge[z])??1;fe=tt;const U=l*W*ct*tt,g=u*W*ct*tt;if(qt?$t=g+U:(A+=U,Ue=U,$t=g),A>c&&(Ve=A-c,A=c,$t+=Ve,qt=!0),$t>0){const b=$t/Y;q.push({amount:b,price:Y,monthIdx:Z})}if(F>0&&Z%(F*Q)===0&&Z>0){let b=C;if(k){const Tt=Z/Q;b=C*Math.pow(1+G/100,Tt)}let K=b;it=K;const Ft=Math.max(0,A-c);if(Ft>0){const Tt=Math.min(Ft,K);A-=Tt,K-=Tt}const kt=Ce(K,q,Y,X,D,dt,J,!at,xt);if(K=kt.remaining,se+=kt.taxPaid,X=kt.yearlyUsedFreibetrag,J=kt.lossPot,K>.01){const Tt=Math.min(A,K);A-=Tt,K-=Tt,A<c&&(qt=!1)}K<0&&(A+=Math.abs(K),K=0),wt=it-Math.max(0,K)}}else{if(At===null){const g=q.reduce((H,b)=>H+b.amount,0);At=A+g*Y,P!=null&&!Ne?(Qt=At*(P/100)/12,he=Qt,Ne=!0,xe=P):Qt!=null&&(he=Qt,xe=At>0?Qt*12/At*100:0)}let W=Qt||0;if(I&&he!=null){const g=st-i;W=he*Math.pow(1+G/100,g)}if(p>0&&W<p&&(W=p),v>0&&W>v&&(W=v),w&&At>0){const g=q.reduce((Ft,kt)=>Ft+kt.amount,0),H=A+g*Y,b=At*(nt/100),K=At*((nt+_t)/100);H<b?Re=!0:H>=K&&(Re=!1),Re&&(W=W*(1-gt/100),Be=!0,We++)}const z=W;let ct=0,tt=W;if(E>0&&Z%(E*Q)===0){if(ct=L,B){const g=Z/Q;ct=L*Math.pow(1+G/100,g)}tt+=ct}const U=st-i;if(re&&U>=0&&Ht===1){const g=re[U];if(g){if(g.type==="percent"){const H=q.reduce((K,Ft)=>K+Ft.amount,0);ne=(A+H*Y)*g.value}else g.type==="fixed"&&(ne=g.value*zt);tt+=ne}}if(tt>0){let g=tt;it=tt;const H=Math.max(0,A-c);if(H>0){const b=Math.min(H,g);A-=b,g-=b,M&&(_e+=b)}if(M&&g>0){const b=pa(g,q,Y,X,D,dt,J,!at,xt),K=b.netProceeds;se+=b.taxPaid,X=b.yearlyUsedFreibetrag,J=b.lossPot,g=b.shortfall,wt=it-g,_e+=K}else if(g>0){const b=Ce(g,q,Y,X,D,dt,J,!at,xt);g=b.remaining,se+=b.taxPaid,X=b.yearlyUsedFreibetrag,J=b.lossPot}if(g>.01){const b=Math.min(A,g);A-=b,g-=b,M&&(_e+=b)}g<0&&(A+=Math.abs(g),g=0),M||(wt=it-Math.max(0,g))}if(it>0&&wt<it){const g=wt/it;ge=z*g}else ge=z}let be=0;if(Ht===12){if(ae>0){const ct=Math.min(ae,J);J-=ct;const tt=ae-ct,U=Math.max(0,D-X),g=Math.min(tt,U);if(X+=g,Te=Math.max(0,tt-g)*dt,Te>.01){const b=Ie(Te,A,q,Y,X,D,dt,J,!at,xt);A=b.savings,X=b.yearlyUsedFreibetrag,J=b.lossPot,se+=b.totalTaxRecorded,pt+=b.shortfall}}const W=ft+st,z=oa(W,j);if(z>0){const ct=st*Q,tt=.7;for(const U of q){if(U.amount<=0)continue;const g=U.monthIdx>ct,H=g?U.amount*U.price:U.amount*ye;let b=1;g&&(b=(12-((U.monthIdx-1)%Q+1)+1)/12);const K=H*(z/100)*tt*b,Ft=U.amount*Y,kt=g?U.amount*U.price:U.amount*ye,Tt=Math.max(0,Ft-kt),Pe=Math.min(K,Tt);Pe>0&&(be+=Pe,U.price+=Pe/U.amount)}be>0&&(It=be*xt)}}if(Ht===12&&q.length>50){const W=ma(q);q.length=0,q.push(...W)}const qe=q.reduce((W,z)=>W+z.amount,0)*Y,ze=A+qe,ta=vt?null:it>0?it:null,ea=it>0?Math.max(0,it-wt):0;!vt&&it>0?M?oe=_e:oe=wt:oe=0;const aa=1+Oe;let He=rt;if(De>0){const W=we/De,z=1-W;He=W*rt+z*aa}mt.push({month:Z,year:st+1,phase:vt?"Anspar":"Entnahme",savings:A,etf:qe,total:ze,total_real:ze/zt,savings_contrib:Ue,etf_contrib:$t,savings_interest:pe,withdrawal:wt,withdrawal_real:wt/zt,withdrawal_net:oe,withdrawal_net_real:oe/zt,withdrawal_requested:it,shortfall:ea,tax_shortfall:pt,monthly_payout:ge,monthly_payout_real:ge/zt,tax_paid:se,vorabpauschale_tax:Ee,payout_value:ta,payout_percent_pa:vt?null:xe,return_gain:$e+pe,etfReturn:rt,portfolioReturn:He,cumulative_inflation:zt,capital_preservation_active:Be||!1,yearly_used_freibetrag:X,loss_pot:J,extra_expense:ne,saving_shock_factor:fe,inflation_rate_year:$,cash_rate_year:de})}if(It>0&&mt.length>0){const Z=Math.min(It,J);J-=Z;const vt=It-Z,Ht=Math.min(vt,D),ue=Math.max(0,vt-Ht)*dt,pt=Ie(ue,A,q,Y,Ht,D,dt,J,!at,xt);A=pt.savings,J=pt.lossPot;const fe=q.reduce((de,ve)=>de+ve.amount,0)*Y,$=mt[mt.length-1];$.savings=A,$.etf=fe,$.total=$.savings+$.etf,$.total_real=$.total/$.cumulative_inflation,$.tax_paid+=pt.totalTaxRecorded,$.vorabpauschale_tax=($.vorabpauschale_tax||0)+pt.taxPaidOriginal,$.pending_vorabpauschale_tax=pt.taxPaidOriginal,$.loss_pot=J,pt.shortfall>.01&&($.tax_shortfall=($.tax_shortfall||0)+pt.shortfall),A<0&&(A=0)}return mt.length>0&&(mt.capitalPreservationMonths=We,mt.capitalPreservationEnabled=w),mt}function _a(t,s,a={}){var Lt,Gt,Ot,Dt,Yt,Ut,d,V,yt,bt,Et,Jt;const r=((Lt=t[0])==null?void 0:Lt.length)||0,e=t.length,h=s.savings_years*Q,l=s.savings_target??0,u=s.monthly_payout_net||0,_=u>0?u*12:100,R=a.successThreshold??_,f=(a.ruinThresholdPercent??10)/100,c=t.map(n=>{var o;return((o=n[n.length-1])==null?void 0:o.total)||0}).sort((n,o)=>n-o),S=t.map(n=>{var o;return((o=n[n.length-1])==null?void 0:o.total_real)||0}).sort((n,o)=>n-o),i=t.map(n=>{var o;return((o=n[n.length-1])==null?void 0:o.loss_pot)||0}).sort((n,o)=>n-o),m=t.map(n=>{var o;return((o=n[n.length-1])==null?void 0:o.yearly_used_freibetrag)||0}).sort((n,o)=>n-o),y=Math.min(h-1,r-1),P=t.map(n=>{var o;return((o=n[y])==null?void 0:o.total)||0}).sort((n,o)=>n-o),p=t.map(n=>{var o;return((o=n[y])==null?void 0:o.total_real)||0}).sort((n,o)=>n-o),v=[],I=[],C=[],F=[],k=[],L=[],E=[],B=[];for(const n of t){const o=n.filter(N=>N.phase==="Entnahme"&&((N.withdrawal||0)>0||(N.withdrawal_net||0)>0));o.length>0&&(C.push(o.reduce((N,O)=>N+(O.withdrawal||0),0)/o.length),F.push(o.reduce((N,O)=>N+(O.withdrawal_real||0),0)/o.length),v.push(o.reduce((N,O)=>N+(O.withdrawal_net||0),0)/o.length),I.push(o.reduce((N,O)=>N+(O.withdrawal_net_real||0),0)/o.length),E.push(n.reduce((N,O)=>N+(O.withdrawal||0),0)),B.push(n.reduce((N,O)=>N+(O.withdrawal_real||0),0)),k.push(n.reduce((N,O)=>N+(O.withdrawal_net||0),0)),L.push(n.reduce((N,O)=>N+(O.withdrawal_net_real||0),0)))}v.sort((n,o)=>n-o),I.sort((n,o)=>n-o),C.sort((n,o)=>n-o),F.sort((n,o)=>n-o),k.sort((n,o)=>n-o),L.sort((n,o)=>n-o),E.sort((n,o)=>n-o),B.sort((n,o)=>n-o);let G=0,D=0,et=0,j=0,at=0,M=0,w=0;const nt=[];let gt=0,_t=0;const St=[];let Rt=0;const ot=.01,ft=50;for(const n of t){const o=n[n.length-1],N=(o==null?void 0:o.total)||0,O=(o==null?void 0:o.cumulative_inflation)||1,lt=R*O,le=N>lt,Mt=n[y],xt=(Mt==null?void 0:Mt.total)||0,te=(Mt==null?void 0:Mt.total_real)||0,dt=(o==null?void 0:o.total_real)||0;let Vt=null;if(l<=0)Vt=0;else for(let T=0;T<r&&T<n.length;T++)if((((Gt=n[T])==null?void 0:Gt.savings)||0)>=l){Vt=((Ot=n[T])==null?void 0:Ot.month)??T+1;break}Vt!==null&&nt.push(Vt/12);let Zt=!1,Pt=!1;for(let T=0;T<h&&T<r&&T<n.length;T++)if((((Dt=n[T])==null?void 0:Dt.shortfall)||0)>ft||(((Yt=n[T])==null?void 0:Yt.tax_shortfall)||0)>ft){Zt=!0;break}for(let T=h;T<r&&T<n.length;T++){const ee=((Ut=n[T])==null?void 0:Ut.withdrawal_requested)||0,Kt=((d=n[T])==null?void 0:d.shortfall)||0,qt=((V=n[T])==null?void 0:V.tax_shortfall)||0,X=Math.max(ft,ee*ot);if(Kt>X||qt>X){Pt=!0;break}}Zt&&M++,Pt&&w++;let Bt=!1;const re=xt*f;for(let T=h;T<r&&T<n.length;T++){const ee=((yt=n[T])==null?void 0:yt.withdrawal_requested)||0,Kt=Math.max(ft,ee*ot),qt=((bt=n[T])==null?void 0:bt.shortfall)||0,X=((Et=n[T])==null?void 0:Et.tax_shortfall)||0,ce=qt>Kt||X>Kt;if((((Jt=n[T])==null?void 0:Jt.total)||0)<re||ce){Bt=!0;break}}Bt&&et++,le&&!Pt&&!Bt&&G++,le&&!Bt&&D++,N>=xt&&j++,dt>=te&&at++;let mt=!1,A=!1,Y=0,q=0,ie=0;for(const T of n)(T.extra_expense||0)>0&&(mt=!0,ie+=T.extra_expense),(T.saving_shock_factor||1)<1&&(A=!0),T.inflation_rate_year!==void 0&&(Y+=T.inflation_rate_year,q++);mt&&gt++,A&&_t++,q>0&&St.push(Y/q),Rt+=ie}const Nt=[],ht={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]},ut={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]};for(let n=0;n<r;n++){Nt.push(n+1);const o=t.map(O=>{var lt;return((lt=O[n])==null?void 0:lt.total)||0}).sort((O,lt)=>O-lt),N=t.map(O=>{var lt;return((lt=O[n])==null?void 0:lt.total_real)||0}).sort((O,lt)=>O-lt);ht.p5.push(x(o,5)),ht.p10.push(x(o,10)),ht.p25.push(x(o,25)),ht.p50.push(x(o,50)),ht.p75.push(x(o,75)),ht.p90.push(x(o,90)),ht.p95.push(x(o,95)),ut.p5.push(x(N,5)),ut.p10.push(x(N,10)),ut.p25.push(x(N,25)),ut.p50.push(x(N,50)),ut.p75.push(x(N,75)),ut.p90.push(x(N,90)),ut.p95.push(x(N,95))}const jt=Sa(t,s);nt.sort((n,o)=>n-o);const Wt=nt.length/e*100,Xt=nt.length>0?x(nt,50):null;return{iterations:e,months:Nt,percentiles:ht,percentilesReal:ut,savingsYears:s.savings_years,medianEnd:x(c,50),meanEnd:c.reduce((n,o)=>n+o,0)/e,p5End:x(c,5),p10End:x(c,10),p25End:x(c,25),p75End:x(c,75),p90End:x(c,90),p95End:x(c,95),medianEndReal:x(S,50),meanEndReal:S.reduce((n,o)=>n+o,0)/e,p5EndReal:x(S,5),p10EndReal:x(S,10),p25EndReal:x(S,25),p75EndReal:x(S,75),p90EndReal:x(S,90),p95EndReal:x(S,95),retirementMedian:x(P,50),retirementMedianReal:x(p,50),medianAvgWithdrawalNet:v.length>0?x(v,50):0,medianAvgWithdrawalNetReal:I.length>0?x(I,50):0,medianAvgWithdrawalGross:C.length>0?x(C,50):0,medianAvgWithdrawalGrossReal:F.length>0?x(F,50):0,medianTotalWithdrawalNet:k.length>0?x(k,50):0,medianTotalWithdrawalNetReal:L.length>0?x(L,50):0,medianTotalWithdrawalGross:E.length>0?x(E,50):0,medianTotalWithdrawalGrossReal:B.length>0?x(B,50):0,successRate:G/e*100,softSuccessRate:D/e*100,ruinProbability:et/e*100,capitalPreservationRate:j/e*100,capitalPreservationRateReal:at/e*100,ansparShortfallRate:M/e*100,entnahmeShortfallRate:w/e*100,emergencyFillProbability:Wt,emergencyNeverFillProbability:100-Wt,emergencyMedianFillYears:Xt,medianFinalLossPot:x(i,50),medianFinalYearlyFreibetrag:x(m,50),sorr:jt,pathsWithExtraExpensesRate:gt/e*100,pathsWithSavingShocksRate:_t/e*100,medianAvgInflationRate:St.length>0?x(St.sort((n,o)=>n-o),50):null,avgExtraExpensePerPath:e>0?Rt/e:0,mcOptions:a}}function Sa(t,s){var G,D,et,j,at;t.length;const a=s.savings_years*Q,r=(s.savings_years+s.withdrawal_years)*Q,e=Math.min(5,s.withdrawal_years),h=e*12,l=[];for(const M of t){if(M.length<a)continue;const w=((G=M[a-1])==null?void 0:G.total)||((D=M[a])==null?void 0:D.total)||0;if(w<=0)continue;let nt=1;const gt=Math.min(a+h-1,r-1,M.length-1);for(let ot=a;ot<=gt;ot++){const ft=((et=M[ot])==null?void 0:et.portfolioReturn)||((j=M[ot])==null?void 0:j.etfReturn)||1;nt*=ft}const _t=gt-a+1,St=_t>0?Math.pow(nt,12/_t)-1:0,Rt=((at=M[M.length-1])==null?void 0:at.total)||0;l.push({startWealth:w,earlyReturn:St,endWealth:Rt})}if(l.length<10)return{sorRiskScore:0,earlyBadImpact:0,earlyGoodImpact:0,correlationEarlyReturns:0,worstSequenceEnd:0,bestSequenceEnd:0,vulnerabilityWindow:e};l.sort((M,w)=>M.earlyReturn-w.earlyReturn);const u=Math.floor(l.length/5),_=l.slice(0,u),R=l.slice(-u),f=l.reduce((M,w)=>M+w.endWealth,0)/l.length,c=_.reduce((M,w)=>M+w.endWealth,0)/_.length,S=R.reduce((M,w)=>M+w.endWealth,0)/R.length,i=l.reduce((M,w)=>M+w.startWealth,0)/l.length,m=i>0?(f-c)/i*100:0,y=i>0?(S-f)/i*100:0,P=m+y,p=l.length,v=l.reduce((M,w)=>M+w.earlyReturn,0),I=l.reduce((M,w)=>M+w.endWealth,0),C=l.reduce((M,w)=>M+w.earlyReturn*w.endWealth,0),F=l.reduce((M,w)=>M+w.earlyReturn*w.earlyReturn,0),k=l.reduce((M,w)=>M+w.endWealth*w.endWealth,0),L=p*C-v*I,E=Math.sqrt((p*F-v*v)*(p*k-I*I)),B=E>0?L/E:0;return{sorRiskScore:Math.abs(P),earlyBadImpact:m,earlyGoodImpact:y,correlationEarlyReturns:B,worstSequenceEnd:c,bestSequenceEnd:S,vulnerabilityWindow:e}}const Ma=100,xa=12,Ra=10,Je=.01,Se=50;function ya(t,s,a={},r=null,e=null,h=null){var ot,ft,Nt,ht,ut,jt,Wt,Xt,Lt,Gt,Ot,Dt,Yt,Ut;const l=r??s.savings_years*Q,u=e??(s.savings_years+s.withdrawal_years)*Q,_=h??s.savings_target??0,R=s.monthly_payout_net||0,f=R>0?R*xa:Ma,c=a.successThreshold??f,S=(a.ruinThresholdPercent??Ra)/100,i=t[t.length-1],m=(i==null?void 0:i.total)||0,y=(i==null?void 0:i.cumulative_inflation)||1,P=c*y,p=m>P;let v=null;if(_<=0)v=0;else for(let d=0;d<Math.min(u,t.length);d++)if((((ot=t[d])==null?void 0:ot.savings)||0)>=_){v=((ft=t[d])==null?void 0:ft.month)??d+1;break}let I=!1,C=!1;for(let d=0;d<l&&d<u&&d<t.length;d++)if((((Nt=t[d])==null?void 0:Nt.shortfall)||0)>Se||(((ht=t[d])==null?void 0:ht.tax_shortfall)||0)>Se){I=!0;break}for(let d=l;d<u&&d<t.length;d++){const V=((ut=t[d])==null?void 0:ut.withdrawal_requested)||0,yt=((jt=t[d])==null?void 0:jt.shortfall)||0,bt=((Wt=t[d])==null?void 0:Wt.tax_shortfall)||0,Et=Math.max(Se,V*Je);if(yt>Et||bt>Et){C=!0;break}}let F=!1;const k=Math.min(l-1,u-1),L=((Xt=t[k])==null?void 0:Xt.total)||0,E=L*S;for(let d=l;d<u&&d<t.length;d++){const V=((Lt=t[d])==null?void 0:Lt.withdrawal_requested)||0,yt=Math.max(Se,V*Je),bt=((Gt=t[d])==null?void 0:Gt.shortfall)||0,Et=((Ot=t[d])==null?void 0:Ot.tax_shortfall)||0,Jt=bt>yt||Et>yt;if((((Dt=t[d])==null?void 0:Dt.total)||0)<E||Jt){F=!0;break}}const B=((Yt=t[k])==null?void 0:Yt.total_real)||0,G=((Ut=t[u-1])==null?void 0:Ut.total_real)||0,D=m>=L,et=G>=B,j=t.filter(d=>d.phase==="Entnahme"&&((d.withdrawal||0)>0||(d.withdrawal_net||0)>0));let at=0,M=0,w=0,nt=0,gt=0,_t=0,St=0,Rt=0;return j.length>0&&(w=j.reduce((d,V)=>d+(V.withdrawal||0),0)/j.length,nt=j.reduce((d,V)=>d+(V.withdrawal_real||0),0)/j.length,at=j.reduce((d,V)=>d+(V.withdrawal_net||0),0)/j.length,M=j.reduce((d,V)=>d+(V.withdrawal_net_real||0),0)/j.length,St=t.reduce((d,V)=>d+(V.withdrawal||0),0),Rt=t.reduce((d,V)=>d+(V.withdrawal_real||0),0),gt=t.reduce((d,V)=>d+(V.withdrawal_net||0),0),_t=t.reduce((d,V)=>d+(V.withdrawal_net_real||0),0)),{hasPositiveEnd:p,hasAnsparShortfall:I,hasEntnahmeShortfall:C,isRuin:F,capitalPreserved:D,capitalPreservedReal:et,firstFillMonth:v,avgWithdrawalNet:at,avgWithdrawalNetReal:M,avgWithdrawalGross:w,avgWithdrawalGrossReal:nt,totalWithdrawalNet:gt,totalWithdrawalNetReal:_t,totalWithdrawalGross:St,totalWithdrawalGrossReal:Rt}}function Ea(t,s,a=null,r=null){var m,y,P,p,v;const e=a??s.savings_years*Q,h=r??(s.savings_years+s.withdrawal_years)*Q,u=Math.min(5,s.withdrawal_years)*12,_=((m=t[e-1])==null?void 0:m.total)||((y=t[e])==null?void 0:y.total)||0;let R=1;const f=Math.min(e+u-1,h-1);for(let I=e;I<=f&&I<t.length;I++){const C=((P=t[I])==null?void 0:P.portfolioReturn)||((p=t[I])==null?void 0:p.etfReturn)||1;R*=C}const c=f-e+1,S=c>0?Math.pow(R,12/c)-1:0,i=((v=t[h-1])==null?void 0:v.total)||0;return{startWealth:_,earlyReturn:S,endWealth:i}}const va=100,wa=10;function Ta(t){let e=0,h=0,l=0,u=0,_=0,R=0,f=!1;function c(){return Date.now()}function S(i){if(!isFinite(i)||i<0)return"";if(i<1)return"< 1 s";if(i<60)return String(Math.round(i))+" s";const m=Math.floor(i/60),y=Math.round(i%60);if(m<60){const I=String(m),C=String(y).padStart(2,"0");return I+":"+C+" min"}const P=Math.floor(m/60),p=m%60,v=String(p).padStart(2,"0");return String(P)+":"+v+" h"}return{start(i){e=typeof i=="number"?i:0,h=c(),l=h,u=0,_=0,R=0,f=!1},update(i){if(f)return;const m=c();h||(h=m,l=m);const y=i-u,P=m-l;if(y<=0||P<200){u=i,l=m;return}const p=y/(P/1e3);_===0?_=p:_=.3*p+(1-.3)*_,u=i,l=m,R+=1},getEta(){if(f||!h||e<=0||_<=0)return{seconds:null,formatted:""};const i=c()-h;if(R<3||i<1500)return{seconds:null,formatted:""};const m=Math.max(0,e-u);if(m<=0)return{seconds:0,formatted:"< 1 s"};const y=m/_;return{seconds:y,formatted:S(y)}},stop(){f=!0}}}function ba(t,s,a,r={}){const e=[],l=Ta();r.seed!=null?Fe(ke(r.seed)):Fe(ke(Date.now()+Math.random()*1e6)),l.start(s);for(let _=0;_<s;_+=50){const R=Math.min(_+50,s);for(let i=_;i<R;i++){const m=Qe(t,a,r);e.push(m)}const f=Math.round(R/s*100);l.update(R);const c=l.getEta(),S=c.formatted?"ETA "+c.formatted:"";self.postMessage({type:"progress",current:R,total:s,percent:f,eta:S})}const u=_a(e,t,r);return u.volatility=a,u.allHistories=e.slice(0,50),u.mcOptions=r,u}function Pa(t,s,a,r,e,h,l,u){var y,P;let R=0;const f=t.savings_years*Q,c=(t.savings_years+t.withdrawal_years)*Q,S=t.savings_target??0,i={finalTotals:[],finalTotalsReal:[],finalLossPot:[],finalYearlyFreibetrag:[],retirementTotals:[],retirementTotalsReal:[],simResults:[],sorrData:[],monthlyTotals:[],monthlyTotalsReal:[]},m=[];for(let p=0;p<c;p++)i.monthlyTotals.push([]),i.monthlyTotalsReal.push([]);for(let p=0;p<e;p++){const v=r+p;Fe(ke(u+v));const I={...a},C=Qe(t,s,I),F=C[C.length-1],k=Math.min(f-1,c-1),L=C[k];i.finalTotals.push((F==null?void 0:F.total)||0),i.finalTotalsReal.push((F==null?void 0:F.total_real)||0),i.finalLossPot.push((F==null?void 0:F.loss_pot)||0),i.finalYearlyFreibetrag.push((F==null?void 0:F.yearly_used_freibetrag)||0),i.retirementTotals.push((L==null?void 0:L.total)||0),i.retirementTotalsReal.push((L==null?void 0:L.total_real)||0);for(let E=0;E<c&&E<C.length;E++)i.monthlyTotals[E].push(((y=C[E])==null?void 0:y.total)||0),i.monthlyTotalsReal[E].push(((P=C[E])==null?void 0:P.total_real)||0);if(i.simResults.push(ya(C,t,a,f,c,S)),i.sorrData.push(Ea(C,t,f,c)),m.length<wa&&m.push(C),(p+1)%50===0||p===e-1){const E=Date.now();(E-R>=va||p===e-1)&&(R=E,self.postMessage({type:"chunk-progress",workerId:l,completedInChunk:p+1,chunkSize:e,totalIterations:h}))}}return{rawData:i,samplePaths:m}}self.onmessage=function(t){const{type:s}=t.data;try{switch(s){case"start":{const{params:a,iterations:r,volatility:e,mcOptions:h}=t.data;if(!a)throw new Error("Keine Parameter übergeben");const l=ba(a,r||1e3,e||15,h||{});self.postMessage({type:"complete",results:l});break}case"run-chunk":{const{params:a,volatility:r,mcOptions:e,startIdx:h,count:l,totalIterations:u,workerId:_,baseSeed:R}=t.data;if(!a)throw new Error("Keine Parameter übergeben");const{rawData:f,samplePaths:c}=Pa(a,r||15,e||{},h,l,u,_,R);self.postMessage({type:"chunk-complete",workerId:_,rawData:f,samplePaths:c});break}default:self.postMessage({type:"error",message:`Unbekannter Nachrichtentyp: ${s}`})}}catch(a){self.postMessage({type:"error",message:a.message||"Unbekannter Fehler bei der Monte-Carlo-Simulation"})}};
