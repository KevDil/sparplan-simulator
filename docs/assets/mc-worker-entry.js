const ue={aktien:.7,misch:.85,renten:1},Ee=1e3,me=.08,ge=.09,J=12,be=100,de={2025:2.53,2024:2.29,2023:2.55,2022:-.05,2021:-.45,2020:.07,2019:.52,2018:.87};function ve(t,s=2.53){return de[t]!==void 0?de[t]:s}const xe={none:{name:"Standard (Zufällig)",description:"Normale Monte-Carlo-Simulation mit zufälligen Renditen",returns:null},early_crash:{name:"Früher Crash",description:"-30% im 1. Rentenjahr, langsame Erholung über 5 Jahre",returns:[-.3,-.1,.05,.08,.1,.12,.08,.07,.06,.06]},sideways:{name:"Seitwärtsmarkt",description:"0% Realrendite über 10 Jahre",returns:[.02,.01,-.01,.02,0,-.02,.03,-.01,.01,0]},bear_market:{name:"Bärenmarkt-Phase",description:"3-5 Jahre leicht negative Renditen, danach normal",returns:[-.05,-.08,-.03,-.02,.02,.08,.1,.07,.06,.06]},late_crash:{name:"Später Crash",description:"Normaler Start, Crash nach 5 Jahren",returns:[.08,.1,.07,.09,.06,-.35,-.15,.1,.12,.08]}};let ee=Math.random;function ae(t){ee=t}function $t(t){return Math.pow(1+t/100,1/J)-1}function Pe(t){return t/Math.sqrt(12)}function Ae(t=0){return t===0?.26375:t===me?.27818:t===ge?.27995:.26375+.25*t}function Ie(t=0,s=1){let n,i;do n=ee(),i=ee();while(n===0);return Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*i)*s+t}function ne(t){let s=t;return function(){s|=0,s=s+1831565813|0;let n=Math.imul(s^s>>>15,1|s);return n=n+Math.imul(n^n>>>7,61|n)^n,((n^n>>>14)>>>0)/4294967296}}function m(t,s){if(t.length===0)return 0;const n=s/100*(t.length-1),i=Math.floor(n),l=Math.ceil(n);return i===l?t[i]:t[i]*(l-n)+t[l]*(n-i)}function Fe(t,s=.01){if(t.length<=1)return t;const n=new Map;for(const i of t){if(i.amount<=0)continue;const M=(Math.round(i.price/s)*s).toFixed(4);if(n.has(M)){const o=n.get(M),p=o.amount+i.amount,I=(o.price*o.amount+i.price*i.amount)/p;o.amount=p,o.price=I,o.monthIdx=Math.min(o.monthIdx,i.monthIdx)}else n.set(M,{...i})}return Array.from(n.values()).sort((i,l)=>i.monthIdx-l.monthIdx)}function se(t,s,n,i,l,M,o=0,p=!0,I=.7){let W=0,g=i,c=o,b=0,d=0;for(;t>.01&&s.length;){const B=p?0:s.length-1,N=s[B],C=n-N.price,y=Math.max(0,l-g);let P;if(C>0){const T=C*I,j=Math.min(T>0?c/T:Number.POSITIVE_INFINITY,N.amount),K=Math.min(T>0?y/T:Number.POSITIVE_INFINITY,N.amount-j),G=j+K,Q=t/n;if(Q<=G)P=Q;else{const z=G*n,$=t-z,f=T*M,R=n-f;if(R<=0)break;const et=$/R;P=G+et}}else P=t/n;const v=Math.min(P,N.amount);b+=v*n;const E=v*C*I;d+=E;let q=0;if(E>0){const T=Math.min(E,c);c-=T;const j=E-T,K=Math.max(0,l-g),G=Math.min(j,K);g+=G,q=(j-G)*M}else E<0&&(c+=Math.abs(E));const Y=v*n-q;t-=Y,W+=q,P>=N.amount?p?s.shift():s.pop():N.amount-=v}return{remaining:t,taxPaid:W,yearlyUsedFreibetrag:g,lossPot:c,grossProceeds:b,taxableGainTotal:d}}function We(t,s,n,i,l,M,o=0,p=!0,I=.7){let W=0,g=i,c=o,b=t,d=0;for(;b>.01&&s.length;){const N=p?0:s.length-1,C=s[N],y=n-C.price,P=b/n,v=Math.min(P,C.amount),F=v*n,q=v*y*I;let Y=0;if(q>0){const j=Math.min(q,c);c-=j;const K=q-j,G=Math.max(0,l-g),Q=Math.min(K,G);g+=Q,Y=(K-Q)*M}else q<0&&(c+=Math.abs(q));const T=F-Y;d+=T,W+=Y,b-=F,P>=C.amount?p?s.shift():s.pop():C.amount-=v}const B=b>.01?b:0;return{netProceeds:d,taxPaid:W,yearlyUsedFreibetrag:g,lossPot:c,shortfall:B}}function te(t,s,n,i,l,M,o,p=0,I=!0,W=.7){if(t<=0)return{savings:s,yearlyUsedFreibetrag:l,lossPot:p,taxPaidOriginal:0,saleTax:0,totalTaxRecorded:0,shortfall:0};let g=t,c=p;const b=Math.min(s,g);s-=b,g-=b;let d=0;if(g>.01&&n.length){const y=se(g,n,i,l,M,o,c,I,W);g=y.remaining,d=y.taxPaid,l=y.yearlyUsedFreibetrag,c=y.lossPot}g=Math.max(0,g);const B=t-g,N=g>.01?g:0,C=B+d;return{savings:s,yearlyUsedFreibetrag:l,lossPot:c,taxPaidOriginal:B,saleTax:d,totalTaxRecorded:C,shortfall:N}}function Ne(t,s,n,i){const l=xe[t];if(!l||!l.returns)return null;const M=s-n;if(M<=0)return null;const o=Math.floor((M-1)/12);if(o<l.returns.length){const p=l.returns[o];return Math.pow(1+p,1/12)}return null}function pe(t,s=0,n={}){const{start_savings:i,start_etf:l,start_etf_cost_basis:M=0,monthly_savings:o,monthly_etf:p,savings_rate_pa:I,etf_rate_pa:W,etf_ter_pa:g=0,savings_target:c,annual_raise_percent:b,savings_years:d,withdrawal_years:B,monthly_payout_net:N,monthly_payout_percent:C,withdrawal_min:y=0,withdrawal_max:P=0,inflation_adjust_withdrawal:v=!0,special_payout_net_savings:F,special_interval_years_savings:E,inflation_adjust_special_savings:q=!0,special_payout_net_withdrawal:Y,special_interval_years_withdrawal:T,inflation_adjust_special_withdrawal:j=!0,inflation_rate_pa:K=0,sparerpauschbetrag:G=Ee,kirchensteuer:Q="keine",basiszins:z=2.53,use_lifo:$=!1,rent_is_gross:f=!1,capital_preservation_enabled:R=!1,capital_preservation_threshold:et=80,capital_preservation_reduction:pt=25,capital_preservation_recovery:ut=10,loss_pot:St=0,fondstyp:at="aktien"}=t,{stressScenario:H="none",startYear:xt=new Date().getFullYear()}=n,Pt=s>0,Nt=H&&H!=="none",Rt=Pt?Pe(s/100):0,it=ue[at]||ue.aktien;let wt=0;Q==="8"?wt=me:Q==="9"&&(wt=ge);const nt=Ae(wt),st=[];let _=i,O=be;const U=[];if(l>0){const V=l/O,dt=(M>0?M:l)/V;U.push({amount:V,price:dt,monthIdx:0})}const It=W-g,At=$t(I),r=$t(It),D=$t(K),e=b/100,a=(d+B)*J,S=d*J;let x=_>=c,L=0,Lt=0,Mt=!1,yt=N,kt=C,_t=null,Tt=null,Et=1,Ft=!1,Wt=0,Gt=O,h=St,bt=0,ct=0;for(let V=1;V<=a;V+=1){const lt=V<=S,dt=Math.floor((V-1)/J),Ot=(V-1)%J+1;let Jt=0,Bt=0,mt=0;Et*=1+D;const Yt=U.reduce((k,X)=>k+X.amount,0)*O,Z=_+Yt;if(dt!==Lt){if(L=0,ct>0){const k=Math.min(ct,h);h-=k;const X=ct-k,ht=Math.min(X,G);L=ht;const A=Math.max(0,X-ht)*nt,w=te(A,_,U,O,L,G,nt,h,!$,it);_=w.savings,L=w.yearlyUsedFreibetrag,h=w.lossPot,Jt=w.taxPaidOriginal,w.taxPaidOriginal,Bt+=w.totalTaxRecorded,mt+=w.shortfall}Lt=dt,Gt=O,bt=0,ct=0}let ft;const qt=Nt?Ne(H,V,S):null;if(qt!==null)ft=qt,O*=ft;else if(Pt){const X=Math.log(1+r)-.5*Rt*Rt,rt=Ie(0,1);ft=Math.exp(X+Rt*rt),O*=ft}else ft=1+r,O*=ft;const Se=Yt*(ft-1),Vt=_*At;let jt=0;bt+=Vt,_+=Vt;let le=0,Ct=0,oe=0,ot=0,Ut=Bt,vt=0,Dt=0,zt=0,re=!1,Ht=0;if(lt){const k=Math.pow(1+e,dt),X=o*k,rt=p*k;if(x?Ct=rt+X:(_+=X,le=X,Ct=rt),_>c&&(oe=_-c,_=c,Ct+=oe,x=!0),Ct>0){const u=Ct/O;U.push({amount:u,price:O,monthIdx:V})}if(E>0&&V%(E*J)===0&&V>0){let u=F;if(q){const gt=V/J;u=F*Math.pow(1+K/100,gt)}let A=u;ot=A;const w=Math.max(0,_-c);if(w>0){const gt=Math.min(w,A);_-=gt,A-=gt}const tt=se(A,U,O,L,G,nt,h,!$,it);if(A=tt.remaining,Ut+=tt.taxPaid,L=tt.yearlyUsedFreibetrag,h=tt.lossPot,A>.01){const gt=Math.min(_,A);_-=gt,A-=gt,_<c&&(x=!1)}A<0&&(_+=Math.abs(A),A=0),vt=ot-Math.max(0,A)}}else{if(_t===null){const u=U.reduce((A,w)=>A+w.amount,0);_t=_+u*O,C!=null&&!Mt?(yt=_t*(C/100)/12,Tt=yt,Mt=!0,kt=C):yt!=null&&(Tt=yt,kt=_t>0?yt*12/_t*100:0)}let k=yt||0;if(v&&Tt!=null){const u=dt-d;k=Tt*Math.pow(1+K/100,u)}if(y>0&&k<y&&(k=y),P>0&&k>P&&(k=P),R&&_t>0){const u=U.reduce((gt,Zt)=>gt+Zt.amount,0),A=_+u*O,w=_t*(et/100),tt=_t*((et+ut)/100);A<w?Ft=!0:A>=tt&&(Ft=!1),Ft&&(k=k*(1-pt/100),re=!0,Wt++)}const X=k;let rt=0,ht=k;if(T>0&&V%(T*J)===0){if(rt=Y,j){const u=V/J;rt=Y*Math.pow(1+K/100,u)}ht+=rt}if(ht>0){let u=ht;ot=ht;const A=Math.max(0,_-c);if(A>0){const w=Math.min(A,u);_-=w,u-=w,f&&(Ht+=w)}if(f&&u>0){const w=We(u,U,O,L,G,nt,h,!$,it),tt=w.netProceeds;Ut+=w.taxPaid,L=w.yearlyUsedFreibetrag,h=w.lossPot,u=w.shortfall,vt=ot-u,Ht+=tt}else if(u>0){const w=se(u,U,O,L,G,nt,h,!$,it);u=w.remaining,Ut+=w.taxPaid,L=w.yearlyUsedFreibetrag,h=w.lossPot}if(u>.01){const w=Math.min(_,u);_-=w,u-=w,f&&(Ht+=w)}u<0&&(_+=Math.abs(u),u=0),f||(vt=ot-Math.max(0,u))}if(ot>0&&vt<ot){const u=vt/ot;zt=X*u}else zt=X}let Kt=0;if(Ot===12){if(bt>0){const rt=Math.min(bt,h);h-=rt;const ht=bt-rt,u=Math.max(0,G-L),A=Math.min(ht,u);if(L+=A,jt=Math.max(0,ht-A)*nt,jt>.01){const tt=te(jt,_,U,O,L,G,nt,h,!$,it);_=tt.savings,L=tt.yearlyUsedFreibetrag,h=tt.lossPot,Ut+=tt.totalTaxRecorded,mt+=tt.shortfall}}const k=xt+dt,X=ve(k,z);if(X>0){const rt=dt*J,ht=.7;for(const u of U){if(u.amount<=0)continue;const A=u.monthIdx>rt,w=A?u.amount*u.price:u.amount*Gt;let tt=1;A&&(tt=(12-((u.monthIdx-1)%J+1)+1)/12);const gt=w*(X/100)*ht*tt,Zt=u.amount*O,ye=A?u.amount*u.price:u.amount*Gt,Te=Math.max(0,Zt-ye),Qt=Math.min(gt,Te);Qt>0&&(Kt+=Qt,u.price+=Qt/u.amount)}Kt>0&&(ct=Kt*it)}}if(Ot===12&&U.length>50){const k=Fe(U);U.length=0,U.push(...k)}const ie=U.reduce((k,X)=>k+X.amount,0)*O,ce=_+ie,Re=lt?null:ot>0?ot:null,we=ot>0?Math.max(0,ot-vt):0;!lt&&ot>0?f?Dt=Ht:Dt=vt:Dt=0;const Me=1+At;let he=ft;if(Z>0){const k=Yt/Z,X=1-k;he=k*ft+X*Me}st.push({month:V,year:dt+1,phase:lt?"Anspar":"Entnahme",savings:_,etf:ie,total:ce,total_real:ce/Et,savings_contrib:le,etf_contrib:Ct,savings_interest:Vt,withdrawal:vt,withdrawal_real:vt/Et,withdrawal_net:Dt,withdrawal_net_real:Dt/Et,withdrawal_requested:ot,shortfall:we,tax_shortfall:mt,monthly_payout:zt,monthly_payout_real:zt/Et,tax_paid:Ut,vorabpauschale_tax:Jt,payout_value:Re,payout_percent_pa:lt?null:kt,return_gain:Se+Vt,etfReturn:ft,portfolioReturn:he,cumulative_inflation:Et,capital_preservation_active:re||!1,yearly_used_freibetrag:L,loss_pot:h})}if(ct>0&&st.length>0){const V=Math.min(ct,h);h-=V;const lt=ct-V,Ot=Math.min(lt,G),Bt=Math.max(0,lt-Ot)*nt,mt=te(Bt,_,U,O,Ot,G,nt,h,!$,it);_=mt.savings,h=mt.lossPot;const Yt=U.reduce((ft,qt)=>ft+qt.amount,0)*O,Z=st[st.length-1];Z.savings=_,Z.etf=Yt,Z.total=Z.savings+Z.etf,Z.total_real=Z.total/Z.cumulative_inflation,Z.tax_paid+=mt.totalTaxRecorded,Z.vorabpauschale_tax=(Z.vorabpauschale_tax||0)+mt.taxPaidOriginal,Z.pending_vorabpauschale_tax=mt.taxPaidOriginal,Z.loss_pot=h,mt.shortfall>.01&&(Z.tax_shortfall=(Z.tax_shortfall||0)+mt.shortfall),_<0&&(_=0)}return st.length>0&&(st.capitalPreservationMonths=Wt,st.capitalPreservationEnabled=R),st}function Ce(t,s,n={}){var Rt,it,wt,nt,st,_,O,U,It,At,r,D;const i=((Rt=t[0])==null?void 0:Rt.length)||0,l=t.length,M=s.savings_years*J,o=s.savings_target??0,p=s.monthly_payout_net||0,I=p>0?p*12:100,W=n.successThreshold??I,g=(n.ruinThresholdPercent??10)/100,c=t.map(e=>{var a;return((a=e[e.length-1])==null?void 0:a.total)||0}).sort((e,a)=>e-a),b=t.map(e=>{var a;return((a=e[e.length-1])==null?void 0:a.total_real)||0}).sort((e,a)=>e-a),d=t.map(e=>{var a;return((a=e[e.length-1])==null?void 0:a.loss_pot)||0}).sort((e,a)=>e-a),B=t.map(e=>{var a;return((a=e[e.length-1])==null?void 0:a.yearly_used_freibetrag)||0}).sort((e,a)=>e-a),N=Math.min(M-1,i-1),C=t.map(e=>{var a;return((a=e[N])==null?void 0:a.total)||0}).sort((e,a)=>e-a),y=t.map(e=>{var a;return((a=e[N])==null?void 0:a.total_real)||0}).sort((e,a)=>e-a),P=[],v=[],F=[],E=[],q=[],Y=[],T=[],j=[];for(const e of t){const a=e.filter(S=>S.phase==="Entnahme"&&((S.withdrawal||0)>0||(S.withdrawal_net||0)>0));a.length>0&&(F.push(a.reduce((S,x)=>S+(x.withdrawal||0),0)/a.length),E.push(a.reduce((S,x)=>S+(x.withdrawal_real||0),0)/a.length),P.push(a.reduce((S,x)=>S+(x.withdrawal_net||0),0)/a.length),v.push(a.reduce((S,x)=>S+(x.withdrawal_net_real||0),0)/a.length),T.push(e.reduce((S,x)=>S+(x.withdrawal||0),0)),j.push(e.reduce((S,x)=>S+(x.withdrawal_real||0),0)),q.push(e.reduce((S,x)=>S+(x.withdrawal_net||0),0)),Y.push(e.reduce((S,x)=>S+(x.withdrawal_net_real||0),0)))}P.sort((e,a)=>e-a),v.sort((e,a)=>e-a),F.sort((e,a)=>e-a),E.sort((e,a)=>e-a),q.sort((e,a)=>e-a),Y.sort((e,a)=>e-a),T.sort((e,a)=>e-a),j.sort((e,a)=>e-a);let K=0,G=0,Q=0,z=0,$=0,f=0,R=0;const et=[],pt=.01,ut=50;for(const e of t){const a=e[e.length-1],S=(a==null?void 0:a.total)||0,x=(a==null?void 0:a.cumulative_inflation)||1,L=W*x,Lt=S>L,Mt=e[N],yt=(Mt==null?void 0:Mt.total)||0,kt=(Mt==null?void 0:Mt.total_real)||0,_t=(a==null?void 0:a.total_real)||0;let Tt=null;if(o<=0)Tt=0;else for(let h=0;h<i&&h<e.length;h++)if((((it=e[h])==null?void 0:it.savings)||0)>=o){Tt=((wt=e[h])==null?void 0:wt.month)??h+1;break}Tt!==null&&et.push(Tt/12);let Et=!1,Ft=!1;for(let h=0;h<M&&h<i&&h<e.length;h++)if((((nt=e[h])==null?void 0:nt.shortfall)||0)>ut||(((st=e[h])==null?void 0:st.tax_shortfall)||0)>ut){Et=!0;break}for(let h=M;h<i&&h<e.length;h++){const bt=((_=e[h])==null?void 0:_.withdrawal_requested)||0,ct=((O=e[h])==null?void 0:O.shortfall)||0,V=((U=e[h])==null?void 0:U.tax_shortfall)||0,lt=Math.max(ut,bt*pt);if(ct>lt||V>lt){Ft=!0;break}}Et&&f++,Ft&&R++;let Wt=!1;const Gt=yt*g;for(let h=M;h<i&&h<e.length;h++){const bt=((It=e[h])==null?void 0:It.withdrawal_requested)||0,ct=Math.max(ut,bt*pt),V=((At=e[h])==null?void 0:At.shortfall)||0,lt=((r=e[h])==null?void 0:r.tax_shortfall)||0,dt=V>ct||lt>ct;if((((D=e[h])==null?void 0:D.total)||0)<Gt||dt){Wt=!0;break}}Wt&&Q++,Lt&&!Ft&&!Wt&&K++,Lt&&!Wt&&G++,S>=yt&&z++,_t>=kt&&$++}const St=[],at={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]},H={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]};for(let e=0;e<i;e++){St.push(e+1);const a=t.map(x=>{var L;return((L=x[e])==null?void 0:L.total)||0}).sort((x,L)=>x-L),S=t.map(x=>{var L;return((L=x[e])==null?void 0:L.total_real)||0}).sort((x,L)=>x-L);at.p5.push(m(a,5)),at.p10.push(m(a,10)),at.p25.push(m(a,25)),at.p50.push(m(a,50)),at.p75.push(m(a,75)),at.p90.push(m(a,90)),at.p95.push(m(a,95)),H.p5.push(m(S,5)),H.p10.push(m(S,10)),H.p25.push(m(S,25)),H.p50.push(m(S,50)),H.p75.push(m(S,75)),H.p90.push(m(S,90)),H.p95.push(m(S,95))}const xt=Le(t,s);et.sort((e,a)=>e-a);const Pt=et.length/l*100,Nt=et.length>0?m(et,50):null;return{iterations:l,months:St,percentiles:at,percentilesReal:H,savingsYears:s.savings_years,medianEnd:m(c,50),meanEnd:c.reduce((e,a)=>e+a,0)/l,p5End:m(c,5),p10End:m(c,10),p25End:m(c,25),p75End:m(c,75),p90End:m(c,90),p95End:m(c,95),medianEndReal:m(b,50),meanEndReal:b.reduce((e,a)=>e+a,0)/l,p5EndReal:m(b,5),p10EndReal:m(b,10),p25EndReal:m(b,25),p75EndReal:m(b,75),p90EndReal:m(b,90),p95EndReal:m(b,95),retirementMedian:m(C,50),retirementMedianReal:m(y,50),medianAvgWithdrawalNet:P.length>0?m(P,50):0,medianAvgWithdrawalNetReal:v.length>0?m(v,50):0,medianAvgWithdrawalGross:F.length>0?m(F,50):0,medianAvgWithdrawalGrossReal:E.length>0?m(E,50):0,medianTotalWithdrawalNet:q.length>0?m(q,50):0,medianTotalWithdrawalNetReal:Y.length>0?m(Y,50):0,medianTotalWithdrawalGross:T.length>0?m(T,50):0,medianTotalWithdrawalGrossReal:j.length>0?m(j,50):0,successRate:K/l*100,softSuccessRate:G/l*100,ruinProbability:Q/l*100,capitalPreservationRate:z/l*100,capitalPreservationRateReal:$/l*100,ansparShortfallRate:f/l*100,entnahmeShortfallRate:R/l*100,emergencyFillProbability:Pt,emergencyNeverFillProbability:100-Pt,emergencyMedianFillYears:Nt,medianFinalLossPot:m(d,50),medianFinalYearlyFreibetrag:m(B,50),sorr:xt,mcOptions:n}}function Le(t,s){var K,G,Q,z,$;t.length;const n=s.savings_years*J,i=(s.savings_years+s.withdrawal_years)*J,l=Math.min(5,s.withdrawal_years),M=l*12,o=[];for(const f of t){if(f.length<n)continue;const R=((K=f[n-1])==null?void 0:K.total)||((G=f[n])==null?void 0:G.total)||0;if(R<=0)continue;let et=1;const pt=Math.min(n+M-1,i-1,f.length-1);for(let H=n;H<=pt;H++){const xt=((Q=f[H])==null?void 0:Q.portfolioReturn)||((z=f[H])==null?void 0:z.etfReturn)||1;et*=xt}const ut=pt-n+1,St=ut>0?Math.pow(et,12/ut)-1:0,at=(($=f[f.length-1])==null?void 0:$.total)||0;o.push({startWealth:R,earlyReturn:St,endWealth:at})}if(o.length<10)return{sorRiskScore:0,earlyBadImpact:0,earlyGoodImpact:0,correlationEarlyReturns:0,worstSequenceEnd:0,bestSequenceEnd:0,vulnerabilityWindow:l};o.sort((f,R)=>f.earlyReturn-R.earlyReturn);const p=Math.floor(o.length/5),I=o.slice(0,p),W=o.slice(-p),g=o.reduce((f,R)=>f+R.endWealth,0)/o.length,c=I.reduce((f,R)=>f+R.endWealth,0)/I.length,b=W.reduce((f,R)=>f+R.endWealth,0)/W.length,d=o.reduce((f,R)=>f+R.startWealth,0)/o.length,B=d>0?(g-c)/d*100:0,N=d>0?(b-g)/d*100:0,C=B+N,y=o.length,P=o.reduce((f,R)=>f+R.earlyReturn,0),v=o.reduce((f,R)=>f+R.endWealth,0),F=o.reduce((f,R)=>f+R.earlyReturn*R.endWealth,0),E=o.reduce((f,R)=>f+R.earlyReturn*R.earlyReturn,0),q=o.reduce((f,R)=>f+R.endWealth*R.endWealth,0),Y=y*F-P*v,T=Math.sqrt((y*E-P*P)*(y*q-v*v)),j=T>0?Y/T:0;return{sorRiskScore:Math.abs(C),earlyBadImpact:B,earlyGoodImpact:N,correlationEarlyReturns:j,worstSequenceEnd:c,bestSequenceEnd:b,vulnerabilityWindow:l}}const ke=100,Ge=12,Oe=10,fe=.01,Xt=50;function Ye(t,s,n={},i=null,l=null,M=null){var H,xt,Pt,Nt,Rt,it,wt,nt,st,_,O,U,It,At;const o=i??s.savings_years*J,p=l??(s.savings_years+s.withdrawal_years)*J,I=M??s.savings_target??0,W=s.monthly_payout_net||0,g=W>0?W*Ge:ke,c=n.successThreshold??g,b=(n.ruinThresholdPercent??Oe)/100,d=t[t.length-1],B=(d==null?void 0:d.total)||0,N=(d==null?void 0:d.cumulative_inflation)||1,C=c*N,y=B>C;let P=null;if(I<=0)P=0;else for(let r=0;r<Math.min(p,t.length);r++)if((((H=t[r])==null?void 0:H.savings)||0)>=I){P=((xt=t[r])==null?void 0:xt.month)??r+1;break}let v=!1,F=!1;for(let r=0;r<o&&r<p&&r<t.length;r++)if((((Pt=t[r])==null?void 0:Pt.shortfall)||0)>Xt||(((Nt=t[r])==null?void 0:Nt.tax_shortfall)||0)>Xt){v=!0;break}for(let r=o;r<p&&r<t.length;r++){const D=((Rt=t[r])==null?void 0:Rt.withdrawal_requested)||0,e=((it=t[r])==null?void 0:it.shortfall)||0,a=((wt=t[r])==null?void 0:wt.tax_shortfall)||0,S=Math.max(Xt,D*fe);if(e>S||a>S){F=!0;break}}let E=!1;const q=Math.min(o-1,p-1),Y=((nt=t[q])==null?void 0:nt.total)||0,T=Y*b;for(let r=o;r<p&&r<t.length;r++){const D=((st=t[r])==null?void 0:st.withdrawal_requested)||0,e=Math.max(Xt,D*fe),a=((_=t[r])==null?void 0:_.shortfall)||0,S=((O=t[r])==null?void 0:O.tax_shortfall)||0,x=a>e||S>e;if((((U=t[r])==null?void 0:U.total)||0)<T||x){E=!0;break}}const j=((It=t[q])==null?void 0:It.total_real)||0,K=((At=t[p-1])==null?void 0:At.total_real)||0,G=B>=Y,Q=K>=j,z=t.filter(r=>r.phase==="Entnahme"&&((r.withdrawal||0)>0||(r.withdrawal_net||0)>0));let $=0,f=0,R=0,et=0,pt=0,ut=0,St=0,at=0;return z.length>0&&(R=z.reduce((r,D)=>r+(D.withdrawal||0),0)/z.length,et=z.reduce((r,D)=>r+(D.withdrawal_real||0),0)/z.length,$=z.reduce((r,D)=>r+(D.withdrawal_net||0),0)/z.length,f=z.reduce((r,D)=>r+(D.withdrawal_net_real||0),0)/z.length,St=t.reduce((r,D)=>r+(D.withdrawal||0),0),at=t.reduce((r,D)=>r+(D.withdrawal_real||0),0),pt=t.reduce((r,D)=>r+(D.withdrawal_net||0),0),ut=t.reduce((r,D)=>r+(D.withdrawal_net_real||0),0)),{hasPositiveEnd:y,hasAnsparShortfall:v,hasEntnahmeShortfall:F,isRuin:E,capitalPreserved:G,capitalPreservedReal:Q,firstFillMonth:P,avgWithdrawalNet:$,avgWithdrawalNetReal:f,avgWithdrawalGross:R,avgWithdrawalGrossReal:et,totalWithdrawalNet:pt,totalWithdrawalNetReal:ut,totalWithdrawalGross:St,totalWithdrawalGrossReal:at}}function Ue(t,s,n=null,i=null){var B,N,C,y,P;const l=n??s.savings_years*J,M=i??(s.savings_years+s.withdrawal_years)*J,p=Math.min(5,s.withdrawal_years)*12,I=((B=t[l-1])==null?void 0:B.total)||((N=t[l])==null?void 0:N.total)||0;let W=1;const g=Math.min(l+p-1,M-1);for(let v=l;v<=g&&v<t.length;v++){const F=((C=t[v])==null?void 0:C.portfolioReturn)||((y=t[v])==null?void 0:y.etfReturn)||1;W*=F}const c=g-l+1,b=c>0?Math.pow(W,12/c)-1:0,d=((P=t[M-1])==null?void 0:P.total)||0;return{startWealth:I,earlyReturn:b,endWealth:d}}const De=100,Be=10;function qe(t,s,n,i={}){const l=[];i.seed!=null?ae(ne(i.seed)):ae(ne(Date.now()+Math.random()*1e6));for(let p=0;p<s;p+=50){const I=Math.min(p+50,s);for(let g=p;g<I;g++){const c=pe(t,n);l.push(c)}const W=Math.round(I/s*100);self.postMessage({type:"progress",current:I,total:s,percent:W})}const o=Ce(l,t,i);return o.volatility=n,o.allHistories=l.slice(0,50),o.mcOptions=i,o}function Ve(t,s,n,i,l,M,o,p){var N,C;let W=0;const g=t.savings_years*J,c=(t.savings_years+t.withdrawal_years)*J,b=t.savings_target??0,d={finalTotals:[],finalTotalsReal:[],finalLossPot:[],finalYearlyFreibetrag:[],retirementTotals:[],retirementTotalsReal:[],simResults:[],sorrData:[],monthlyTotals:[],monthlyTotalsReal:[]},B=[];for(let y=0;y<c;y++)d.monthlyTotals.push([]),d.monthlyTotalsReal.push([]);for(let y=0;y<l;y++){const P=i+y;ae(ne(p+P));const v={};n.stressScenario&&n.stressScenario!=="none"&&(v.stressScenario=n.stressScenario);const F=pe(t,s,v),E=F[F.length-1],q=Math.min(g-1,c-1),Y=F[q];d.finalTotals.push((E==null?void 0:E.total)||0),d.finalTotalsReal.push((E==null?void 0:E.total_real)||0),d.finalLossPot.push((E==null?void 0:E.loss_pot)||0),d.finalYearlyFreibetrag.push((E==null?void 0:E.yearly_used_freibetrag)||0),d.retirementTotals.push((Y==null?void 0:Y.total)||0),d.retirementTotalsReal.push((Y==null?void 0:Y.total_real)||0);for(let T=0;T<c&&T<F.length;T++)d.monthlyTotals[T].push(((N=F[T])==null?void 0:N.total)||0),d.monthlyTotalsReal[T].push(((C=F[T])==null?void 0:C.total_real)||0);if(d.simResults.push(Ye(F,t,n,g,c,b)),d.sorrData.push(Ue(F,t,g,c)),B.length<Be&&B.push(F),(y+1)%50===0||y===l-1){const T=Date.now();(T-W>=De||y===l-1)&&(W=T,self.postMessage({type:"chunk-progress",workerId:o,completedInChunk:y+1,chunkSize:l,totalIterations:M}))}}return{rawData:d,samplePaths:B}}self.onmessage=function(t){const{type:s}=t.data;try{switch(s){case"start":{const{params:n,iterations:i,volatility:l,mcOptions:M}=t.data;if(!n)throw new Error("Keine Parameter übergeben");const o=qe(n,i||1e3,l||15,M||{});self.postMessage({type:"complete",results:o});break}case"run-chunk":{const{params:n,volatility:i,mcOptions:l,startIdx:M,count:o,totalIterations:p,workerId:I,baseSeed:W}=t.data;if(!n)throw new Error("Keine Parameter übergeben");const{rawData:g,samplePaths:c}=Ve(n,i||15,l||{},M,o,p,I,W);self.postMessage({type:"chunk-complete",workerId:I,rawData:g,samplePaths:c});break}default:self.postMessage({type:"error",message:`Unbekannter Nachrichtentyp: ${s}`})}}catch(n){self.postMessage({type:"error",message:n.message||"Unbekannter Fehler bei der Monte-Carlo-Simulation"})}};
