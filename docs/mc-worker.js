/**
 * ETF Simulator - Monte-Carlo Web Worker
 * Bundled: 2025-12-08T16:40:30.108Z
 * Source: src/mc-worker-entry.js
 */
(()=>{var te={aktien:.7,misch:.85,renten:1},ge=1e3;var ee=.08,ae=.09,C=12,Re=100,_e={2025:2.53,2024:2.29,2023:2.55,2022:-.05,2021:-.45,2020:.07,2019:.52,2018:.87};function we(t,a=2.53){return _e[t]!==void 0?_e[t]:a}var Ee={none:{name:"Standard (Zuf\xE4llig)",description:"Normale Monte-Carlo-Simulation mit zuf\xE4lligen Renditen",returns:null},early_crash:{name:"Fr\xFCher Crash",description:"-30% im 1. Rentenjahr, langsame Erholung \xFCber 5 Jahre",returns:[-.3,-.1,.05,.08,.1,.12,.08,.07,.06,.06]},sideways:{name:"Seitw\xE4rtsmarkt",description:"0% Realrendite \xFCber 10 Jahre",returns:[.02,.01,-.01,.02,0,-.02,.03,-.01,.01,0]},bear_market:{name:"B\xE4renmarkt-Phase",description:"3-5 Jahre leicht negative Renditen, danach normal",returns:[-.05,-.08,-.03,-.02,.02,.08,.1,.07,.06,.06]},late_crash:{name:"Sp\xE4ter Crash",description:"Normaler Start, Crash nach 5 Jahren",returns:[.08,.1,.07,.09,.06,-.35,-.15,.1,.12,.08]}};var oe=Math.random;function Ht(t){oe=t}function ne(t){return Math.pow(1+t/100,1/C)-1}function ke(t){return t/Math.sqrt(12)}function Ye(t=0){let a=.25*(1+.055);return t===0?a:t===ee?.27818:t===ae?.27995:a+.25*t}function Ge(t=0,a=1){let n,l;do n=oe(),l=oe();while(n===0);return Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*l)*a+t}function Vt(t){let a=t;return function(){a|=0,a=a+1831565813|0;let n=Math.imul(a^a>>>15,1|a);return n=n+Math.imul(n^n>>>7,61|n)^n,((n^n>>>14)>>>0)/4294967296}}function d(t,a){if(t.length===0)return 0;let n=a/100*(t.length-1),l=Math.floor(n),o=Math.ceil(n);return l===o?t[l]:t[l]*(o-n)+t[o]*(n-l)}function Oe(t,a=.01){if(t.length<=1)return t;let n=new Map;for(let l of t){if(l.amount<=0)continue;let _=(Math.round(l.price/a)*a).toFixed(4);if(n.has(_)){let f=n.get(_),i=f.amount+l.amount,P=(f.price*f.amount+l.price*l.amount)/i;f.amount=i,f.price=P,f.monthIdx=Math.min(f.monthIdx,l.monthIdx)}else n.set(_,{...l})}return Array.from(n.values()).sort((l,o)=>l.monthIdx-o.monthIdx)}function re(t,a,n,l,o,_,f=0,i=!0,P=.7){let I=0,p=l,h=f,M=0,g=0;for(;t>.01&&a.length;){let A=i?0:a.length-1,S=a[A],W=n-S.price,O=Math.max(0,o-p),w;if(W>0){let G=W*P,z=Math.min(G>0?h/G:Number.POSITIVE_INFINITY,S.amount),J=Math.min(G>0?O/G:Number.POSITIVE_INFINITY,S.amount-z),c=z+J,m=t/n;if(m<=c)w=m;else{let H=c*n,j=t-H,Q=G*_,st=n-Q;if(st<=0)break;let tt=j/st;w=c+tt}}else w=t/n;let F=Math.min(w,S.amount);M+=F*n;let L=F*W*P;g+=L;let T=0;if(L>0){let G=Math.min(L,h);h-=G;let z=L-G,J=Math.max(0,o-p),c=Math.min(z,J);p+=c,T=(z-c)*_}else L<0&&(h+=Math.abs(L));let K=F*n-T;t-=K,I+=T,w>=S.amount?i?a.shift():a.pop():S.amount-=F}return{remaining:t,taxPaid:I,yearlyUsedFreibetrag:p,lossPot:h,grossProceeds:M,taxableGainTotal:g}}function Ue(t,a,n,l,o,_,f=0,i=!0,P=.7){let I=0,p=l,h=f,M=t,g=0;for(;M>.01&&a.length;){let S=i?0:a.length-1,W=a[S],O=n-W.price,w=M/n,F=Math.min(w,W.amount),D=F*n,T=F*O*P,K=0;if(T>0){let z=Math.min(T,h);h-=z;let J=T-z,c=Math.max(0,o-p),m=Math.min(J,c);p+=m,K=(J-m)*_}else T<0&&(h+=Math.abs(T));let G=D-K;g+=G,I+=K,M-=D,w>=W.amount?i?a.shift():a.pop():W.amount-=F}let A=M>.01?M:0;return{netProceeds:g,taxPaid:I,yearlyUsedFreibetrag:p,lossPot:h,shortfall:A}}function se(t,a,n,l,o,_,f,i=0,P=!0,I=.7){if(t<=0)return{savings:a,yearlyUsedFreibetrag:o,lossPot:i,taxPaidOriginal:0,saleTax:0,totalTaxRecorded:0,shortfall:0};let p=t,h=i,M=Math.min(a,p);a-=M,p-=M;let g=0;if(p>.01&&n.length){let O=re(p,n,l,o,_,f,h,P,I);p=O.remaining,g=O.taxPaid,o=O.yearlyUsedFreibetrag,h=O.lossPot}p=Math.max(0,p);let A=t-p,S=p>.01?p:0,W=A+g;return{savings:a,yearlyUsedFreibetrag:o,lossPot:h,taxPaidOriginal:A,saleTax:g,totalTaxRecorded:W,shortfall:S}}function De(t,a,n,l){let o=Ee[t];if(!o||!o.returns)return null;let _=a-n;if(_<=0)return null;let f=Math.floor((_-1)/12);if(f<o.returns.length){let i=o.returns[f];return Math.pow(1+i,1/12)}return null}function le(t,a=0,n={}){let{start_savings:l,start_etf:o,start_etf_cost_basis:_=0,monthly_savings:f,monthly_etf:i,savings_rate_pa:P,etf_rate_pa:I,etf_ter_pa:p=0,savings_target:h,annual_raise_percent:M,savings_years:g,withdrawal_years:A,monthly_payout_net:S,monthly_payout_percent:W,withdrawal_min:O=0,withdrawal_max:w=0,inflation_adjust_withdrawal:F=!0,special_payout_net_savings:D,special_interval_years_savings:L,inflation_adjust_special_savings:T=!0,special_payout_net_withdrawal:K,special_interval_years_withdrawal:G,inflation_adjust_special_withdrawal:z=!0,inflation_rate_pa:J=0,sparerpauschbetrag:c=ge,kirchensteuer:m="keine",basiszins:H=2.53,use_lifo:j=!1,rent_is_gross:Q=!1,capital_preservation_enabled:st=!1,capital_preservation_threshold:tt=80,capital_preservation_reduction:lt=25,capital_preservation_recovery:ct=10,loss_pot:Et=0,fondstyp:ot="aktien"}=t,{stressScenario:r="none",startYear:k=new Date().getFullYear()}=n,ft=a>0,yt=r&&r!=="none",e=ft?ke(a/100):0,s=te[ot]||te.aktien,v=0;m==="8"?v=ee:m==="9"&&(v=ae);let E=Ye(v),et=[],y=l,Y=Re,U=[];if(o>0){let $=o/Y,pt=(_>0?_:o)/$;U.push({amount:$,price:pt,monthIdx:0})}let qt=I-p,Ct=ne(P),gt=ne(qt),Lt=ne(J),Pt=M/100,vt=(g+A)*C,kt=g*C,x=y>=h,q=0,St=0,Tt=!1,ht=S,At=W,Rt=null,Yt=null,xt=1,$t=!1,ie=0,Me=o,Kt=Y,ce=0,V=Et,It=0,be=0,wt=0;for(let $=1;$<=vt;$+=1){let mt=$<=kt,pt=Math.floor(($-1)/C),Ft=($-1)%C+1,Jt=0,Gt=0,ut=0;xt*=1+Lt;let Mt=U.reduce((N,B)=>N+B.amount,0)*Y,X=y+Mt;if(pt!==St){if(q=0,ce=0,wt>0){let N=Math.min(wt,V);V-=N;let B=wt-N,rt=Math.min(B,c);q=rt;let b=Math.max(0,B-rt)*E,R=se(b,y,U,Y,q,c,E,V,!j,s);y=R.savings,q=R.yearlyUsedFreibetrag,V=R.lossPot,Jt=R.taxPaidOriginal,ce=R.taxPaidOriginal,Gt+=R.totalTaxRecorded,ut+=R.shortfall}St=pt,Me=Mt,Kt=Y,It=0,be=0,wt=0}let it,Ot=yt?De(r,$,kt,gt):null;if(Ot!==null)it=Ot,Y*=it;else if(ft){let B=Math.log(1+gt)-.5*e*e,nt=Ge(0,1);it=Math.exp(B+e*nt),Y*=it}else it=1+gt,Y*=it;let Ae=Mt*(it-1),Ut=y*Ct,Xt=0;It+=Ut,y+=Ut;let he=0,bt=0,ue=0,at=0,Nt=Gt,_t=0,Wt=0,Dt=0,de=!1,zt=0;if(mt){let N=Math.pow(1+Pt,pt),B=f*N,nt=i*N;if(x?bt=nt+B:(y+=B,he=B,bt=nt),y>h&&(ue=y-h,y=h,bt+=ue,x=!0),bt>0){let u=bt/Y;U.push({amount:u,price:Y,monthIdx:$})}if(L>0&&$%(L*C)===0&&$>0){let u=D;if(T){let dt=$/C;u=D*Math.pow(1+J/100,dt)}let b=u;at=b;let R=Math.max(0,y-h);if(R>0){let dt=Math.min(R,b);y-=dt,b-=dt}let Z=re(b,U,Y,q,c,E,V,!j,s);if(b=Z.remaining,Nt+=Z.taxPaid,q=Z.yearlyUsedFreibetrag,V=Z.lossPot,b>.01){let dt=Math.min(y,b);y-=dt,b-=dt,y<h&&(x=!1)}b<0&&(y+=Math.abs(b),b=0),_t=at-Math.max(0,b)}}else{if(Rt===null){let u=U.reduce((b,R)=>b+R.amount,0);Rt=y+u*Y,W!=null&&!Tt?(ht=Rt*(W/100)/12,Yt=ht,Tt=!0,At=W):ht!=null&&(Yt=ht,At=Rt>0?ht*12/Rt*100:0)}let N=ht||0;if(F&&Yt!=null){let u=pt-g;N=Yt*Math.pow(1+J/100,u)}if(O>0&&N<O&&(N=O),w>0&&N>w&&(N=w),st&&Rt>0){let u=U.reduce((dt,Zt)=>dt+Zt.amount,0),b=y+u*Y,R=Rt*(tt/100),Z=Rt*((tt+ct)/100);b<R?$t=!0:b>=Z&&($t=!1),$t&&(N=N*(1-lt/100),de=!0,ie++)}let B=N,nt=0,rt=N;if(G>0&&$%(G*C)===0){if(nt=K,z){let u=$/C;nt=K*Math.pow(1+J/100,u)}rt+=nt}if(rt>0){let u=rt;at=rt;let b=Math.max(0,y-h);if(b>0){let R=Math.min(b,u);y-=R,u-=R,Q&&(zt+=R)}if(Q&&u>0){let R=Ue(u,U,Y,q,c,E,V,!j,s),Z=R.netProceeds;Nt+=R.taxPaid,q=R.yearlyUsedFreibetrag,V=R.lossPot,u=R.shortfall,_t=at-u,zt+=Z}else if(u>0){let R=re(u,U,Y,q,c,E,V,!j,s);u=R.remaining,Nt+=R.taxPaid,q=R.yearlyUsedFreibetrag,V=R.lossPot}if(u>.01){let R=Math.min(y,u);y-=R,u-=R,Q&&(zt+=R)}u<0&&(y+=Math.abs(u),u=0),Q||(_t=at-Math.max(0,u))}if(at>0&&_t<at){let u=_t/at;Dt=B*u}else Dt=B}let jt=0;if(Ft===12){if(It>0){let nt=Math.min(It,V);V-=nt;let rt=It-nt,u=Math.max(0,c-q),b=Math.min(rt,u);if(q+=b,Xt=Math.max(0,rt-b)*E,Xt>.01){let Z=se(Xt,y,U,Y,q,c,E,V,!j,s);y=Z.savings,q=Z.yearlyUsedFreibetrag,V=Z.lossPot,Nt+=Z.totalTaxRecorded,ut+=Z.shortfall}}let N=k+pt,B=we(N,H);if(B>0){let nt=pt*C,rt=.7;for(let u of U){if(u.amount<=0)continue;let b=u.monthIdx>nt,R=b?u.amount*u.price:u.amount*Kt,Z=1;b&&(Z=(12-((u.monthIdx-1)%C+1)+1)/12);let dt=R*(B/100)*rt*Z,Zt=u.amount*Y,We=b?u.amount*u.price:u.amount*Kt,Ce=Math.max(0,Zt-We),Qt=Math.min(dt,Ce);Qt>0&&(jt+=Qt,u.price+=Qt/u.amount)}jt>0&&(wt=jt*s)}}if(Ft===12&&U.length>50){let N=Oe(U);U.length=0,U.push(...N)}let fe=U.reduce((N,B)=>N+B.amount,0)*Y,pe=y+fe,Ie=mt?null:at>0?at:null,Fe=at>0?Math.max(0,at-_t):0;!mt&&at>0?Q?Wt=zt:Wt=_t:Wt=0;let Ne=1+Ct,me=it;if(X>0){let N=Mt/X,B=1-N;me=N*it+B*Ne}et.push({month:$,year:pt+1,phase:mt?"Anspar":"Entnahme",savings:y,etf:fe,total:pe,total_real:pe/xt,savings_contrib:he,etf_contrib:bt,savings_interest:Ut,withdrawal:_t,withdrawal_real:_t/xt,withdrawal_net:Wt,withdrawal_net_real:Wt/xt,withdrawal_requested:at,shortfall:Fe,tax_shortfall:ut,monthly_payout:Dt,monthly_payout_real:Dt/xt,tax_paid:Nt,vorabpauschale_tax:Jt,payout_value:Ie,payout_percent_pa:mt?null:At,return_gain:Ae+Ut,etfReturn:it,portfolioReturn:me,cumulative_inflation:xt,capital_preservation_active:de||!1,yearly_used_freibetrag:q,loss_pot:V})}if(wt>0&&et.length>0){let $=Math.min(wt,V);V-=$;let mt=wt-$,Ft=Math.min(mt,c),Gt=Math.max(0,mt-Ft)*E,ut=se(Gt,y,U,Y,Ft,c,E,V,!j,s);y=ut.savings,V=ut.lossPot;let Mt=U.reduce((it,Ot)=>it+Ot.amount,0)*Y,X=et[et.length-1];X.savings=y,X.etf=Mt,X.total=X.savings+X.etf,X.total_real=X.total/X.cumulative_inflation,X.tax_paid+=ut.totalTaxRecorded,X.vorabpauschale_tax=(X.vorabpauschale_tax||0)+ut.taxPaidOriginal,X.pending_vorabpauschale_tax=ut.taxPaidOriginal,X.loss_pot=V,ut.shortfall>.01&&(X.tax_shortfall=(X.tax_shortfall||0)+ut.shortfall),y<0&&(y=0)}return et.length>0&&(et.capitalPreservationMonths=ie,et.capitalPreservationEnabled=st),et}function Se(t,a,n={}){let l=t[0]?.length||0,o=t.length,_=a.savings_years*C,f=a.savings_target??0,i=a.monthly_payout_net||0,P=i>0?i*12:100,I=n.successThreshold??P,p=(n.ruinThresholdPercent??10)/100,h=t.map(e=>e[e.length-1]?.total||0).sort((e,s)=>e-s),M=t.map(e=>e[e.length-1]?.total_real||0).sort((e,s)=>e-s),g=t.map(e=>e[e.length-1]?.loss_pot||0).sort((e,s)=>e-s),A=t.map(e=>e[e.length-1]?.yearly_used_freibetrag||0).sort((e,s)=>e-s),S=Math.min(_-1,l-1),W=t.map(e=>e[S]?.total||0).sort((e,s)=>e-s),O=t.map(e=>e[S]?.total_real||0).sort((e,s)=>e-s),w=[],F=[],D=[],L=[],T=[],K=[],G=[],z=[];for(let e of t){let s=e.filter(v=>v.phase==="Entnahme"&&((v.withdrawal||0)>0||(v.withdrawal_net||0)>0));s.length>0&&(D.push(s.reduce((v,E)=>v+(E.withdrawal||0),0)/s.length),L.push(s.reduce((v,E)=>v+(E.withdrawal_real||0),0)/s.length),w.push(s.reduce((v,E)=>v+(E.withdrawal_net||0),0)/s.length),F.push(s.reduce((v,E)=>v+(E.withdrawal_net_real||0),0)/s.length),G.push(e.reduce((v,E)=>v+(E.withdrawal||0),0)),z.push(e.reduce((v,E)=>v+(E.withdrawal_real||0),0)),T.push(e.reduce((v,E)=>v+(E.withdrawal_net||0),0)),K.push(e.reduce((v,E)=>v+(E.withdrawal_net_real||0),0)))}w.sort((e,s)=>e-s),F.sort((e,s)=>e-s),D.sort((e,s)=>e-s),L.sort((e,s)=>e-s),T.sort((e,s)=>e-s),K.sort((e,s)=>e-s),G.sort((e,s)=>e-s),z.sort((e,s)=>e-s);let J=0,c=0,m=0,H=0,j=0,Q=0,st=0,tt=[],lt=.01,ct=50;for(let e of t){let s=e[e.length-1],v=s?.total||0,E=s?.cumulative_inflation||1,et=I*E,y=v>et,Y=e[S],U=Y?.total||0,qt=Y?.total_real||0,Ct=s?.total_real||0,gt=null;if(f<=0)gt=0;else for(let x=0;x<l&&x<e.length;x++)if((e[x]?.savings||0)>=f){gt=e[x]?.month??x+1;break}gt!==null&&tt.push(gt/12);let Lt=!1,Pt=!1;for(let x=0;x<_&&x<l&&x<e.length;x++)if((e[x]?.shortfall||0)>ct||(e[x]?.tax_shortfall||0)>ct){Lt=!0;break}for(let x=_;x<l&&x<e.length;x++){let q=e[x]?.withdrawal_requested||0,St=e[x]?.shortfall||0,Tt=e[x]?.tax_shortfall||0,ht=Math.max(ct,q*lt);if(St>ht||Tt>ht){Pt=!0;break}}Lt&&Q++,Pt&&st++;let vt=!1,kt=U*p;for(let x=_;x<l&&x<e.length;x++){let q=e[x]?.withdrawal_requested||0,St=Math.max(ct,q*lt),Tt=e[x]?.shortfall||0,ht=e[x]?.tax_shortfall||0,At=Tt>St||ht>St;if((e[x]?.total||0)<kt||At){vt=!0;break}}vt&&m++,y&&!Pt&&!vt&&J++,y&&!vt&&c++,v>=U&&H++,Ct>=qt&&j++}let Et=[],ot={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]},r={p5:[],p10:[],p25:[],p50:[],p75:[],p90:[],p95:[]};for(let e=0;e<l;e++){Et.push(e+1);let s=t.map(E=>E[e]?.total||0).sort((E,et)=>E-et),v=t.map(E=>E[e]?.total_real||0).sort((E,et)=>E-et);ot.p5.push(d(s,5)),ot.p10.push(d(s,10)),ot.p25.push(d(s,25)),ot.p50.push(d(s,50)),ot.p75.push(d(s,75)),ot.p90.push(d(s,90)),ot.p95.push(d(s,95)),r.p5.push(d(v,5)),r.p10.push(d(v,10)),r.p25.push(d(v,25)),r.p50.push(d(v,50)),r.p75.push(d(v,75)),r.p90.push(d(v,90)),r.p95.push(d(v,95))}let k=ze(t,a);tt.sort((e,s)=>e-s);let ft=tt.length/o*100,yt=tt.length>0?d(tt,50):null;return{iterations:o,months:Et,percentiles:ot,percentilesReal:r,savingsYears:a.savings_years,medianEnd:d(h,50),meanEnd:h.reduce((e,s)=>e+s,0)/o,p5End:d(h,5),p10End:d(h,10),p25End:d(h,25),p75End:d(h,75),p90End:d(h,90),p95End:d(h,95),medianEndReal:d(M,50),meanEndReal:M.reduce((e,s)=>e+s,0)/o,p5EndReal:d(M,5),p10EndReal:d(M,10),p25EndReal:d(M,25),p75EndReal:d(M,75),p90EndReal:d(M,90),p95EndReal:d(M,95),retirementMedian:d(W,50),retirementMedianReal:d(O,50),medianAvgWithdrawalNet:w.length>0?d(w,50):0,medianAvgWithdrawalNetReal:F.length>0?d(F,50):0,medianAvgWithdrawalGross:D.length>0?d(D,50):0,medianAvgWithdrawalGrossReal:L.length>0?d(L,50):0,medianTotalWithdrawalNet:T.length>0?d(T,50):0,medianTotalWithdrawalNetReal:K.length>0?d(K,50):0,medianTotalWithdrawalGross:G.length>0?d(G,50):0,medianTotalWithdrawalGrossReal:z.length>0?d(z,50):0,successRate:J/o*100,softSuccessRate:c/o*100,ruinProbability:m/o*100,capitalPreservationRate:H/o*100,capitalPreservationRateReal:j/o*100,ansparShortfallRate:Q/o*100,entnahmeShortfallRate:st/o*100,emergencyFillProbability:ft,emergencyNeverFillProbability:100-ft,emergencyMedianFillYears:yt,medianFinalLossPot:d(g,50),medianFinalYearlyFreibetrag:d(A,50),sorr:k,mcOptions:n}}function ze(t,a){let n=t.length,l=a.savings_years*C,o=(a.savings_years+a.withdrawal_years)*C,_=Math.min(5,a.withdrawal_years),f=_*12,i=[];for(let c of t){if(c.length<l)continue;let m=c[l-1]?.total||c[l]?.total||0;if(m<=0)continue;let H=1,j=Math.min(l+f-1,o-1,c.length-1);for(let lt=l;lt<=j;lt++){let ct=c[lt]?.portfolioReturn||c[lt]?.etfReturn||1;H*=ct}let Q=j-l+1,st=Q>0?Math.pow(H,12/Q)-1:0,tt=c[c.length-1]?.total||0;i.push({startWealth:m,earlyReturn:st,endWealth:tt})}if(i.length<10)return{sorRiskScore:0,earlyBadImpact:0,earlyGoodImpact:0,correlationEarlyReturns:0,worstSequenceEnd:0,bestSequenceEnd:0,vulnerabilityWindow:_};i.sort((c,m)=>c.earlyReturn-m.earlyReturn);let P=Math.floor(i.length/5),I=i.slice(0,P),p=i.slice(-P),h=i.reduce((c,m)=>c+m.endWealth,0)/i.length,M=I.reduce((c,m)=>c+m.endWealth,0)/I.length,g=p.reduce((c,m)=>c+m.endWealth,0)/p.length,A=i.reduce((c,m)=>c+m.startWealth,0)/i.length,S=A>0?(h-M)/A*100:0,W=A>0?(g-h)/A*100:0,O=S+W,w=i.length,F=i.reduce((c,m)=>c+m.earlyReturn,0),D=i.reduce((c,m)=>c+m.endWealth,0),L=i.reduce((c,m)=>c+m.earlyReturn*m.endWealth,0),T=i.reduce((c,m)=>c+m.earlyReturn*m.earlyReturn,0),K=i.reduce((c,m)=>c+m.endWealth*m.endWealth,0),G=w*L-F*D,z=Math.sqrt((w*T-F*F)*(w*K-D*D)),J=z>0?G/z:0;return{sorRiskScore:Math.abs(O),earlyBadImpact:S,earlyGoodImpact:W,correlationEarlyReturns:J,worstSequenceEnd:M,bestSequenceEnd:g,vulnerabilityWindow:_}}var na=new Intl.NumberFormat("de-DE",{maximumFractionDigits:0}),sa=new Intl.NumberFormat("de-DE",{minimumFractionDigits:1,maximumFractionDigits:1});var He=100,Ve=12,Be=10,ve=.01,Bt=50;function Te(t,a,n={},l=null,o=null,_=null){let f=l??a.savings_years*C,i=o??(a.savings_years+a.withdrawal_years)*C,P=_??a.savings_target??0,I=a.monthly_payout_net||0,p=I>0?I*Ve:He,h=n.successThreshold??p,M=(n.ruinThresholdPercent??Be)/100,g=t[t.length-1],A=g?.total||0,S=g?.cumulative_inflation||1,W=h*S,O=A>W,w=null;if(P<=0)w=0;else for(let r=0;r<Math.min(i,t.length);r++)if((t[r]?.savings||0)>=P){w=t[r]?.month??r+1;break}let F=!1,D=!1;for(let r=0;r<f&&r<i&&r<t.length;r++)if((t[r]?.shortfall||0)>Bt||(t[r]?.tax_shortfall||0)>Bt){F=!0;break}for(let r=f;r<i&&r<t.length;r++){let k=t[r]?.withdrawal_requested||0,ft=t[r]?.shortfall||0,yt=t[r]?.tax_shortfall||0,e=Math.max(Bt,k*ve);if(ft>e||yt>e){D=!0;break}}let L=!1,T=Math.min(f-1,i-1),K=t[T]?.total||0,G=K*M;for(let r=f;r<i&&r<t.length;r++){let k=t[r]?.withdrawal_requested||0,ft=Math.max(Bt,k*ve),yt=t[r]?.shortfall||0,e=t[r]?.tax_shortfall||0,s=yt>ft||e>ft;if((t[r]?.total||0)<G||s){L=!0;break}}let z=t[T]?.total_real||0,J=t[i-1]?.total_real||0,c=A>=K,m=J>=z,H=t.filter(r=>r.phase==="Entnahme"&&((r.withdrawal||0)>0||(r.withdrawal_net||0)>0)),j=0,Q=0,st=0,tt=0,lt=0,ct=0,Et=0,ot=0;return H.length>0&&(st=H.reduce((r,k)=>r+(k.withdrawal||0),0)/H.length,tt=H.reduce((r,k)=>r+(k.withdrawal_real||0),0)/H.length,j=H.reduce((r,k)=>r+(k.withdrawal_net||0),0)/H.length,Q=H.reduce((r,k)=>r+(k.withdrawal_net_real||0),0)/H.length,Et=t.reduce((r,k)=>r+(k.withdrawal||0),0),ot=t.reduce((r,k)=>r+(k.withdrawal_real||0),0),lt=t.reduce((r,k)=>r+(k.withdrawal_net||0),0),ct=t.reduce((r,k)=>r+(k.withdrawal_net_real||0),0)),{hasPositiveEnd:O,hasAnsparShortfall:F,hasEntnahmeShortfall:D,isRuin:L,capitalPreserved:c,capitalPreservedReal:m,firstFillMonth:w,avgWithdrawalNet:j,avgWithdrawalNetReal:Q,avgWithdrawalGross:st,avgWithdrawalGrossReal:tt,totalWithdrawalNet:lt,totalWithdrawalNetReal:ct,totalWithdrawalGross:Et,totalWithdrawalGrossReal:ot}}function xe(t,a,n=null,l=null){let o=n??a.savings_years*C,_=l??(a.savings_years+a.withdrawal_years)*C,i=Math.min(5,a.withdrawal_years)*12,P=t[o-1]?.total||t[o]?.total||0,I=1,p=Math.min(o+i-1,_-1);for(let A=o;A<=p&&A<t.length;A++){let S=t[A]?.portfolioReturn||t[A]?.etfReturn||1;I*=S}let h=p-o+1,M=h>0?Math.pow(I,12/h)-1:0,g=t[_-1]?.total||0;return{startWealth:P,earlyReturn:M,endWealth:g}}var qe=100,$e=10;function Ke(t,a,n,l={}){let o=[];l.seed!=null?Ht(Vt(l.seed)):Ht(Vt(Date.now()+Math.random()*1e6));for(let i=0;i<a;i+=50){let P=Math.min(i+50,a);for(let p=i;p<P;p++){let h=le(t,n);o.push(h)}let I=Math.round(P/a*100);self.postMessage({type:"progress",current:P,total:a,percent:I})}let f=Se(o,t,l);return f.volatility=n,f.allHistories=o.slice(0,50),f.mcOptions=l,f}function Je(t,a,n,l,o,_,f,i){let I=0,p=t.savings_years*C,h=(t.savings_years+t.withdrawal_years)*C,M=t.savings_target??0,g={finalTotals:[],finalTotalsReal:[],finalLossPot:[],finalYearlyFreibetrag:[],retirementTotals:[],retirementTotalsReal:[],simResults:[],sorrData:[],monthlyTotals:[],monthlyTotalsReal:[]},A=[];for(let S=0;S<h;S++)g.monthlyTotals.push([]),g.monthlyTotalsReal.push([]);for(let S=0;S<o;S++){let W=l+S;Ht(Vt(i+W));let O={};n.stressScenario&&n.stressScenario!=="none"&&(O.stressScenario=n.stressScenario);let w=le(t,a,O),F=w[w.length-1],D=Math.min(p-1,h-1),L=w[D];g.finalTotals.push(F?.total||0),g.finalTotalsReal.push(F?.total_real||0),g.finalLossPot.push(F?.loss_pot||0),g.finalYearlyFreibetrag.push(F?.yearly_used_freibetrag||0),g.retirementTotals.push(L?.total||0),g.retirementTotalsReal.push(L?.total_real||0);for(let T=0;T<h&&T<w.length;T++)g.monthlyTotals[T].push(w[T]?.total||0),g.monthlyTotalsReal[T].push(w[T]?.total_real||0);if(g.simResults.push(Te(w,t,n,p,h,M)),g.sorrData.push(xe(w,t,p,h)),A.length<$e&&A.push(w),(S+1)%50===0||S===o-1){let T=Date.now();(T-I>=qe||S===o-1)&&(I=T,self.postMessage({type:"chunk-progress",workerId:f,completedInChunk:S+1,chunkSize:o,totalIterations:_}))}}return{rawData:g,samplePaths:A}}self.onmessage=function(t){let{type:a}=t.data;try{switch(a){case"start":{let{params:n,iterations:l,volatility:o,mcOptions:_}=t.data;if(!n)throw new Error("Keine Parameter \xFCbergeben");let f=Ke(n,l||1e3,o||15,_||{});self.postMessage({type:"complete",results:f});break}case"run-chunk":{let{params:n,volatility:l,mcOptions:o,startIdx:_,count:f,totalIterations:i,workerId:P,baseSeed:I}=t.data;if(!n)throw new Error("Keine Parameter \xFCbergeben");let{rawData:p,samplePaths:h}=Je(n,l||15,o||{},_,f,i,P,I);self.postMessage({type:"chunk-complete",workerId:P,rawData:p,samplePaths:h});break}default:self.postMessage({type:"error",message:`Unbekannter Nachrichtentyp: ${a}`})}}catch(n){self.postMessage({type:"error",message:n.message||"Unbekannter Fehler bei der Monte-Carlo-Simulation"})}};})();
