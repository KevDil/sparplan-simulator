/**
 * ETF Simulator - Simulation Core (Worker Build)
 * Bundled: 2025-12-08T16:40:30.108Z
 */
// Globale Variablen für Worker-Kompatibilität
var currentRng = Math.random;
var SimulationCore=(()=>{var Ht=Object.defineProperty;var Oe=Object.getOwnPropertyDescriptor;var Le=Object.getOwnPropertyNames;var Ve=Object.prototype.hasOwnProperty;var Ge=(t,e)=>{for(var a in e)Ht(t,a,{get:e[a],enumerable:!0})},Ye=(t,e,a,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of Le(e))!Ve.call(t,o)&&o!==a&&Ht(t,o,{get:()=>e[o],enumerable:!(i=Oe(e,o))||i.enumerable});return t};var Ue=t=>Ye(Ht({},"__esModule",{value:!0}),t);var De={};Ge(De,{INITIAL_ETF_PRICE:()=>Dt,KIRCHENSTEUER_SATZ_8:()=>Mt,KIRCHENSTEUER_SATZ_9:()=>Tt,MONTHS_PER_YEAR:()=>C,SOLI_RATE:()=>Kt,SPARERPAUSCHBETRAG_SINGLE:()=>jt,TAX_RATE_BASE:()=>Et,TEILFREISTELLUNG_MAP:()=>Rt,analyzeHistory:()=>je,calculateTaxRate:()=>he,consolidateLots:()=>_e,coverTaxWithSavingsAndEtf:()=>bt,createSeededRandom:()=>ze,getRng:()=>Be,getStressReturn:()=>pe,percentile:()=>He,randomNormal:()=>ue,sellEtfGross:()=>fe,sellEtfOptimized:()=>It,setRng:()=>ke,simulate:()=>Ke,toMonthlyRate:()=>wt,toMonthlyVolatility:()=>ce});var Et=.25,Kt=.055,Rt={aktien:.7,misch:.85,renten:1},jt=1e3;var Mt=.08,Tt=.09,C=12,Dt=100,re={2025:2.53,2024:2.29,2023:2.55,2022:-.05,2021:-.45,2020:.07,2019:.52,2018:.87};function le(t,e=2.53){return re[t]!==void 0?re[t]:e}var ie={none:{name:"Standard (Zuf\xE4llig)",description:"Normale Monte-Carlo-Simulation mit zuf\xE4lligen Renditen",returns:null},early_crash:{name:"Fr\xFCher Crash",description:"-30% im 1. Rentenjahr, langsame Erholung \xFCber 5 Jahre",returns:[-.3,-.1,.05,.08,.1,.12,.08,.07,.06,.06]},sideways:{name:"Seitw\xE4rtsmarkt",description:"0% Realrendite \xFCber 10 Jahre",returns:[.02,.01,-.01,.02,0,-.02,.03,-.01,.01,0]},bear_market:{name:"B\xE4renmarkt-Phase",description:"3-5 Jahre leicht negative Renditen, danach normal",returns:[-.05,-.08,-.03,-.02,.02,.08,.1,.07,.06,.06]},late_crash:{name:"Sp\xE4ter Crash",description:"Normaler Start, Crash nach 5 Jahren",returns:[.08,.1,.07,.09,.06,-.35,-.15,.1,.12,.08]}};var Pt=Math.random;function ke(t){Pt=t}function Be(){return Pt}function wt(t){return Math.pow(1+t/100,1/C)-1}function ce(t){return t/Math.sqrt(12)}function he(t=0){let e=.25*(1+.055);return t===0?e:t===Mt?.27818:t===Tt?.27995:e+.25*t}function ue(t=0,e=1){let a,i;do a=Pt(),i=Pt();while(a===0);return Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*i)*e+t}function ze(t){let e=t;return function(){e|=0,e=e+1831565813|0;let a=Math.imul(e^e>>>15,1|e);return a=a+Math.imul(a^a>>>7,61|a)^a,((a^a>>>14)>>>0)/4294967296}}function He(t,e){if(t.length===0)return 0;let a=e/100*(t.length-1),i=Math.floor(a),o=Math.ceil(a);return i===o?t[i]:t[i]*(o-a)+t[o]*(a-i)}function _e(t,e=.01){if(t.length<=1)return t;let a=new Map;for(let i of t){if(i.amount<=0)continue;let x=(Math.round(i.price/e)*e).toFixed(4);if(a.has(x)){let p=a.get(x),v=p.amount+i.amount,V=(p.price*p.amount+i.price*i.amount)/v;p.amount=v,p.price=V,p.monthIdx=Math.min(p.monthIdx,i.monthIdx)}else a.set(x,{...i})}return Array.from(a.values()).sort((i,o)=>i.monthIdx-o.monthIdx)}function It(t,e,a,i,o,x,p=0,v=!0,V=.7){let Y=0,f=i,_=p,w=0,b=0;for(;t>.01&&e.length;){let U=v?0:e.length-1,P=e[U],S=a-P.price,A=Math.max(0,o-f),r;if(S>0){let O=S*V,D=Math.min(O>0?_/O:Number.POSITIVE_INFINITY,P.amount),B=Math.min(O>0?A/O:Number.POSITIVE_INFINITY,P.amount-D),E=D+B,J=t/a;if(J<=E)r=J;else{let pt=E*a,$=t-pt,nt=O*x,ct=a-nt;if(ct<=0)break;let dt=$/ct;r=E+dt}}else r=t/a;let h=Math.min(r,P.amount);w+=h*a;let j=h*S*V;b+=j;let k=0;if(j>0){let O=Math.min(j,_);_-=O;let D=j-O,B=Math.max(0,o-f),E=Math.min(D,B);f+=E,k=(D-E)*x}else j<0&&(_+=Math.abs(j));let Q=h*a-k;t-=Q,Y+=k,r>=P.amount?v?e.shift():e.pop():P.amount-=h}return{remaining:t,taxPaid:Y,yearlyUsedFreibetrag:f,lossPot:_,grossProceeds:w,taxableGainTotal:b}}function fe(t,e,a,i,o,x,p=0,v=!0,V=.7){let Y=0,f=i,_=p,w=t,b=0;for(;w>.01&&e.length;){let P=v?0:e.length-1,S=e[P],A=a-S.price,r=w/a,h=Math.min(r,S.amount),K=h*a,k=h*A*V,Q=0;if(k>0){let D=Math.min(k,_);_-=D;let B=k-D,E=Math.max(0,o-f),J=Math.min(B,E);f+=J,Q=(B-J)*x}else k<0&&(_+=Math.abs(k));let O=K-Q;b+=O,Y+=Q,w-=K,r>=S.amount?v?e.shift():e.pop():S.amount-=h}let U=w>.01?w:0;return{netProceeds:b,taxPaid:Y,yearlyUsedFreibetrag:f,lossPot:_,shortfall:U}}function bt(t,e,a,i,o,x,p,v=0,V=!0,Y=.7){if(t<=0)return{savings:e,yearlyUsedFreibetrag:o,lossPot:v,taxPaidOriginal:0,saleTax:0,totalTaxRecorded:0,shortfall:0};let f=t,_=v,w=Math.min(e,f);e-=w,f-=w;let b=0;if(f>.01&&a.length){let A=It(f,a,i,o,x,p,_,V,Y);f=A.remaining,b=A.taxPaid,o=A.yearlyUsedFreibetrag,_=A.lossPot}f=Math.max(0,f);let U=t-f,P=f>.01?f:0,S=U+b;return{savings:e,yearlyUsedFreibetrag:o,lossPot:_,taxPaidOriginal:U,saleTax:b,totalTaxRecorded:S,shortfall:P}}function pe(t,e,a,i){let o=ie[t];if(!o||!o.returns)return null;let x=e-a;if(x<=0)return null;let p=Math.floor((x-1)/12);if(p<o.returns.length){let v=o.returns[p];return Math.pow(1+v,1/12)}return null}function Ke(t,e=0,a={}){let{start_savings:i,start_etf:o,start_etf_cost_basis:x=0,monthly_savings:p,monthly_etf:v,savings_rate_pa:V,etf_rate_pa:Y,etf_ter_pa:f=0,savings_target:_,annual_raise_percent:w,savings_years:b,withdrawal_years:U,monthly_payout_net:P,monthly_payout_percent:S,withdrawal_min:A=0,withdrawal_max:r=0,inflation_adjust_withdrawal:h=!0,special_payout_net_savings:K,special_interval_years_savings:j,inflation_adjust_special_savings:k=!0,special_payout_net_withdrawal:Q,special_interval_years_withdrawal:O,inflation_adjust_special_withdrawal:D=!0,inflation_rate_pa:B=0,sparerpauschbetrag:E=jt,kirchensteuer:J="keine",basiszins:pt=2.53,use_lifo:$=!1,rent_is_gross:nt=!1,capital_preservation_enabled:ct=!1,capital_preservation_threshold:dt=80,capital_preservation_reduction:de=25,capital_preservation_recovery:me=10,loss_pot:ge=0,fondstyp:xe="aktien"}=t,{stressScenario:At="none",startYear:ve=new Date().getFullYear()}=a,Wt=e>0,ye=At&&At!=="none",Ft=Wt?ce(e/100):0,st=Rt[xe]||Rt.aktien,Nt=0;J==="8"?Nt=Mt:J==="9"&&(Nt=Tt);let Z=he(Nt),tt=[],l=i,d=Dt,R=[];if(o>0){let y=o/d,W=(x>0?x:o)/y;R.push({amount:y,price:W,monthIdx:0})}let Se=Y-f,Jt=wt(V),Ct=wt(Se),Ee=wt(B),Re=w/100,Me=(b+U)*C,Zt=b*C,Ot=l>=_,I=0,Xt=0,qt=!1,ot=P,Lt=S,et=null,mt=null,rt=1,Vt=!1,Qt=0,Te=o,Gt=d,$t=0,m=ge,ht=0,we=0,at=0;for(let y=1;y<=Me;y+=1){let X=y<=Zt,W=Math.floor((y-1)/C),ut=(y-1)%C+1,Yt=0,gt=0,z=0;rt*=1+Ee;let lt=R.reduce((u,g)=>u+g.amount,0)*d,M=l+lt;if(W!==Xt){if(I=0,$t=0,at>0){let u=Math.min(at,m);m-=u;let g=at-u,L=Math.min(g,E);I=L;let c=Math.max(0,g-L)*Z,s=bt(c,l,R,d,I,E,Z,m,!$,st);l=s.savings,I=s.yearlyUsedFreibetrag,m=s.lossPot,Yt=s.taxPaidOriginal,$t=s.taxPaidOriginal,gt+=s.totalTaxRecorded,z+=s.shortfall}Xt=W,Te=lt,Gt=d,ht=0,we=0,at=0}let G,xt=ye?pe(At,y,Zt,Ct):null;if(xt!==null)G=xt,d*=G;else if(Wt){let g=Math.log(1+Ct)-.5*Ft*Ft,N=ue(0,1);G=Math.exp(g+Ft*N),d*=G}else G=1+Ct,d*=G;let Pe=lt*(G-1),vt=l*Jt,Ut=0;ht+=vt,l+=vt;let te=0,it=0,ee=0,F=0,_t=gt,q=0,ft=0,yt=0,ae=!1,St=0;if(X){let u=Math.pow(1+Re,W),g=p*u,N=v*u;if(Ot?it=N+g:(l+=g,te=g,it=N),l>_&&(ee=l-_,l=_,it+=ee,Ot=!0),it>0){let n=it/d;R.push({amount:n,price:d,monthIdx:y})}if(j>0&&y%(j*C)===0&&y>0){let n=K;if(k){let H=y/C;n=K*Math.pow(1+B/100,H)}let c=n;F=c;let s=Math.max(0,l-_);if(s>0){let H=Math.min(s,c);l-=H,c-=H}let T=It(c,R,d,I,E,Z,m,!$,st);if(c=T.remaining,_t+=T.taxPaid,I=T.yearlyUsedFreibetrag,m=T.lossPot,c>.01){let H=Math.min(l,c);l-=H,c-=H,l<_&&(Ot=!1)}c<0&&(l+=Math.abs(c),c=0),q=F-Math.max(0,c)}}else{if(et===null){let n=R.reduce((c,s)=>c+s.amount,0);et=l+n*d,S!=null&&!qt?(ot=et*(S/100)/12,mt=ot,qt=!0,Lt=S):ot!=null&&(mt=ot,Lt=et>0?ot*12/et*100:0)}let u=ot||0;if(h&&mt!=null){let n=W-b;u=mt*Math.pow(1+B/100,n)}if(A>0&&u<A&&(u=A),r>0&&u>r&&(u=r),ct&&et>0){let n=R.reduce((H,Bt)=>H+Bt.amount,0),c=l+n*d,s=et*(dt/100),T=et*((dt+me)/100);c<s?Vt=!0:c>=T&&(Vt=!1),Vt&&(u=u*(1-de/100),ae=!0,Qt++)}let g=u,N=0,L=u;if(O>0&&y%(O*C)===0){if(N=Q,D){let n=y/C;N=Q*Math.pow(1+B/100,n)}L+=N}if(L>0){let n=L;F=L;let c=Math.max(0,l-_);if(c>0){let s=Math.min(c,n);l-=s,n-=s,nt&&(St+=s)}if(nt&&n>0){let s=fe(n,R,d,I,E,Z,m,!$,st),T=s.netProceeds;_t+=s.taxPaid,I=s.yearlyUsedFreibetrag,m=s.lossPot,n=s.shortfall,q=F-n,St+=T}else if(n>0){let s=It(n,R,d,I,E,Z,m,!$,st);n=s.remaining,_t+=s.taxPaid,I=s.yearlyUsedFreibetrag,m=s.lossPot}if(n>.01){let s=Math.min(l,n);l-=s,n-=s,nt&&(St+=s)}n<0&&(l+=Math.abs(n),n=0),nt||(q=F-Math.max(0,n))}if(F>0&&q<F){let n=q/F;yt=g*n}else yt=g}let kt=0;if(ut===12){if(ht>0){let N=Math.min(ht,m);m-=N;let L=ht-N,n=Math.max(0,E-I),c=Math.min(L,n);if(I+=c,Ut=Math.max(0,L-c)*Z,Ut>.01){let T=bt(Ut,l,R,d,I,E,Z,m,!$,st);l=T.savings,I=T.yearlyUsedFreibetrag,m=T.lossPot,_t+=T.totalTaxRecorded,z+=T.shortfall}}let u=ve+W,g=le(u,pt);if(g>0){let N=W*C,L=.7;for(let n of R){if(n.amount<=0)continue;let c=n.monthIdx>N,s=c?n.amount*n.price:n.amount*Gt,T=1;c&&(T=(12-((n.monthIdx-1)%C+1)+1)/12);let H=s*(g/100)*L*T,Bt=n.amount*d,Ne=c?n.amount*n.price:n.amount*Gt,Ce=Math.max(0,Bt-Ne),zt=Math.min(H,Ce);zt>0&&(kt+=zt,n.price+=zt/n.amount)}kt>0&&(at=kt*st)}}if(ut===12&&R.length>50){let u=_e(R);R.length=0,R.push(...u)}let ne=R.reduce((u,g)=>u+g.amount,0)*d,se=l+ne,Ie=X?null:F>0?F:null,Ae=F>0?Math.max(0,F-q):0;!X&&F>0?nt?ft=St:ft=q:ft=0;let Fe=1+Jt,oe=G;if(M>0){let u=lt/M,g=1-u;oe=u*G+g*Fe}tt.push({month:y,year:W+1,phase:X?"Anspar":"Entnahme",savings:l,etf:ne,total:se,total_real:se/rt,savings_contrib:te,etf_contrib:it,savings_interest:vt,withdrawal:q,withdrawal_real:q/rt,withdrawal_net:ft,withdrawal_net_real:ft/rt,withdrawal_requested:F,shortfall:Ae,tax_shortfall:z,monthly_payout:yt,monthly_payout_real:yt/rt,tax_paid:_t,vorabpauschale_tax:Yt,payout_value:Ie,payout_percent_pa:X?null:Lt,return_gain:Pe+vt,etfReturn:G,portfolioReturn:oe,cumulative_inflation:rt,capital_preservation_active:ae||!1,yearly_used_freibetrag:I,loss_pot:m})}if(at>0&&tt.length>0){let y=Math.min(at,m);m-=y;let X=at-y,ut=Math.min(X,E),gt=Math.max(0,X-ut)*Z,z=bt(gt,l,R,d,ut,E,Z,m,!$,st);l=z.savings,m=z.lossPot;let lt=R.reduce((G,xt)=>G+xt.amount,0)*d,M=tt[tt.length-1];M.savings=l,M.etf=lt,M.total=M.savings+M.etf,M.total_real=M.total/M.cumulative_inflation,M.tax_paid+=z.totalTaxRecorded,M.vorabpauschale_tax=(M.vorabpauschale_tax||0)+z.taxPaidOriginal,M.pending_vorabpauschale_tax=z.taxPaidOriginal,M.loss_pot=m,z.shortfall>.01&&(M.tax_shortfall=(M.tax_shortfall||0)+z.shortfall),l<0&&(l=0)}return tt.length>0&&(tt.capitalPreservationMonths=Qt,tt.capitalPreservationEnabled=ct),tt}function je(t,e){if(!t||t.length===0)return null;let a=t[t.length-1],i=e.savings_years*C,o=Math.min(i-1,t.length-1),x=t[o],p=t.filter(r=>r.phase==="Anspar"),v=t.filter(r=>r.phase==="Entnahme"),V=(e.start_savings||0)+(e.start_etf||0)+p.reduce((r,h)=>r+(h.savings_contrib||0)+(h.etf_contrib||0),0),Y=t.reduce((r,h)=>r+(h.return_gain||0),0),f=t.reduce((r,h)=>r+(h.tax_paid||0),0),_=t.reduce((r,h)=>r+(h.vorabpauschale_tax||0),0),w=0,b=0,U=0,P=0;if(v.length>0){let r=v.filter(h=>h.monthly_payout>0).map(h=>h.monthly_payout);r.length>0&&(w=r.reduce((h,K)=>h+K,0)/r.length,b=Math.min(...r),U=Math.max(...r)),P=v.reduce((h,K)=>h+(K.withdrawal||0),0)}let S=t.filter(r=>r.shortfall>0),A=S.length>0;return{endTotal:a.total,endTotalReal:a.total_real,retirementTotal:x?.total||0,retirementTotalReal:x?.total_real||0,totalInvested:V,totalReturn:Y,totalTax:f,totalVorabpauschale:_,avgWithdrawal:w,minWithdrawal:b,maxWithdrawal:U,totalWithdrawals:P,hasShortfall:A,shortfallMonths:S.length,capitalPreservationMonths:t.capitalPreservationMonths||0,finalLossPot:a.loss_pot||0,cumulativeInflation:a.cumulative_inflation||1}}return Ue(De);})();

// Worker-Globals exportieren
if (typeof self !== 'undefined') {
  Object.assign(self, SimulationCore);
}
